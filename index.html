<!-- START OF FILE ai_studio_os_v12_strawberry_final_optimized.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çµçŠ€ OS (V12 è‰è“ç”œå¿ƒç‰ˆ)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            /* é»˜è®¤å˜é‡ */
            --wallpaper: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=800&auto=format&fit=crop');
            --text-color: #fff; --text-sub: #aaa; --text-shadow: 0 2px 5px rgba(0,0,0,0.5);
            --app-bg: #111; --card-bg: #222; --input-bg: #333; --input-border: #444;
            --border-color: rgba(255,255,255,0.1); --accent-color: #0af; --icon-bg: rgba(255, 255, 255, 0.2);
            --icon-border: 1px solid rgba(255, 255, 255, 0.3);
            --icon-radius: 18px;
            --icon-size: 30px;
            --icon-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* === ä¸»é¢˜å®šä¹‰ === */
        /* æ·±è‰²ç³» */
        body.theme-default { --wallpaper: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=800&auto=format&fit=crop'); }
        body.theme-nebula { --wallpaper: url('https://images.unsplash.com/photo-1538370965246-fe4c0b457e56?q=80&w=800&auto=format&fit=crop'); --app-bg: #1e1b2e; --card-bg: #2e2a44; --input-bg: #403a61; --accent-color: #bf55ec; }
        body.theme-forest { --wallpaper: url('https://images.unsplash.com/photo-1448375240586-882707db888b?q=80&w=800&auto=format&fit=crop'); --app-bg: #172f23; --card-bg: #214232; --input-bg: #2f5d42; --accent-color: #2ed573; }
        
        /* æµ…è‰²ç³» */
        body.theme-cream-pink { --wallpaper: linear-gradient(135deg, #fff0f5 0%, #ffd1dc 100%); --text-color: #5d4037; --text-sub: #8d6e63; --text-shadow: none; --app-bg: #fff0f5; --card-bg: #ffffff; --input-bg: #ffffff; --input-border: #ffcce0; --border-color: rgba(0,0,0,0.05); --accent-color: #ff80ab; --icon-bg: rgba(255, 128, 171, 0.4); }
        body.theme-cream-blue { --wallpaper: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); --text-color: #37474f; --text-sub: #78909c; --text-shadow: none; --app-bg: #e1f5fe; --card-bg: #ffffff; --input-bg: #ffffff; --input-border: #b3e5fc; --border-color: rgba(0,0,0,0.05); --accent-color: #29b6f6; --icon-bg: rgba(41, 182, 246, 0.3); }
        body.theme-cream-yellow { --wallpaper: linear-gradient(135deg, #fffde7 0%, #fff59d 100%); --text-color: #5d4037; --text-sub: #8d6e63; --text-shadow: none; --app-bg: #fff9c4; --card-bg: #ffffff; --input-bg: #ffffff; --input-border: #fff176; --border-color: rgba(0,0,0,0.05); --accent-color: #fbc02d; --icon-bg: rgba(251, 192, 45, 0.3); }
        body.theme-taro { --wallpaper: linear-gradient(135deg, #f3e7e9 0%, #e3eeff 99%, #e3eeff 100%); --text-color: #4a4a4a; --text-sub: #888; --text-shadow: none; --app-bg: #f4eeff; --card-bg: #fff; --input-bg: #fff; --input-border: #dcd6f7; --border-color: rgba(0,0,0,0.05); --accent-color: #a29bfe; --icon-bg: rgba(162, 155, 254, 0.4); }
        body.theme-matcha { --wallpaper: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%); --text-color: #2d3436; --text-sub: #636e72; --text-shadow: none; --app-bg: #f0fff4; --card-bg: #fff; --input-bg: #fff; --input-border: #b8e994; --border-color: rgba(0,0,0,0.05); --accent-color: #78e08f; --icon-bg: rgba(120, 224, 143, 0.4); }
        body.theme-peach { --wallpaper: linear-gradient(120deg, #f6d365 0%, #fda085 100%); --text-color: #4a4a4a; --text-sub: #888; --text-shadow: none; --app-bg: #fff5ee; --card-bg: #fff; --input-bg: #fff; --input-border: #ffccbc; --border-color: rgba(0,0,0,0.05); --accent-color: #ff9f43; --icon-bg: rgba(255, 159, 67, 0.4); }

        /* ğŸ“ è‰è“ç”œå¿ƒé™å®šç‰ˆ Theme ğŸ“ */
        body.theme-strawberry { 
            --wallpaper: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); 
            --text-color: #5d4037; --text-sub: #bcaaa4; --text-shadow: none; 
            --app-bg: #fff0f5; --card-bg: #ffffff; 
            --input-bg: #fff; --input-border: #ffcdd2; 
            --border-color: #ffcdd2; 
            --accent-color: #ff5252; --icon-bg: rgba(255, 82, 82, 0.3); 
        }
        body.theme-strawberry .app-nav { border-bottom: 2px dashed var(--accent-color); }
        body.theme-strawberry .nav-btn i { display: none; }
        body.theme-strawberry .nav-btn:first-child::before { content: 'ğŸ“'; font-size: 20px; margin-right:5px; } 
        body.theme-strawberry .app-title::after { content: ' ğŸ°'; font-size: 14px; }
        body.theme-strawberry .card { border: 1px solid #ffebee; position: relative; overflow: hidden; }
        body.theme-strawberry .card::before { content: 'âœ¨'; position: absolute; top: 5px; right: 5px; font-size: 10px; opacity: 0.5; color: var(--accent-color); pointer-events: none; }
        body.theme-strawberry .yijing-menu-btn { border: 2px dashed #ffcdd2; }
        body.theme-strawberry .daily-card { border: 2px dashed #ffcdd2; background: rgba(255,255,255,0.6); }

        /* === å›¾æ ‡æ ·å¼å®šä¹‰ === */
        body.style-glass .frosted-icon { backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); }
        body.style-outline .frosted-icon { background: transparent !important; border: 2px solid var(--accent-color); color: var(--accent-color); box-shadow: none; backdrop-filter: none; }
        body.style-outline .frosted-icon i { text-shadow: none; }
        body.style-flat .frosted-icon { background: var(--card-bg); border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.1); backdrop-filter: none; }
        body.style-flat .frosted-icon i { color: var(--accent-color); }
        body.style-emoji .frosted-icon { background: transparent; border: none; box-shadow: none; backdrop-filter: none; font-size: 52px; animation: bounce 2s infinite ease-in-out; }
        body.style-emoji .frosted-icon i { display: none; } 
        body.style-emoji .frosted-icon::after { content: attr(data-emoji); }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        /* æ–°å¢å›¾æ ‡æ ·å¼ */
        body.style-white .frosted-icon { background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.5); color: #fff; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); text-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        body.style-black .frosted-icon { background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(255, 255, 255, 0.1); color: #fff; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        body.style-water .frosted-icon { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: inset 0 0 15px rgba(255, 255, 255, 0.6), inset 2px 2px 5px rgba(255,255,255,0.8), 5px 5px 15px rgba(0,0,0,0.1); backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px); border-radius: 22px; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        /* æµ…è‰²ä¸»é¢˜ä¸‹çš„æ°´æ»´æ ·å¼é€‚é… */
        /* æ–°å¢å›¾æ ‡æ ·å¼: ç£¨ç ‚é»‘ */
        body.style-matte-black .frosted-icon { 
            background: rgba(0, 0, 0, 0.6); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            color: rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
            text-shadow: none;
        }
        /* æ–°å¢å›¾æ ‡æ ·å¼: ç£¨ç ‚ç™½ */
        body.style-matte-white .frosted-icon { 
            background: rgba(255, 255, 255, 0.6); 
            border: 1px solid rgba(255, 255, 255, 0.4); 
            color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            text-shadow: none;
        }
        body[class*="theme-cream"].style-matte-white .frosted-icon, body.theme-strawberry.style-matte-white .frosted-icon {
            color: rgba(0, 0, 0, 0.7);
        }
        body[class*="theme-cream"].style-water .frosted-icon, body[class*="theme-strawberry"].style-water .frosted-icon, body[class*="theme-taro"].style-water .frosted-icon { color: #fff; background: rgba(255, 255, 255, 0.25); text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        
                * { box-sizing: border-box; user-select: none; -webkit-user-select: none; -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent; }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; position: fixed; top: 0; left: 0; }
        body { background: #000; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; justify-content: center; align-items: center; }

        #phone-frame { width: 100%; height: 100%; background: var(--wallpaper) center/cover no-repeat; position: relative; overflow: hidden; display: flex; flex-direction: column; transition: background 0.3s ease; }
        @media (max-width: 450px) { body { background: #000; } #phone-frame { border-radius: 0; border: none; } .notch { display: none !important; } .status-bar { padding-top: constant(safe-area-inset-top); padding-top: env(safe-area-inset-top); } }
        @media (min-width: 450px) { #phone-frame { max-width: 420px; max-height: 900px; border-radius: 44px; border: 12px solid #1a1a1a; box-shadow: 0 0 50px rgba(0,0,0,0.7); height: 88vh; } .notch { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 130px; height: 30px; background: #000; border-radius: 0 0 16px 16px; z-index: 20; } }

        .status-bar { height: 44px; padding: 0 24px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: var(--text-color); font-weight: 600; z-index: 10; text-shadow: var(--text-shadow); position: absolute; top:0; left:0; right:0; }
        #desktop { flex: 1; padding: 20px; padding-top: 64px; display: flex; flex-direction: column; }
        .clock-widget { padding: 20px 0 10px 10px; color: var(--text-color); text-shadow: var(--text-shadow); }
        .clock-time { font-size: 72px; font-weight: 200; line-height: 1; }
        .clock-date { font-size: 18px; margin-top: 5px; opacity: 0.8; }

        /* === æ¯æ—¥ä¸€ç­¾ç»„ä»¶æ ·å¼ === */
        /* æ¯æ—¥ä¸€å­¦æŠ˜å æ ·å¼ */
        .daily-header-collapsible {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            cursor: pointer;
            padding: 5px 0; /* æ ¹æ®éœ€è¦è°ƒæ•´é—´è· */
            margin-bottom: 5px; /* å¤´éƒ¨ä¸‹æ–¹ç•™ä¸€ç‚¹ç©ºé—´ */
            color: var(--text-color); /* ç¡®ä¿æ–‡å­—é¢œè‰²éšä¸»é¢˜å˜åŒ– */
            text-shadow: var(--text-shadow); /* ç¡®ä¿æ–‡å­—é˜´å½±éšä¸»é¢˜å˜åŒ– */
        }
        /* æµ…è‰²æ¨¡å¼ä¸‹ï¼Œæ¯æ—¥ä¸€å­¦æŠ˜å å¤´éƒ¨æ–‡å­—é€‚é… */
        body[class*="theme-cream"] .daily-header-collapsible, body.theme-strawberry .daily-header-collapsible, body.theme-taro .daily-header-collapsible, body.theme-matcha .daily-header-collapsible, body.theme-peach .daily-header-collapsible {
            color: var(--text-color); /* ä½¿ç”¨ä¸»é¢˜çš„æ–‡æœ¬é¢œè‰² */
            text-shadow: none; /* æµ…è‰²æ¨¡å¼é€šå¸¸ä¸éœ€è¦æ–‡å­—é˜´å½± */
        }

        .daily-header-collapsible .daily-title {
            margin-bottom: 0; /* è¦†ç›–åŸæœ‰ä¸‹è¾¹è· */
        }
        .daily-header-collapsible i {
            transition: transform 0.2s ease-in-out;
            font-size: 16px; /* ç®­å¤´å›¾æ ‡å¤§å° */
            opacity: 0.8;
        }
        .daily-header-collapsible i.rotated {
            transform: rotate(-90deg); /* æŠ˜å æ—¶å›¾æ ‡æ—‹è½¬ */
        }

        .daily-content-details {
            max-height: 500px; /* è¿‡æ¸¡åŠ¨ç”»çš„æœ€å¤§é«˜åº¦ */
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 1;
            padding-top: 5px; /* è®©å†…å®¹ä¸å¤´éƒ¨æœ‰ç‚¹è·ç¦» */
            width: 100%; /* ç¡®ä¿å†…å®¹åŒºå®½åº¦æ­£ç¡® */
            display: flex; /* è®©å†…éƒ¨å…ƒç´ å‚ç›´æ’åˆ— */
            flex-direction: column;
            align-items: center;
        }
        .daily-content-details.collapsed {
            max-height: 0;
            opacity: 0;
            margin-top: -15px; /* æŠ˜å æ—¶å‘ä¸Šæ”¶ç¼©ï¼Œå‡å°‘ç©ºç™½ */
            padding-top: 0;
        }
        /* ç¡®ä¿gua-tipåœ¨æŠ˜å åæ²¡æœ‰å¯è§ */
        .daily-content-details.collapsed .daily-tip {
            display: none;
        }
        .daily-card { 
            margin: 10px 10px 20px 10px; 
            background: rgba(255,255,255,0.15); 
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2); 
            border-radius: 20px; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            text-align: center; 
            color: var(--text-color); 
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .daily-card:active { transform: scale(0.98); }
        .daily-title { font-size: 14px; font-weight: bold; opacity: 0.8; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .daily-content-box { display: none; flex-direction: column; align-items: center; width: 100%; animation: fade-in 0.5s forwards; }
        .daily-symbol { font-size: 32px; font-family: "Segoe UI Symbol", sans-serif; line-height: 1; margin: 5px 0; }
        .daily-gua-name { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .daily-tip { font-size: 13px; opacity: 0.9; background: rgba(0,0,0,0.1); padding: 8px 12px; border-radius: 10px; margin-top: 5px; line-height: 1.5; width: 100%; text-align: left; }
        /* æµ…è‰²æ¨¡å¼é€‚é… */
        body[class*="theme-cream"] .daily-tip, body[class*="theme-strawberry"] .daily-tip { background: rgba(255,255,255,0.5); color: #5d4037; }
        
        .daily-btn { 
            background: var(--accent-color); color: #fff; border: none; padding: 10px 20px; 
            border-radius: 25px; font-size: 14px; font-weight: bold; cursor: pointer; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); margin-top: 5px; display: flex; align-items: center; gap: 6px;
        }
        .daily-done { color: var(--accent-color); font-weight: bold; font-size: 14px; display: flex; align-items: center; gap: 5px; margin-top: 10px; }

        .app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px 12px; }
        .icon-wrap { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: transform 0.1s; }
        .icon-wrap:active { transform: scale(0.95); }
        .frosted-icon { width: 68px; height: 68px; border-radius: var(--icon-radius); background: var(--icon-bg); border: var(--icon-border); box-shadow: var(--icon-shadow); display: flex; justify-content: center; align-items: center; font-size: var(--icon-size); color: #fff; margin-bottom: 8px; transition: all 0.3s; }
        body[class*="theme-cream"] .frosted-icon { color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2); } 
        .icon-name { font-size: 12px; color: var(--text-color); text-shadow: var(--text-shadow); font-weight: 500; }
        .dock { margin-top: auto; padding: 16px; background: rgba(255,255,255,0.1); border-radius: 30px; margin-bottom: 10px; backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); }
        
        .app-window { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--app-bg); z-index: 100; display: flex; flex-direction: column; transform: translateY(105%); opacity: 0; transition: transform 0.35s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.35s; pointer-events: none; color: var(--text-color); }
        .app-window.active { transform: translateY(0); opacity: 1; pointer-events: auto; }
        
        .app-nav { height: 50px; margin-top: 40px; display: flex; align-items: center; padding: 0 16px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .app-title { flex: 1; text-align: center; font-size: 17px; font-weight: 600; color: var(--text-color); display: flex; flex-direction: column; justify-content: center; line-height: 1.2; }
        .app-subtitle { font-size: 11px; font-weight: normal; opacity: 0.7; }
        .nav-btn { color: var(--accent-color); font-size: 16px; width: 60px; cursor: pointer; display: flex; align-items: center; }

        .app-content { flex: 1; overflow-y: auto; padding: 16px; color: var(--text-color); -webkit-overflow-scrolling: touch; touch-action: pan-y; overscroll-behavior: contain; padding-bottom: 80px; }
        #app-chat .app-content, #app-yijing-chat .app-content { padding-bottom: 0 !important; overflow: hidden !important; }
        
        .card { background: var(--card-bg); border-radius: 14px; padding: 16px; margin-bottom: 16px; border: 1px solid var(--border-color); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .yijing-menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .yijing-menu-btn { background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 16px; padding: 20px 10px; text-align: center; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; height: 120px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .yijing-menu-btn:active { transform: scale(0.96); border-color: var(--accent-color); }
        .yijing-menu-btn i { font-size: 32px; color: var(--accent-color); margin-bottom: 5px; }
        .yijing-menu-btn span { font-size: 14px; font-weight: 600; color: var(--text-color); }

        input, textarea, select { width: 100%; background: var(--input-bg); border: 1px solid var(--input-border); padding: 12px; color: var(--text-color); border-radius: 10px; font-size: 16px; margin-bottom: 12px; font-family: inherit; resize: none; outline: none; transition: border 0.2s; }
        input:focus, textarea:focus { border-color: var(--accent-color); }
        
        button { width: 100%; padding: 14px; background: var(--accent-color); border: none; border-radius: 12px; color: #fff; font-size: 16px; font-weight: 600; cursor: pointer; display:flex; justify-content:center; align-items:center; gap:8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        button:disabled { background: #888; cursor: not-allowed; opacity: 0.7; }
        button.secondary { background: rgba(128,128,128,0.3); color: var(--text-color); box-shadow: none; }
        button.outline { background: transparent; border: 1px solid var(--accent-color); color: var(--accent-color); box-shadow: none; }
        button.danger { background: #ff3b30; color: #fff; border:none; box-shadow: 0 4px 10px rgba(255, 59, 48, 0.3); }
        
        .theme-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 10px 0; }
        .theme-button { width: 100%; padding-bottom: 100%; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); cursor: pointer; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.2); background-size: cover; background-position: center; }
        .theme-button.active { box-shadow: 0 0 0 3px var(--accent-color); border-color: #fff; }
        .theme-emoji { position: absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-size: 24px; }
                .icon-style-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .icon-style-btn { padding: 15px 5px; border-radius: 10px; background: var(--card-bg); border: 1px solid var(--border-color); text-align: center; cursor: pointer; font-size: 12px; }
        .icon-style-btn.active { border-color: var(--accent-color); background: rgba(128,128,128,0.1); color: var(--accent-color); font-weight: bold; }

        /* Gua Styles */
        .gua-visual-row { display: flex; justify-content: space-between; margin: 10px 0 20px 0; text-align: center; }
        .gua-col { width: 32%; background: rgba(128,128,128,0.1); border-radius: 8px; padding: 10px 5px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .gua-col:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .gua-lines-box { display: flex; flex-direction: column; gap: 6px; margin: 10px auto; width: 60px; }
        .line { width: 100%; height: 8px; border-radius: 2px; }
        .line.yang { background-color: var(--text-color); } 
        .line.yin { background: transparent; display: flex; justify-content: space-between; }
        .line.yin span { display: block; width: 42%; height: 100%; background-color: var(--text-color); border-radius: 2px; }
        .line.moving.yang, .line.moving.yin span { background-color: #ff3b30; }
        .gua-title { font-size: 12px; font-weight: bold; color: var(--text-sub); text-transform: uppercase; }
        .gua-name { font-size: 16px; font-weight: bold; margin-top: 5px; color: var(--accent-color); }
        .line.moving { cursor: pointer; transition: opacity 0.2s; }
        .line.moving:hover { opacity: 0.8; }
        
        .ai-collapsible .content { display: none; margin-top:10px; border-top:1px solid var(--border-color); padding-top:10px; line-height: 1.6; }
        .ai-collapsible .content.expanded { display: block; }
        .ai-collapsible .toggle-btn { font-size: 14px; text-align:left; padding: 8px; background: rgba(128,128,128,0.1); border-radius: 8px; color: var(--accent-color); box-shadow: none; width: 100%; display: flex; justify-content: space-between; align-items: center; }
        
        /* Chat Styles */
        .chat-feed { flex:1; overflow-y:auto; padding-bottom:10px; -webkit-overflow-scrolling: touch; }
        .chat-bubble { max-width: 80%; padding: 10px 15px; border-radius: 18px; line-height: 1.6; margin-bottom: 10px; font-size: 15px; word-break: break-word; position: relative; opacity: 0; animation: fade-in 0.3s forwards; }
        @keyframes fade-in { to { opacity: 1; } }
        .chat-bubble.user { background: var(--accent-color); color: #fff; margin-left: auto; border-bottom-right-radius: 4px; }
        .chat-bubble.ai { background: var(--card-bg); color: var(--text-color); margin-right: auto; border-bottom-left-radius: 4px; border: 1px solid var(--border-color); }
        .chat-bubble.thinking { padding: 12px 18px; color: var(--text-sub); font-style: italic; }
        .chat-input-area { display: flex; gap: 10px; padding-top:10px; border-top:1px solid var(--border-color); padding-bottom: 20px; }
        .chat-actions { display: flex; gap: 10px; margin-top: 5px; justify-content: flex-end; opacity: 0.6; }
        .chat-action-btn { font-size: 12px; cursor: pointer; padding: 2px 5px; color: var(--text-sub); display: flex; align-items: center; gap: 4px; }
        .chat-action-btn:hover { color: var(--accent-color); opacity: 1; }
        
        .session-trigger { flex:1; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 10px; padding: 0 12px; display: flex; align-items: center; height: 42px; cursor: pointer; font-size: 14px; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; justify-content: space-between; }
        .session-trigger i { font-size: 12px; opacity: 0.5; }

        /* Custom Modals */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 20px; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-box { width: 100%; max-width: 320px; background: var(--card-bg); border-radius: 16px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 1px solid var(--border-color); transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; flex-direction: column; max-height: 70vh; }
        .modal-overlay.show .modal-box { transform: scale(1); }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; flex-shrink: 0; }
        .modal-list { overflow-y: auto; display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .modal-list-item { padding: 12px; background: rgba(128,128,128,0.1); border-radius: 10px; cursor: pointer; border: 1px solid transparent; text-align: left; }
        .modal-list-item:hover, .modal-list-item.active { border-color: var(--accent-color); background: rgba(128,128,128,0.2); }
        .modal-list-item div { font-weight: bold; font-size: 14px; margin-bottom: 2px; }
        .modal-list-item small { color: var(--text-sub); font-size: 11px; }
        
        /* Diary App Modifications */
        .diary-date-header { padding: 10px; background: var(--icon-bg); margin-bottom: 10px; border-radius: 8px; font-size: 14px; font-weight: bold; color: var(--text-color); cursor: pointer; display: flex; justify-content: space-between; align-items: center; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
        .diary-group { display: block; }
        .diary-group.collapsed { display: none; }
        .diary-entry-actions { margin-top: 10px; display: flex; justify-content: flex-end; }
        .diary-reply-btn { background-color: transparent; border: 1px solid var(--accent-color); color: var(--accent-color); padding: 5px 10px; font-size: 12px; width: auto; box-shadow: none; }
        
        .check-wrap { display: flex; align-items: center; gap: 10px; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        .check-wrap input[type="checkbox"] { width: 20px; height: 20px; margin: 0; }
        .check-content { flex: 1; }
        .batch-toolbar { position: absolute; bottom: 20px; left: 20px; right: 20px; display: flex; gap: 10px; z-index: 200; }
        
                h4 { margin: 10px 0; color: var(--text-color); }
        small { color: var(--text-sub); }
    </style>
</head>
<body class="theme-default style-glass">

<!-- Custom Prompt Modal -->
<div id="custom-prompt-overlay" class="modal-overlay">
    <div class="modal-box">
        <h4 id="custom-prompt-title">è¾“å…¥ä¿¡æ¯</h4>
        <input type="text" id="custom-prompt-input" style="margin-top:10px;">
        <div class="modal-btns">
            <button class="secondary" onclick="closeCustomPrompt()">å–æ¶ˆ</button>
            <button onclick="confirmCustomPrompt()">ç¡®å®š</button>
        </div>
    </div>
</div>

<!-- Session List Modal -->
<div id="session-list-overlay" class="modal-overlay">
    <div class="modal-box">
        <h4>åˆ‡æ¢ä¼šè¯</h4>
        <div id="session-list" class="modal-list"></div>
        <div class="modal-btns">
            <button class="secondary" onclick="document.getElementById('session-list-overlay').classList.remove('show')">å…³é—­</button>
        </div>
    </div>
</div>

<!-- Yao Detail Modal -->
<div id="yao-detail-overlay" class="modal-overlay">
    <div class="modal-box">
        <h4 id="yao-detail-title">çˆ»è¾è¯¦æƒ…</h4>
        <div id="yao-detail-subtitle" style="color:var(--accent-color); font-weight:bold; margin-bottom:10px;"></div>
        <div id="yao-detail-content" class="modal-list" style="min-height: 120px; padding:15px; background:rgba(128,128,128,0.05); line-height:1.8; font-size:15px;"></div>
        <div class="modal-btns">
            <button class="secondary" onclick="closeYaoDetail()">å…³é—­</button>
            <button id="btn-fetch-yao" onclick="fetchYaoText()">ğŸ“œ AI è§£ææ­¤çˆ»</button>
        </div>
    </div>
</div>

<!-- Yijing Character Selection Modal -->
<div id="yijing-char-select-overlay" class="modal-overlay">
    <div class="modal-box">
        <h4>é€‰æ‹©ä¸€ä½å­¦ä¼´</h4>
        <p style="font-size:12px; color:var(--text-sub); margin:-10px 0 10px;">é€‰æ‹©ä¸€ä¸ªè§’è‰²æ¥ä¸ä½ ä¸€åŒæ¢è®¨å¦è±¡ã€‚</p>
        <div id="yijing-char-list" class="modal-list"></div>
        <div class="modal-btns">
            <button class="secondary" onclick="document.getElementById('yijing-char-select-overlay').classList.remove('show')">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div id="phone-frame">
    <div class="notch"></div>
    <div class="status-bar"><span id="clock-small"></span><span id="battery-status"></span></div>
    <div id="desktop">
    <div class="clock-widget"><div class="clock-time" id="clock-big"></div><div class="clock-date" id="clock-date"></div></div>
    
    <!-- æ¯æ—¥ä¸€ç­¾ç»„ä»¶ -->
    <div id="daily-widget" class="daily-card">
        <div id="daily-loading" style="display:none;">å‡†å¤‡ç­¾æ–‡ä¸­...</div>
        <div id="daily-empty">
            <div class="daily-title">ä»Šæ—¥è¿åŠ¿</div>
            <button class="daily-btn" onclick="doDailyCheckIn()"><i class="fas fa-calendar-check"></i> ç­¾åˆ° & æŠ½å–ä»Šæ—¥ä¸€å¦</button>
        </div>
        <div id="daily-content" class="daily-content-box">
            <div class="daily-header-collapsible" onclick="toggleDailyContentCollapse()">
                <div class="daily-title">æ¯æ—¥ä¸€å­¦</div>
                <i id="daily-collapse-icon" class="fas fa-chevron-down"></i>
            </div>
            <div id="daily-collapsible-area" class="daily-content-details">
                <div class="daily-symbol" id="daily-symbol-text"></div>
                <div class="daily-gua-name" id="daily-gua-name"></div>
                <div class="daily-tip" id="daily-gua-tip"></div>
                <div class="daily-done"><i class="fas fa-check-circle"></i> ä»Šæ—¥å·²æ‰“å¡</div>
            </div> <!-- End of daily-collapsible-area -->
        </div>
    </div>

    <div class="app-grid">
        <div class="icon-wrap" onclick="openApp('app-chars')">
            <div class="frosted-icon" data-emoji="ğŸ‘¥"><i class="fas fa-users"></i></div>
            <div class="icon-name">è§’è‰²</div>
        </div>
        <div class="icon-wrap" onclick="openApp('app-yijing')">
            <div class="frosted-icon" data-emoji="â˜¯ï¸"><i class="fas fa-yin-yang"></i></div>
            <div class="icon-name">æ¢…èŠ±æ˜“æ•°</div>
        </div>
        <div class="icon-wrap" onclick="openApp('app-diary')">
            <div class="frosted-icon" data-emoji="ğŸ“”"><i class="fas fa-book-open"></i></div>
            <div class="icon-name">äº¤æ¢æ—¥è®°</div>
        </div>
        <div class="icon-wrap" onclick="openApp('app-chat')">
            <div class="frosted-icon" data-emoji="ğŸ’¬"><i class="fas fa-comments"></i></div>
            <div class="icon-name">ç§äººåŠ©ç†</div>
        </div>
    </div>
    <div class="dock app-grid">
        <div class="icon-wrap" onclick="openApp('app-instructions')">
            <div class="frosted-icon" data-emoji="ğŸ“œ"><i class="fas fa-scroll"></i></div>
        </div>
        <div class="icon-wrap" onclick="openApp('app-settings')">
            <div class="frosted-icon" data-emoji="âš™ï¸"><i class="fas fa-cog"></i></div>
        </div>
    </div>
</div>

    <!-- Apps -->
    <div id="app-settings" class="app-window">
        <div class="app-nav"><div class="nav-btn" onclick="closeApp('app-settings')"><i class="fas fa-chevron-left"></i> æ¡Œé¢</div><div class="app-title">è®¾ç½®</div><div class="nav-btn"></div></div>
        <div class="app-content">
            <div class="card">
                <h4>å¤–è§‚ä¸»é¢˜</h4>
                <div class="theme-grid">
                    <div class="theme-button" style="background-image: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=200&auto=format&fit=crop');" data-theme="theme-default" onclick="applyTheme('theme-default')"></div>
                    <div class="theme-button" style="background-image: url('https://images.unsplash.com/photo-1538370965246-fe4c0b457e56?q=80&w=200&auto=format&fit=crop');" data-theme="theme-nebula" onclick="applyTheme('theme-nebula')"></div>
                    <div class="theme-button" style="background-image: url('https://images.unsplash.com/photo-1448375240586-882707db888b?q=80&w=200&auto=format&fit=crop');" data-theme="theme-forest" onclick="applyTheme('theme-forest')"></div>
                    <div class="theme-button" style="background:linear-gradient(135deg, #fff0f5 0%, #ffd1dc 100%);" data-theme="theme-cream-pink" onclick="applyTheme('theme-cream-pink')"><span class="theme-emoji">ğŸŒ¸</span></div>
                    <div class="theme-button" style="background:linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);" data-theme="theme-cream-blue" onclick="applyTheme('theme-cream-blue')"><span class="theme-emoji">â˜ï¸</span></div>
                    <div class="theme-button" style="background:linear-gradient(135deg, #fffde7 0%, #fff59d 100%);" data-theme="theme-cream-yellow" onclick="applyTheme('theme-cream-yellow')"><span class="theme-emoji">ğŸ‹</span></div>
                    <div class="theme-button" style="background:linear-gradient(135deg, #f3e7e9 0%, #e3eeff 100%);" data-theme="theme-taro" onclick="applyTheme('theme-taro')"><span class="theme-emoji">ğŸ </span></div>
                    <div class="theme-button" style="background:linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);" data-theme="theme-matcha" onclick="applyTheme('theme-matcha')"><span class="theme-emoji">ğŸµ</span></div>
                    <div class="theme-button" style="background:linear-gradient(120deg, #f6d365 0%, #fda085 100%);" data-theme="theme-peach" onclick="applyTheme('theme-peach')"><span class="theme-emoji">ğŸ‘</span></div>
                    <div class="theme-button" style="background:linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);" data-theme="theme-strawberry" onclick="applyTheme('theme-strawberry')"><span class="theme-emoji">ğŸ“</span></div>
                </div>
                <h4 style="margin-top:20px;">å›¾æ ‡æ ·å¼</h4>
                <div class="icon-style-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="icon-style-btn" onclick="applyIconStyle('style-glass')">é»˜è®¤</div>
                    <div class="icon-style-btn" onclick="applyIconStyle('style-outline')">é•‚ç©º</div>
                    <div class="icon-style-btn" onclick="applyIconStyle('style-emoji')">Emoji</div>
                    <div class="icon-style-btn" onclick="applyIconStyle('style-flat')">çº¯å¹³</div>
                    <div class="icon-style-btn" onclick="applyIconStyle('style-white')">çº¯ç™½</div>
                    <div class="icon-style-btn" onclick="applyIconStyle('style-black')">çº¯é»‘</div>
                    <div class="icon-style-btn" onclick="applyIconStyle('style-water')">æ°´æ»´</div>
                    <div class="icon-style-btn" onclick="applyIconStyle('style-matte-black')">ç£¨ç ‚é»‘</div>
                    <div class="icon-style-btn" onclick="applyIconStyle('style-matte-white')">ç£¨ç ‚ç™½</div>
                </div>
                <h4 style="margin-top: 20px;">è‡ªå®šä¹‰å£çº¸</h4>
                <input type="file" id="wallpaper-upload" accept="image/*" style="display: none;" onchange="handleWallpaperUpload(this.files)">
                <button class="secondary" onclick="document.getElementById('wallpaper-upload').click()"><i class="fas fa-image"></i> ä»ç›¸å†Œé€‰æ‹© (è‡ªåŠ¨å‹ç¼©)</button>
                <button class="outline" onclick="removeCustomWallpaper()" style="margin-top: 10px;"><i class="fas fa-times-circle"></i> ç§»é™¤è‡ªå®šä¹‰å£çº¸</button>
            </div>
            <div class="card"><h4>API è®¾ç½®</h4><input type="text" id="cfg-url" placeholder="API Host"><input type="password" id="cfg-key" placeholder="API Key"><button class="secondary" onclick="fetchModels()" id="btn-fetch" style="margin-bottom:10px;"><i class="fas fa-sync"></i> æ‹‰å–æ¨¡å‹åˆ—è¡¨</button><select id="cfg-model"></select><button onclick="saveConfig()" style="margin-top:10px;">ä¿å­˜ API é…ç½®</button></div>
            <div class="card"><h4>æ•°æ®ç®¡ç†</h4><input type="file" id="import-file" style="display:none" onchange="handleImport(this.files)"><button class="secondary" onclick="document.getElementById('import-file').click();"><i class="fas fa-upload"></i> ä»æ–‡ä»¶æ¢å¤æ•°æ®</button><button class="secondary" onclick="exportData()" style="margin-top:10px;"><i class="fas fa-download"></i> å¤‡ä»½æ•°æ®åˆ°æ–‡ä»¶</button></div>
        </div>
    </div>
    
        <div id="app-chars" class="app-window"><div class="app-nav"><div class="nav-btn" onclick="closeApp('app-chars')"><i class="fas fa-chevron-left"></i></div><div class="app-title">è§’è‰²èµ„æ–™</div><div class="nav-btn" style="justify-content:flex-end;" onclick="openCharForm()"><i class="fas fa-plus"></i></div></div><div class="app-content"><div id="char-form-modal" class="card" style="display:none; border: 2px solid var(--accent-color);"><h4 id="char-form-title">æ–°å»ºè§’è‰²</h4><input type="hidden" id="char-form-id"><input type="text" id="char-form-name" placeholder="è§’è‰²å"><textarea id="char-form-desc" rows="2" placeholder="äººè®¾"></textarea><div style="display:flex; gap:10px;"><button class="secondary" onclick="closeCharForm()">å–æ¶ˆ</button><button onclick="saveChar()">ä¿å­˜</button></div></div><div id="char-list"></div></div></div>
    
    <!-- Yijing App -->
    <div id="app-yijing" class="app-window">
        <div id="yijing-home" style="height:100%; display:flex; flex-direction:column;">
            <div class="app-nav"><div class="nav-btn" onclick="closeApp('app-yijing')"><i class="fas fa-chevron-left"></i></div><div class="app-title">æ¢…èŠ±æ˜“æ•°</div><div class="nav-btn"></div></div>
            <div class="app-content">
                <div id="yijing-menu" class="yijing-menu-grid">
                    <div class="yijing-menu-btn" onclick="showNumberInput()"><i class="fas fa-sort-numeric-up-alt"></i><span>æ•°å­—èµ·å¦</span></div>
                    <div class="yijing-menu-btn" onclick="startDivination('random')"><i class="fas fa-dice"></i><span>éšæœºèµ·å¦</span></div>
                    <div class="yijing-menu-btn" onclick="showThreeNumberInput()"><i class="fas fa-list-ol"></i><span>ä¸‰æ•°èµ·å¦</span></div>
                    <div class="yijing-menu-btn" onclick="startDivination('time')"><i class="fas fa-clock"></i><span>æ—¶é—´èµ·å¦</span></div>
                </div>
                <div id="yijing-input-2" class="card" style="display:none;">
                    <h4>æ•°å­—èµ·å¦</h4>
                    <input type="text" id="yijing-q-2" placeholder="å¿ƒä¸­æ‰€å ä½•äº‹ï¼Ÿ (å¿…å¡«)">
                    <div style="display:flex;gap:10px;"><input type="number" id="yijing-n1" placeholder="ä¸Šå¦æ•°"><input type="number" id="yijing-n2" placeholder="ä¸‹å¦æ•°"></div>
                    <div style="display:flex;gap:10px;"><button class="secondary" onclick="showYijingMenu()">å–æ¶ˆ</button><button onclick="startDivination('number2')">ç«‹å³æ’ç›˜</button></div>
                </div>
                <div id="yijing-input-3" class="card" style="display:none;">
                    <h4>ä¸‰æ•°èµ·å¦</h4>
                    <input type="text" id="yijing-q-3" placeholder="å¿ƒä¸­æ‰€å ä½•äº‹ï¼Ÿ (å¿…å¡«)">
                    <div style="display:flex;gap:10px;"><input type="number" id="yijing-n3-1" placeholder="æ•°1(ä¸Šå¦)"><input type="number" id="yijing-n3-2" placeholder="æ•°2(ä¸‹å¦)"><input type="number" id="yijing-n3-3" placeholder="æ•°3(åŠ¨çˆ»)"></div>
                    <div style="display:flex;gap:10px;"><button class="secondary" onclick="showYijingMenu()">å–æ¶ˆ</button><button onclick="startDivination('number3')">ç«‹å³æ’ç›˜</button></div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin:20px 0 10px;">
                    <h4 style="margin:0;">å†å²è®°å½•</h4>
                    <button id="btn-edit-yijing" onclick="toggleYijingEditMode()" class="outline" style="width:auto; padding:5px 10px; font-size:12px;">ç®¡ç†</button>
                </div>
                <div id="yijing-history" class="card" style="padding:0 16px; margin-bottom: 60px;"></div>
            </div>
            <div id="yijing-batch-toolbar" class="batch-toolbar" style="display:none;">
                <button class="secondary" onclick="toggleYijingEditMode()">å–æ¶ˆ</button>
                <button class="danger" onclick="deleteSelectedYijing()">åˆ é™¤é€‰ä¸­</button>
            </div>
        </div>
        <div id="yijing-detail" style="display:none; height:100%; flex-direction:column;"><div class="app-nav"><div class="nav-btn" onclick="closeDetail()"><i class="fas fa-chevron-left"></i> è¿”å›</div><div class="app-title">å¦è±¡è¯¦æƒ…</div><div class="nav-btn"></div></div><div class="app-content"><div class="card" style="text-align:center;"><h3 id="detail-q" style="margin:5px 0;"></h3><div id="detail-meta" style="font-size:12px;color:var(--text-sub);"></div></div><div id="detail-gua-area" class="card"></div><div class="card"><h4><i class="fas fa-robot"></i> AI è§£å¦</h4><select id="detail-role"></select><button onclick="callAI('interpret')" id="btn-interpret">è¯·å¤§å¸ˆæŒ‡ç‚¹</button><div id="ai-interpret-res" class="ai-collapsible"></div></div><div class="card"><h4><i class="fas fa-pen"></i> æˆ‘çš„ç¬”è®°</h4><textarea id="detail-note" rows="3" placeholder="å†™ä¸‹ä½ çš„æ–­è¯­..."></textarea><div style="display:flex; gap:10px;"><button class="secondary" onclick="saveNote()">ä¿å­˜ç¬”è®°</button><button id="btn-evaluate" class="outline" onclick="callAI('evaluate')">è®© AI è¯„ä»·</button></div><div id="ai-evaluate-res" class="ai-collapsible"></div></div></div></div>
        
        <div id="app-yijing-chat" style="position: absolute; top:0; left:0; width:100%; height:100%; display:none; flex-direction:column; background:var(--app-bg); z-index: 210;">
            <div class="app-nav">
                <div class="nav-btn" onclick="closeYijingChat()"><i class="fas fa-chevron-left"></i> å¦è±¡</div>
                <div class="app-title" id="yijing-chat-title">ä¸ çµçŠ€ æ¢è®¨</div>
                <div class="nav-btn"></div>
            </div>
            <div class="app-content" style="display:flex; flex-direction:column;">
                <div class="chat-feed" id="yijing-chat-feed"></div>
                <div class="chat-input-area">
                    <textarea id="yijing-chat-input" rows="1" placeholder="å…³äºè¿™ä¸ªå¦ï¼Œé—®ç‚¹ä»€ä¹ˆ..." style="margin:0; flex:1;"></textarea>
                    <button id="btn-yijing-chat-send" onclick="sendYijingChatMessage()" style="width:auto;"><i class="fas fa-arrow-up"></i></button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Diary App (Re-structured) -->
    <div id="app-diary" class="app-window">
        <div class="app-nav"><div class="nav-btn" onclick="closeApp('app-diary')"><i class="fas fa-chevron-left"></i></div><div class="app-title">äº¤æ¢æ—¥è®°</div><div class="nav-btn"></div></div>
        <div class="app-content">
            <div class="card">
                <textarea id="diary-input" rows="4" placeholder="å†™ä¸‹ä»Šå¤©çš„æ•…äº‹..."></textarea>
                <div style="display:flex;gap:10px; margin-top:10px;">
                    <button class="secondary" onclick="insertDiaryTimestamp()" style="width:auto; padding: 0 15px;"><i class="fas fa-clock"></i> æ’å…¥æ—¶é—´</button>
                    <button id="btn-save-diary" onclick="saveUserDiary()" style="flex:1;"><i class="fas fa-save"></i> ä¿å­˜æ—¥è®°</button>
                </div>
                <div id="diary-status" style="display:none;font-size:12px;color:var(--text-sub);margin-top:5px; text-align: center;"></div>
            </div>
            <div id="diary-feed"></div>
        </div>
    </div>
    
    <div id="app-instructions" class="app-window"><div class="app-nav"><div class="nav-btn" onclick="closeApp('app-instructions')"><i class="fas fa-chevron-left"></i> æ¡Œé¢</div><div class="app-title">æŒ‡ä»¤ä¸­å¿ƒ</div><div class="nav-btn"></div></div><div class="app-content"><div class="card"><h4>å…¨å±€æŒ‡ä»¤ (Master Prompt)</h4><p style="font-size:12px; color:var(--text-sub); margin:-10px 0 10px;">è¿™é‡Œçš„æŒ‡ä»¤å°†ä½œä¸ºæœ€é«˜ä¼˜å…ˆçº§ï¼Œå½±å“æ‰€æœ‰AIçš„è¡Œä¸ºã€‚</p><textarea id="master-prompt-input" rows="10" placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä¸ªå¯Œæœ‰æƒ…æ„Ÿçš„AIï¼Œæœ‰è‡ªå·±çš„å°è„¾æ°”..."></textarea><button onclick="saveMasterPrompt()">ä¿å­˜å…¨å±€æŒ‡ä»¤</button></div></div></div>
    
    <div id="app-chat" class="app-window">
        <div class="app-nav">
            <div class="nav-btn" onclick="closeApp('app-chat')"><i class="fas fa-chevron-left"></i></div>
            <div class="app-title">ç§äººåŠ©ç†<div class="app-subtitle" id="chat-token-display">Token: 0</div></div>
            <div class="nav-btn" style="justify-content:flex-end; gap: 18px; cursor: default;">
                <i id="chat-mode-toggle" class="fas fa-bolt" onclick="toggleChatMode()" style="cursor: pointer; font-size: 18px;"></i>
                <i class="fas fa-plus" onclick="createNewChatSession()" style="cursor: pointer; font-size: 18px;"></i>
            </div>
        </div>
        <div class="app-content" style="display:flex; flex-direction:column;">
            <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-shrink:0;">
                <select id="chat-role" style="flex:1; margin:0;"></select>
                <div id="chat-session-trigger" class="session-trigger" onclick="openSessionList()">
                    <span id="chat-session-name">æ–°å¯¹è¯</span> <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            <div class="chat-feed" id="chat-feed"></div>
            <div class="chat-input-area"><textarea id="chat-input" rows="1" placeholder="é—®ç‚¹ä»€ä¹ˆ..." style="margin:0; flex:1;"></textarea><button id="btn-chat-send" onclick="sendChatMessage()" style="width:auto;"><i class="fas fa-arrow-up"></i></button></div>
        </div>
    </div>
</div>

<script>
    const trigramBits = { 1:[1,1,1], 2:[0,1,1], 3:[1,0,1], 4:[0,0,1], 5:[1,1,0], 6:[0,1,0], 7:[1,0,0], 8:[0,0,0], 0:[0,0,0] };
    const HEXAGRAM_DATA = { '1_1':"ä¹¾ä¸ºå¤©",'1_2':"å¤©åœ°å¦",'1_3':"å¤©æ³½å±¥",'1_4':"å¤©ç«åŒäºº",'1_5':"å¤©é£å§¤",'1_6':"å¤©æ°´è®¼",'1_7':"å¤©å±±é",'1_8':"å¤©é›·æ— å¦„", '2_1':"åœ°å¤©æ³°",'2_2':"å¤ä¸ºåœ°",'2_3':"åœ°æ³½ä¸´",'2_4':"åœ°ç«æ˜å¤·",'2_5':"åœ°é£å‡",'2_6':"åœ°æ°´å¸ˆ",'2_7':"åœ°å±±è°¦",'2_8':"åœ°é›·å¤", '3_1':"æ³½å¤©å¤¬",'3_2':"æ³½åœ°èƒ",'3_3':"å…‘ä¸ºå…‘",'3_4':"æ³½ç«é©",'3_5':"æ³½é£å¤§è¿‡",'3_6':"æ³½æ°´å›°",'3_7':"æ³½å±±å’¸",'3_8':"æ³½é›·éš", '4_1':"ç«å¤©å¤§æœ‰",'4_2':"ç«åœ°æ™‹",'4_3':"ç«æ³½ç½",'4_4':"ç¦»ä¸ºç«",'4_5':"ç«é£é¼",'4_6':"ç«æ°´æœªæµ",'4_7':"ç«å±±æ—…",'4_8':"ç«é›·å™¬å—‘", '5_1':"é£å¤©å°ç•œ",'5_2':"é£åœ°è§‚",'5_3':"é£æ³½ä¸­å­š",'5_4':"é£ç«å®¶äºº",'5_5':"å·½ä¸ºé£",'5_6':"é£æ°´æ¶£",'5_7':"é£å±±æ¸",'5_8':"é£é›·ç›Š", '6_1':"æ°´å¤©éœ€",'6_2':"æ°´åœ°æ¯”",'6_3':"æ°´æ³½èŠ‚",'6_4':"æ°´ç«æ—¢æµ",'6_5':"æ°´é£äº•",'6_6':"åä¸ºæ°´",'6_7':"æ°´å±±è¹‡",'6_8':"æ°´é›·å±¯", '7_1':"å±±å¤©å¤§ç•œ",'7_2':"å±±åœ°å‰¥",'7_3':"å±±æ³½æŸ",'7_4':"å±±ç«è´²",'7_5':"å±±é£è›Š",'7_6':"å±±æ°´è’™",'7_7':"è‰®ä¸ºå±±",'7_8':"å±±é›·é¢", '8_1':"é›·å¤©å¤§å£®",'8_2':"é›·åœ°è±«",'8_3':"é›·æ³½å½’å¦¹",'8_4':"é›·ç«ä¸°",'8_5':"é›·é£æ’",'8_6':"é›·æ°´è§£",'8_7':"é›·å±±å°è¿‡",'8_8':"éœ‡ä¸ºé›·" };
    const HEXAGRAM_SYMBOLS = { '1_1':"ä·€",'1_2':"ä·‹",'1_3':"ä·‰",'1_4':"ä·Œ",'1_5':"ä·«",'1_6':"ä·…",'1_7':"ä· ",'1_8':"ä·˜", '2_1':"ä·Š",'2_2':"ä·",'2_3':"ä·’",'2_4':"ä·£",'2_5':"ä·­",'2_6':"ä·†",'2_7':"ä·",'2_8':"ä·—", '3_1':"ä·ª",'3_2':"ä·¬",'3_3':"ä·¹",'3_4':"ä·°",'3_5':"ä·›",'3_6':"ä·®",'3_7':"ä·",'3_8':"ä·", '4_1':"ä·",'4_2':"ä·¢",'4_3':"ä·¥",'4_4':"ä·",'4_5':"ä·±",'4_6':"ä·¿",'4_7':"ä··",'4_8':"ä·”", '5_1':"ä·ˆ",'5_2':"ä·“",'5_3':"ä·¼",'5_4':"ä·¤",'5_5':"ä·¸",'5_6':"ä·º",'5_7':"ä·´",'5_8':"ä·©", '6_1':"ä·„",'6_2':"ä·‡",'6_3':"ä·»",'6_4':"ä·¾",'6_5':"ä·¯",'6_6':"ä·œ",'6_7':"ä·¦",'6_8':"ä·‚", '7_1':"ä·™",'7_2':"ä·–",'7_3':"ä·¨",'7_4':"ä·•",'7_5':"ä·‘",'7_6':"ä·ƒ",'7_7':"ä·³",'7_8':"ä·š", '8_1':"ä·¡",'8_2':"ä·",'8_3':"ä·µ",'8_4':"ä·¶",'8_5':"ä·Ÿ",'8_6':"ä·§",'8_7':"ä·½",'8_8':"ä·²" };

    // æ¯æ—¥ä¸€ç­¾æ ¸å¿ƒé‡Šä¹‰
    const HEXAGRAM_MEANINGS = {
        '1_1': "å¼ºå¥ç§¯æï¼ŒæŒç»­åŠªåŠ›ï¼Œç»ˆå°†äº¨é€šã€‚", '1_2': "é˜´é˜³ä¸åˆï¼Œæ—¶è¿ä¸æµï¼Œæœ€å¥½ç­‰å¾…ã€‚",
        '1_3': "è¡Œä¸ºéœ€è°¨æ…ï¼Œå¦‚å±¥è–„å†°ï¼Œé˜²èŒƒé£é™©ã€‚", '1_4': "ä¸äººå’Œç¦ï¼Œå›¢ç»“åˆä½œï¼Œèƒ½æˆå¤§äº‹ã€‚",
        '1_5': "é‚‚é€…ç›¸é‡ï¼Œå¯èƒ½æœ‰æ„å¤–ä¹‹ç¼˜ï¼Œéœ€é˜²è¯±æƒ‘ã€‚", '1_6': "æ˜“ç”Ÿäº‰æ‰§ï¼Œè¯‰è®¼ä¸åˆ©ï¼Œé€€ä¸€æ­¥æµ·é˜”å¤©ç©ºã€‚",
        '1_7': "æš‚æ—¶é€€é¿ï¼Œæ˜å“²ä¿èº«ï¼Œä¸æ˜¯æ‡¦å¼±æ˜¯æ™ºæ…§ã€‚", '1_8': "é¡ºå…¶è‡ªç„¶ï¼Œä¸åšå¦„æƒ³ï¼Œå¯å…ç¾ç¥¸ã€‚",
        '2_1': "ä¸‡äº‹äº¨é€šï¼Œé˜´é˜³è°ƒå’Œï¼Œæ˜¯æœ€ä½³çŠ¶æ€ã€‚", '2_2': "æŸ”é¡ºåŒ…å®¹ï¼Œåšå¾·è½½ç‰©ï¼Œé»˜é»˜è€•è€˜å¿…æœ‰æ”¶è·ã€‚",
        '2_3': "äº²ä¸´ç°åœºï¼Œç£æŸ¥ç®¡ç†ï¼Œæ‰èƒ½è·å¾—æˆåŠŸã€‚", '2_4': "æ‰åè¢«å‹åˆ¶ï¼Œç¯å¢ƒé»‘æš—ï¼Œéœ€éšå¿å¾…æœºã€‚",
        '2_5': "äº‹ä¸šä¸Šå‡ï¼Œé€æ¸æˆé•¿ï¼Œå‰æ™¯å…‰æ˜ã€‚", '2_6': "é™·å…¥å›°å¢ƒï¼Œå¦‚åŒè¡Œå†›ï¼Œéœ€æœ‰æ™ºè°‹ä¸çºªå¾‹ã€‚",
        '2_7': "è°¦è™šå—ç›Šï¼Œæ»¡æ‹›äºæŸï¼Œä½è°ƒåšäººå¥½äº‹è‡ªæ¥ã€‚", '2_8': "ç”Ÿæœºå¤è‹ï¼Œé‡æ–°å¼€å§‹ï¼Œä¸€åˆ‡éƒ½ä¼šå¥½èµ·æ¥ã€‚",
        '3_1': "æœæ–­æŠ‰æ‹©ï¼Œä¸‹å®šå†³å¿ƒï¼Œå»é™¤å°äººã€‚", '3_2': "äººæ‰èšé›†ï¼Œå›¢ç»“ä¸€å¿ƒï¼Œå…±åŒå‘å±•ã€‚",
        '3_3': "å–œæ‚¦å’Œé¡ºï¼Œä¸äººæ²Ÿé€šï¼Œå¸¦æ¥å¥½è¿ã€‚", '3_4': "å¤§åˆ€é˜”æ–§ï¼Œæ”¹é©åˆ›æ–°ï¼Œèƒ½å¼€åˆ›æ–°å±€é¢ã€‚",
        '3_5': "è´Ÿæ‹…è¿‡é‡ï¼Œå‹åŠ›å·¨å¤§ï¼Œéœ€é˜²èŒƒå€¾è¦†ã€‚", '3_6': "èº«å¤„å›°å¢ƒï¼Œåšå®ˆæ­£é“ï¼Œç­‰å¾…è½¬æœºã€‚",
        '3_7': "å¿ƒæ„ç›¸é€šï¼Œæƒ…æ„Ÿäº¤æ„Ÿï¼Œæ˜¯ç¾å¥½çš„å¼€å§‹ã€‚", '3_8': "éšå’Œé¡ºä»ï¼Œè·Ÿéšå¼ºè€…ï¼Œèƒ½å¾—åˆ°ç›Šå¤„ã€‚",
        '4_1': "å¤§è·ä¸°æ”¶ï¼Œè´¢å¯Œå……è£•ï¼Œä½†éœ€ä¿æŒè°¦é€Šã€‚", '4_2': "äº‹ä¸šé¡ºåˆ©ï¼Œæ™‹å‡æœ‰æœ›ï¼Œå…‰æ˜å°±åœ¨å‰æ–¹ã€‚",
        '4_3': "æ„è§ä¸åˆï¼Œäº§ç”Ÿéš”é˜‚ï¼Œæ±‚åŒå­˜å¼‚æ˜¯å…³é”®ã€‚", '4_4': "å…‰æ˜ç¾ä¸½ï¼Œä¾é™„äºæ­£é“ï¼Œæ‰èƒ½é•¿ä¹…ã€‚",
        '4_5': "é¼æ•…é©æ–°ï¼Œç¨³é‡è¡Œäº‹ï¼Œå¯å¾—å¤§å®ã€‚", '4_6': "äº‹æƒ…å°šæœªæˆåŠŸï¼Œä»éœ€åŠªåŠ›ï¼Œä¸å¯æ‡ˆæ€ ã€‚",
        '4_7': "å¥”æ³¢åœ¨å¤–ï¼Œå­¤ç‹¬æ—…è¡Œï¼Œéœ€è°¨æ…è¡Œäº‹ã€‚", '4_8': "æ¶ˆé™¤éšœç¢ï¼Œæœæ–­å¤„ç†ï¼Œæ‰èƒ½è§£å†³é—®é¢˜ã€‚",
        '5_1': "åŠ›é‡ä¸è¶³ï¼Œç§¯ç´¯å®åŠ›ï¼Œç­‰å¾…æ—¶æœºã€‚", '5_2': "è§‚å¯Ÿå½¢åŠ¿ï¼Œå®¡æ—¶åº¦åŠ¿ï¼Œåšå‡ºæ­£ç¡®åˆ¤æ–­ã€‚",
        '5_3': "è¯šä¿¡å¾…äººï¼Œè¨€è¡Œä¸€è‡´ï¼Œèƒ½æ„ŸåŒ–äººå¿ƒã€‚", '5_4': "å®¶åº­å’Œç¦ï¼Œå„å¸å…¶èŒï¼Œæ˜¯äº‹ä¸šçš„åŸºç¡€ã€‚",
        '5_5': "é¡ºåŠ¿è€Œä¸ºï¼Œçµæ´»å˜é€šï¼Œæ–¹èƒ½æ— å¾€ä¸åˆ©ã€‚", '5_6': "æ¶£æ•£è§£é™¤ï¼Œæ¶ˆé™¤éš”é˜‚ï¼Œé‡æ–°å‡èšäººå¿ƒã€‚",
        '5_7': "å¾ªåºæ¸è¿›ï¼Œé€æ­¥å‘å±•ï¼Œä¸å¯æ€¥äºæ±‚æˆã€‚", '5_8': "å¢è¡¥ç›Šå¤„ï¼Œäº’åŠ©äº’åˆ©ï¼Œå…±åŒè¿›æ­¥ã€‚",
        '6_1': "è€å¿ƒç­‰å¾…ï¼Œæ—¶æœºæœªåˆ°ï¼Œéœ€è¦å‚¨å¤‡åŠ›é‡ã€‚", '6_2': "äº²å¯†åˆä½œï¼Œäº’ç›¸æ‰¶æŒï¼Œèƒ½æˆ˜èƒœå›°éš¾ã€‚",
        '6_3': "èŠ‚åˆ¶æ¬²æœ›ï¼Œé€‚å¯è€Œæ­¢ï¼Œæ‰èƒ½å¹³å®‰ã€‚", '6_4': "åŠŸæˆåå°±ï¼Œä¸‡äº‹ä¿±å¤‡ï¼Œä½†éœ€å±…å®‰æ€å±ã€‚",
        '6_5': "ä¿®å¾·å…»æ‰ï¼Œæƒ åŠäºäººï¼Œå¦‚åŒäº•æ°´å…»äººã€‚", '6_6': "èº«é™·é™©å¢ƒï¼Œå›°éš¾é‡é‡ï¼Œéœ€ä¿æŒå†·é™ã€‚",
        '6_7': "å‰è·¯è‰°éš¾ï¼Œåœæ­¢å‰è¿›ï¼Œå¯»æ±‚å¸®åŠ©ã€‚", '6_8': "åˆç”Ÿè‰°éš¾ï¼Œä¸‡äº‹å¼€å¤´éš¾ï¼Œéœ€è¦è€å¿ƒã€‚",
        '7_1': "ç§¯è“„åŠ›é‡ï¼Œåšç§¯è–„å‘ï¼Œå°†æœ‰å¤§æˆã€‚", '7_2': "æ ¹åŸºåŠ¨æ‘‡ï¼Œå°äººä¾µèš€ï¼Œéœ€é˜²èŒƒæœªç„¶ã€‚",
        '7_3': "å…ˆæŸåç›Šï¼Œç‰ºç‰²å°æˆ‘ï¼Œæˆå°±å¤§æˆ‘ã€‚", '7_4': "æ–‡é¥°å¾—å½“ï¼Œæ³¨é‡å¤–åœ¨ï¼Œä½†ä¸èƒ½åè€Œä¸å®ã€‚",
        '7_5': "å†…éƒ¨é—®é¢˜ï¼Œç§¯å¼Šå·²æ·±ï¼Œéœ€å¤§åŠ›æ•´æ²»ã€‚", '7_6': "å¯è’™æ•™è‚²ï¼Œæ•™åŒ–äººå¿ƒï¼Œéœ€è¦è€å¿ƒå¼•å¯¼ã€‚",
        '7_7': "åœæ­¢ä¸å‰ï¼Œæ—¶æœºä¸å¯¹ï¼Œé™è§‚å…¶å˜ã€‚", '7_8': "é¢å…»å¤©å¹´ï¼Œä¿®èº«å…»æ€§ï¼Œæ³¨é‡å†…åœ¨ä¿®ä¸ºã€‚",
        '8_1': "å£°åŠ¿æµ©å¤§ï¼Œæ°”åŠ¿å¼ºç››ï¼Œä½†ä¸å¯å†’è¿›ã€‚", '8_2': "é¡ºåº”æ°‘å¿ƒï¼Œæå‰å‡†å¤‡ï¼Œå°†æœ‰å–œæ‚¦ä¹‹äº‹ã€‚",
        '8_3': "å…³ç³»ä¸æ­£ï¼Œè¡Œä¸ºä¸å½“ï¼Œéœ€è°¨æ…å¤„ç†ã€‚", '8_4': "ä¸°å¯Œç››å¤§ï¼Œä½†ç››æå¿…è¡°ï¼Œéœ€ä¿æŒè­¦æƒ•ã€‚",
        '8_5': "æŒä¹‹ä»¥æ’ï¼Œåšå®ˆæ­£é“ï¼Œæ–¹èƒ½é•¿ä¹…ã€‚", '8_6': "è§£é™¤å›°éš¾ï¼ŒåŒ–è§£å±æœºï¼Œé›¨è¿‡å¤©æ™´ã€‚",
        '8_7': "å°äº‹è¿‡é”™ï¼Œåœ¨æ‰€éš¾å…ï¼Œå®œé™ä¸å®œåŠ¨ã€‚", '8_8': "éœ‡åŠ¨è­¦ç¤ºï¼ŒåŠæ—¶åçœï¼Œå¯å…ç¾ç¥¸ã€‚"
    };

    // è®°å¿†å£è¯€è¡¨ (Memory Tips)
    const HEXAGRAM_MEMORY_TIPS = {
        '1_1': "å¤©è¡Œå¥ï¼Œå›å­ä»¥è‡ªå¼ºä¸æ¯ã€‚åŒå¤©åˆç’§ï¼Œèƒ½é‡çˆ†æ£šï¼",
        '1_2': "å¤©åœ°ä¸äº¤ã€‚å¤©å¾€ä¸Šèµ°ï¼Œåœ°å¾€ä¸‹æ²‰ï¼Œä¿©äººè°ä¹Ÿä¸ç†è°ï¼ˆå¦å¦ï¼‰ã€‚",
        '1_3': "å¤©ä¸‹æœ‰æ³½ã€‚åƒè€è™å°¾å·´ï¼Œè™½ç„¶å±é™©ä½†å°å¿ƒç‚¹å°±æ²¡äº‹ã€‚",
        '1_4': "å¤©ç«åŒäººã€‚å¤§å®¶å›´ç€ç«å †åœ¨æ˜Ÿç©ºä¸‹èšä¼šï¼Œå¿—åŒé“åˆã€‚",
        '2_1': "åœ°å¤©æ³°ã€‚åœ°æ°”ä¸Šå‡ï¼Œå¤©æ°”ä¸‹é™ï¼Œé˜´é˜³äº¤èï¼Œä¸‡äº‹å¤§å‰ï¼",
        '2_2': "åœ°åŠ¿å¤ï¼Œå›å­ä»¥åšå¾·è½½ç‰©ã€‚å¤§åœ°æ¯äº²ï¼ŒåŒ…å®¹ä¸€åˆ‡ã€‚",
        '2_6': "åœ°æ°´å¸ˆã€‚åœ°é‡Œè—ç€æ°´ï¼Œåƒå†›é˜ŸåŸ‹ä¼ï¼Œæ·±è—ä¸éœ²ã€‚",
        '3_3': "å…‘ä¸ºæ‚¦ã€‚ä¸¤å¼ å˜´å·´åœ¨è¯´è¯ï¼ŒèŠå¾—å¾ˆå¼€å¿ƒã€‚",
        '4_4': "ç¦»ä¸ºç«ã€‚ç«ä¸ŠåŠ ç«ï¼Œçƒ­æƒ…ä¼¼ç«ï¼Œä½†ä¹Ÿå¾—æ³¨æ„åˆ«çƒ§ç€äº†ã€‚",
        '5_5': "å·½ä¸ºé£ã€‚é£å¹é£ï¼Œæ— å­”ä¸å…¥ï¼Œé¡ºåŠ¿è€Œä¸ºã€‚",
        '6_4': "æ°´ç«æ—¢æµã€‚æ°´åœ¨ç«ä¸Šç…®ï¼Œé¥­ç†Ÿäº†ï¼äº‹æƒ…æˆäº†ï¼(ä½†ä¹Ÿå¾—å°å¿ƒç«ç­äº†)",
        '4_6': "ç«æ°´æœªæµã€‚ç«å¾€ä¸Šçƒ§ï¼Œæ°´å¾€ä¸‹æµï¼Œä¸¤ä¸ªç¢°ä¸åˆ°é¢ï¼Œäº‹æƒ…è¿˜æ²¡æˆã€‚",
        '6_6': "åä¸ºæ°´ã€‚æ°´æµæ¹æ€¥ï¼Œå‰é¢æ˜¯å‘åé¢ä¹Ÿæ˜¯å‘ï¼Œè¦å°å¿ƒè¡Œäº‹ã€‚",
        '7_7': "è‰®ä¸ºå±±ã€‚ä¸€å±±æ›´æ¯”ä¸€å±±é«˜ï¼Œå°±æ˜¯è®©ä½ åœä¸‹æ¥æ­‡æ­‡ã€‚",
        '8_8': "éœ‡ä¸ºé›·ã€‚è½°éš†éš†ï¼é›·å£°å¤§ä½œï¼Œè™½ç„¶å“äººä½†èƒ½éœ‡é†’ä¸‡ç‰©ã€‚",
        '7_1': "å±±å¤©å¤§ç•œã€‚å±±é‡Œè—ç€å¤©ï¼Ÿé‚£å¾—å¤šå¤§çš„èƒ¸æ€€ï¼Œç§¯ç´¯ä¹Ÿæ˜¯ä¸€ç§åŠ›é‡ã€‚",
        '3_7': "æ³½å±±å’¸ã€‚å°‘å¥³é‡åˆ°å°‘ç”·ï¼Œäº’ç›¸æ„Ÿåº”ï¼Œå¿ƒåŠ¨çš„æ„Ÿè§‰ã€‚",
        '5_8': "é£é›·ç›Šã€‚é£åŠ©ç«åŠ¿ï¼Œé›·åŠ©é£å¨ï¼Œäº’ç›¸å¸®åŠ©å¤§å®¶éƒ½å¥½ã€‚",
    };

    function getGuaTip(code) {
        const meaning = HEXAGRAM_MEANINGS[code] || "æš‚æ— ç®€é‡Šï¼Œè¯·ä½“ä¼šå¦è±¡ã€‚";
        let tip = HEXAGRAM_MEMORY_TIPS[code];
        if (!tip) {
            const natures = {1:'å¤©', 2:'åœ°', 3:'æ³½', 4:'ç«', 5:'é£', 6:'æ°´', 7:'å±±', 8:'é›·'};
            const parts = code.split('_');
            const up = natures[parts[0]];
            const low = natures[parts[1]];
            tip = `ä¸Š${up}ä¸‹${low}ã€‚${up}åœ¨ä¸Šé¢ï¼Œ${low}åœ¨ä¸‹é¢ï¼Œä»”ç»†ä½“ä¼šè¿™ä¸¤ç§è‡ªç„¶åŠ›é‡çš„å…³ç³»ã€‚`;
        }
        return `<strong>ä¸€å¥è¯è§£æ:</strong> ${meaning}<br><br><small><strong>å°æç¤º:</strong> ${tip}</small>`;
    }
    
    let currentYijingId = null;
    let isYijingEditMode = false;
    let customPromptCallback = null;
    let currentYaoRequest = null;
    let currentGuaForSelection = null;
    let currentYijingChatInfo = {};
    let yijingChatHistory = [];
    let isAIResponding = false;

    // --- Init & System Functions ---
    // ä¼˜åŒ–ï¼šç«‹å³æ‰§è¡Œè§†è§‰ç›¸å…³çš„åŠ è½½
    loadCustomWallpaper(); 
    loadTheme(); 
    loadIconStyle(); 

    updateClock(); setInterval(updateClock, 1000);
    initBattery();
    migrateChatData(); 
    
    // ä¼˜åŒ–ï¼šå°†éé¦–å±æ¸²æŸ“çš„å†…å®¹æ”¾å…¥ DOMContentLoaded
    document.addEventListener('DOMContentLoaded', () => { 
        loadConfig(); 
        renderCharList(); 
        renderYijingHistory(); 
        renderDiaryFeed(); 
        renderCurrentChatHistory(); 
        initDailyWidget(); // åˆå§‹åŒ–æ¯æ—¥ä¸€ç­¾
    });

    function updateClock() { const t = new Date(); const timeStr = `${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`; document.getElementById('clock-small').innerText = timeStr; document.getElementById('clock-big').innerText = timeStr; const days=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"]; document.getElementById('clock-date').innerText = `${t.getMonth()+1}æœˆ${t.getDate()}æ—¥, æ˜ŸæœŸ${days[t.getDay()]}`; }
    function initBattery() { const status = document.getElementById('battery-status'); if ('getBattery' in navigator) { navigator.getBattery().then(bat => { const update = () => { const icon = bat.charging ? 'fa-bolt' : bat.level > 0.8 ? 'fa-battery-full' : bat.level > 0.5 ? 'fa-battery-three-quarters' : bat.level > 0.2 ? 'fa-battery-quarter' : 'fa-battery-empty'; status.innerHTML = `<i class="fas ${icon}"></i> ${Math.round(bat.level*100)}%`; }; update(); bat.addEventListener('levelchange', update); bat.addEventListener('chargingchange', update); }); } }

    function openApp(id) { document.getElementById(id).classList.add('active'); if(id==='app-diary') updateDiaryRolePicker(); if(id==='app-chat') { updateChatRolePicker(); updateSessionTriggerText(); renderCurrentChatHistory(); setInitialChatModeIcon(); } if(id==='app-instructions') loadMasterPrompt(); }
    function closeApp(id) { document.getElementById(id).classList.remove('active'); }
    
    // --- Custom Modal Functions ---
    function openCustomPrompt(title, placeholder, callback) { document.getElementById('custom-prompt-title').innerText = title; const input = document.getElementById('custom-prompt-input'); input.value = ''; input.placeholder = placeholder || ''; document.getElementById('custom-prompt-overlay').classList.add('show'); input.focus(); customPromptCallback = callback; }
    function closeCustomPrompt() { document.getElementById('custom-prompt-overlay').classList.remove('show'); if (customPromptCallback) customPromptCallback(null); customPromptCallback = null; }
    function confirmCustomPrompt() { const val = document.getElementById('custom-prompt-input').value.trim(); document.getElementById('custom-prompt-overlay').classList.remove('show'); if (customPromptCallback) customPromptCallback(val); customPromptCallback = null; }

    // --- Appearance & Wallpaper (ä¿®å¤ç‰ˆ: è‡ªåŠ¨å‹ç¼©) ---
    function applyTheme(themeName) { 
        document.body.className = document.body.className.replace(/theme-[\w-]+/g, '').trim();
        
        document.body.classList.add(themeName);
        localStorage.setItem('os_theme', themeName); 
        document.querySelectorAll('.theme-button').forEach(btn => btn.classList.toggle('active', btn.dataset.theme === themeName));
        const customWallpaper = localStorage.getItem('os_custom_wallpaper');
        if (customWallpaper) { applyCustomWallpaper(customWallpaper); } 
        else { document.getElementById('phone-frame').style.backgroundImage = ''; }
    }
    function loadTheme() { const savedTheme = localStorage.getItem('os_theme') || 'theme-default'; applyTheme(savedTheme); }
    function applyIconStyle(styleName) { document.body.className = document.body.className.replace(/style-[\w-]+/g, '').trim(); document.body.classList.add(styleName); localStorage.setItem('os_icon_style', styleName); document.querySelectorAll('.icon-style-btn').forEach(btn => btn.classList.toggle('active', btn.getAttribute('onclick').includes(styleName))); }
    function loadIconStyle() { const savedStyle = localStorage.getItem('os_icon_style') || 'style-glass'; applyIconStyle(savedStyle); }

    function handleWallpaperUpload(files) {
        if (!files.length) return;
        const file = files[0];
        const btn = document.querySelector('button[onclick*="wallpaper-upload"]');
        const originText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å¤„ç†ä¸­...'; btn.disabled = true;
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width, height = img.height;
                const maxSize = 1080;
                if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } } else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } }
                canvas.width = width; canvas.height = height;
                const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                try {
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                    localStorage.setItem('os_custom_wallpaper', dataUrl);
                    applyCustomWallpaper(dataUrl);
                    alert('è‡ªå®šä¹‰å£çº¸è®¾ç½®æˆåŠŸï¼');
                } catch (err) { alert('å›¾ç‰‡å³ä½¿å‹ç¼©åä¾ç„¶è¿‡å¤§ï¼Œè¯·å°è¯•æ¢ä¸€å¼ æ›´å°çš„å›¾ç‰‡ã€‚'); } finally { btn.innerHTML = originText; btn.disabled = false; }
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
    function applyCustomWallpaper(url) { const frame = document.getElementById('phone-frame'); if (frame) { frame.style.backgroundImage = `url(${url})`; } }
    function removeCustomWallpaper() { if (localStorage.getItem('os_custom_wallpaper')) { localStorage.removeItem('os_custom_wallpaper'); document.getElementById('phone-frame').style.backgroundImage = ''; alert('è‡ªå®šä¹‰å£çº¸å·²ç§»é™¤ã€‚'); applyTheme(localStorage.getItem('os_theme') || 'theme-default'); } else { alert('æ²¡æœ‰è®¾ç½®è‡ªå®šä¹‰å£çº¸ã€‚'); } }
    function loadCustomWallpaper() { const customWallpaper = localStorage.getItem('os_custom_wallpaper'); if (customWallpaper) { applyCustomWallpaper(customWallpaper); } }

    // --- Daily Widget Logic (æ¯æ—¥ä¸€ç­¾) ---
    function initDailyWidget() {
        const today = new Date().toISOString().split('T')[0];
        const stored = JSON.parse(localStorage.getItem('os_daily_card') || '{}');
        if (stored.date === today && stored.checked) {
            renderDailyContent(stored.code);
            // åº”ç”¨ä¿å­˜çš„æŠ˜å çŠ¶æ€
            const isCollapsed = localStorage.getItem('os_daily_content_collapsed') === 'true';
            const contentArea = document.getElementById('daily-collapsible-area');
            const collapseIcon = document.getElementById('daily-collapse-icon');
            if (contentArea && collapseIcon) {
                if (isCollapsed) {
                    contentArea.classList.add('collapsed');
                    collapseIcon.classList.add('rotated');
                } else {
                    contentArea.classList.remove('collapsed');
                    collapseIcon.classList.remove('rotated');
                }
            }
        } else {
            document.getElementById('daily-empty').style.display = 'flex';
            document.getElementById('daily-content').style.display = 'none';
        }
    }
    function doDailyCheckIn() {
        const btn = document.querySelector('.daily-btn');
        btn.disabled = true;
        document.getElementById('daily-loading').style.display = 'block';
        setTimeout(() => {
            const n1 = Math.floor(Math.random() * 8) + 1;
            const n2 = Math.floor(Math.random() * 8) + 1;
            const code = `${n1}_${n2}`;
            const today = new Date().toISOString().split('T')[0];
            const data = { date: today, checked: true, code: code };
            localStorage.setItem('os_daily_card', JSON.stringify(data));
            renderDailyContent(code);
            document.getElementById('daily-loading').style.display = 'none';
        }, 800);
    }
    function renderDailyContent(code) {
        document.getElementById('daily-empty').style.display = 'none';
        const box = document.getElementById('daily-content');
        box.style.display = 'flex'; // ç¡®ä¿ä¸»å®¹å™¨å¯è§
        
        // æ¸²æŸ“å†…å®¹
        document.getElementById('daily-symbol-text').innerText = HEXAGRAM_SYMBOLS[code] || "â˜¯";
        document.getElementById('daily-gua-name').innerText = HEXAGRAM_DATA[code] || "æœªçŸ¥å¦";
        document.getElementById('daily-gua-tip').innerHTML = getGuaTip(code);

        // é‡æ–°åº”ç”¨ä¿å­˜çš„æŠ˜å çŠ¶æ€ï¼Œä»¥é˜²åœ¨åŒä¸€ä¼šè¯ä¸­ç­¾åˆ°åçŠ¶æ€ä¸¢å¤±
        const isCollapsed = localStorage.getItem('os_daily_content_collapsed') === 'true';
        const contentArea = document.getElementById('daily-collapsible-area');
        const collapseIcon = document.getElementById('daily-collapse-icon');
        if (contentArea && collapseIcon) {
            if (isCollapsed) {
                contentArea.classList.add('collapsed');
                collapseIcon.classList.add('rotated');
            } else {
                contentArea.classList.remove('collapsed');
                collapseIcon.classList.remove('rotated');
            }
        }
    }

    // --- Data Management & AI Formatting ---
    function exportData() { const allData = {}; for (let i = 0; i < localStorage.length; i++){ const key = localStorage.key(i); if (key.startsWith('os_')) { allData[key] = localStorage.getItem(key); } } const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const date = new Date().toISOString().slice(0, 10); a.download = `lingxi_os_backup_${date}.json`; a.click(); URL.revokeObjectURL(url); alert('å¤‡ä»½æ–‡ä»¶å·²å¼€å§‹ä¸‹è½½ï¼'); }
    function handleImport(files) { if (!files.length) return; const file = files[0]; const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); if (confirm('è¿™å°†è¦†ç›–æ‰€æœ‰å½“å‰æ•°æ®ï¼Œç¡®å®šè¦ä»æ–‡ä»¶æ¢å¤å—ï¼Ÿ')) { Object.keys(data).forEach(key => { if (key.startsWith('os_')) { localStorage.setItem(key, data[key]); } }); alert('æ•°æ®æ¢å¤æˆåŠŸï¼åº”ç”¨å³å°†åˆ·æ–°ã€‚'); location.reload(); } } catch (err) { alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–å·²æŸåã€‚'); } }; reader.readAsText(file); }
    function escapeHTML(str) { if (!str) return ''; return str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m]));}
    function formatAIResponse(text) { return escapeHTML(text).replace(/\n/g, '<br>'); }
    
    // --- Global & API Settings ---
    function saveMasterPrompt() { localStorage.setItem('os_master_prompt', document.getElementById('master-prompt-input').value); alert('å…¨å±€æŒ‡ä»¤å·²ä¿å­˜'); }
    function loadMasterPrompt() { document.getElementById('master-prompt-input').value = localStorage.getItem('os_master_prompt') || ''; }
    async function fetchModels() { const url = (document.getElementById('cfg-url').value || "https://api.openai.com/v1").replace(/\/$/,""); const key = document.getElementById('cfg-key').value; const btn = document.getElementById('btn-fetch'); if(!key) return alert('è¯·è¾“å…¥ API Key'); btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ‹‰å–ä¸­...'; try { const res = await fetch(url+'/models', {headers:{'Authorization':`Bearer ${key}`}}); const data = await res.json(); const models = data.data || data; if (!Array.isArray(models)) { const errorMsg = data.error ? data.error.message : JSON.stringify(data); throw new Error(`APIæœªè¿”å›æœ‰æ•ˆçš„æ¨¡å‹åˆ—è¡¨ã€‚æœåŠ¡å™¨å“åº”: ${errorMsg}`); } const sel = document.getElementById('cfg-model'); sel.innerHTML = ''; models.forEach(m => sel.innerHTML += `<option value="${m.id}">${m.id}</option>`); alert(`æˆåŠŸè·å– ${models.length} ä¸ªæ¨¡å‹ï¼`); } catch(e) { alert('æ‹‰å–å¤±è´¥: ' + e.message); } finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-sync"></i> æ‹‰å–æ¨¡å‹åˆ—è¡¨'; } }
    function saveConfig() { localStorage.setItem('os_url', document.getElementById('cfg-url').value); localStorage.setItem('os_key', document.getElementById('cfg-key').value); localStorage.setItem('os_model', document.getElementById('cfg-model').value); alert('API é…ç½®å·²ä¿å­˜'); }
    function loadConfig() { document.getElementById('cfg-url').value = localStorage.getItem('os_url') || ''; document.getElementById('cfg-key').value = localStorage.getItem('os_key') || ''; const savedModel = localStorage.getItem('os_model'); if(savedModel) document.getElementById('cfg-model').innerHTML = `<option>${savedModel}</option>`; }
    
    // --- Character App ---
    function openCharForm(char = null) { const modal = document.getElementById('char-form-modal'); const idInput = document.getElementById('char-form-id'); const nameInput = document.getElementById('char-form-name'); const descInput = document.getElementById('char-form-desc'); const title = document.getElementById('char-form-title'); if (char) { title.innerText = 'ç¼–è¾‘è§’è‰²'; idInput.value = char.id; nameInput.value = char.name; descInput.value = char.desc; } else { title.innerText = 'æ–°å»ºè§’è‰²'; idInput.value = ''; nameInput.value = ''; descInput.value = ''; } modal.style.display = 'block'; }
    function closeCharForm() { document.getElementById('char-form-modal').style.display = 'none'; }
    function saveChar() { const id = document.getElementById('char-form-id').value; const name = document.getElementById('char-form-name').value.trim(); if (!name) return alert('è§’è‰²åä¸èƒ½ä¸ºç©º'); const desc = document.getElementById('char-form-desc').value.trim(); let roles = JSON.parse(localStorage.getItem('os_chars') || '[]'); if (id) { roles = roles.map(role => role.id == id ? { ...role, name, desc } : role ); } else { roles.push({ id: Date.now(), name, desc }); } localStorage.setItem('os_chars', JSON.stringify(roles)); renderCharList(); closeCharForm(); }
    function renderCharList() { const div = document.getElementById('char-list'); if (!div) return; div.innerHTML = ''; JSON.parse(localStorage.getItem('os_chars')||'[]').forEach(r => { div.innerHTML += `<div class="card" style="display:flex; justify-content:space-between; align-items:center;"><div><b>${r.name}</b><br><small>${r.desc}</small></div><i class="fas fa-edit" style="cursor:pointer; color:var(--accent-color);" onclick='editChar(${r.id})'></i></div>`; }); }
    function editChar(id) { const roles = JSON.parse(localStorage.getItem('os_chars') || '[]'); const char = roles.find(r => r.id === id); if (char) openCharForm(char); }
    
        // --- I-Ching Divination App ---
    function showYijingMenu() { document.getElementById('yijing-menu').style.display = 'grid'; document.getElementById('yijing-input-2').style.display = 'none'; document.getElementById('yijing-input-3').style.display = 'none'; }
    function showNumberInput() { document.getElementById('yijing-menu').style.display = 'none'; document.getElementById('yijing-input-2').style.display = 'block'; }
    function showThreeNumberInput() { document.getElementById('yijing-menu').style.display = 'none'; document.getElementById('yijing-input-3').style.display = 'block'; }
    
    function processDivination(type, q) {
        let up, low, dong, methodDesc;
        if (type === 'random') {
            const n1 = Math.floor(Math.random() * 900) + 100; const n2 = Math.floor(Math.random() * 900) + 100; up = n1 % 8 || 8; low = n2 % 8 || 8; dong = (n1 + n2) % 6 || 6; methodDesc = `éšæœºæ•°: ${n1},${n2}`;
        } else if (type === 'time') {
            const now = new Date(); const year = now.getFullYear(); const month = now.getMonth() + 1; const day = now.getDate(); const hour = now.getHours(); const numUpper = year + month + day; const numLower = numUpper + hour; up = numUpper % 8 || 8; low = numLower % 8 || 8; dong = (numUpper + numLower) % 6 || 6; methodDesc = `æ—¶é—´: ${month}æœˆ${day}æ—¥${hour}æ—¶`;
        }
        const rec = {id:Date.now(), time:new Date().toLocaleString(), q, up, low, dong, methodDesc, note:"", aiInterpret:"", aiEvaluate:""}; const list = JSON.parse(localStorage.getItem('os_yijing')||'[]'); list.unshift(rec); localStorage.setItem('os_yijing', JSON.stringify(list)); showYijingMenu(); renderYijingHistory(); openDetail(rec.id);
    }

    function startDivination(type) { 
        if (type === 'number2') {
            const q = document.getElementById('yijing-q-2').value.trim(); const n1 = parseInt(document.getElementById('yijing-n1').value); const n2 = parseInt(document.getElementById('yijing-n2').value); if (!q) return alert('è¯·å¡«å†™æ‰€å ä½•äº‹'); if (!n1 || !n2) return alert('è¯·å¡«å†™æ•°å­—'); const up = n1 % 8 || 8; const low = n2 % 8 || 8; const dong = (n1 + n2) % 6 || 6; const methodDesc = `æ•°: ${n1},${n2}`; const rec = {id:Date.now(), time:new Date().toLocaleString(), q, up, low, dong, methodDesc, note:"", aiInterpret:"", aiEvaluate:""}; const list = JSON.parse(localStorage.getItem('os_yijing')||'[]'); list.unshift(rec); localStorage.setItem('os_yijing', JSON.stringify(list)); showYijingMenu(); renderYijingHistory(); openDetail(rec.id); 
        } else if (type === 'number3') {
            const q = document.getElementById('yijing-q-3').value.trim(); const n1 = parseInt(document.getElementById('yijing-n3-1').value); const n2 = parseInt(document.getElementById('yijing-n3-2').value); const n3 = parseInt(document.getElementById('yijing-n3-3').value); if (!q) return alert('è¯·å¡«å†™æ‰€å ä½•äº‹'); if (!n1 || !n2 || !n3) return alert('è¯·å¡«å†™æ‰€æœ‰ä¸‰ä¸ªæ•°å­—'); const up = n1 % 8 || 8; const low = n2 % 8 || 8; const dong = n3 % 6 || 6; const methodDesc = `ä¸‰æ•°: ${n1},${n2},${n3}`; const rec = {id:Date.now(), time:new Date().toLocaleString(), q, up, low, dong, methodDesc, note:"", aiInterpret:"", aiEvaluate:""}; const list = JSON.parse(localStorage.getItem('os_yijing')||'[]'); list.unshift(rec); localStorage.setItem('os_yijing', JSON.stringify(list)); showYijingMenu(); renderYijingHistory(); openDetail(rec.id); 
        } else if (type === 'random') { openCustomPrompt("ã€éšæœºèµ·å¦ã€‘å¿ƒä¸­æ‰€å ä½•äº‹ï¼Ÿ", "ä¾‹å¦‚ï¼šä»Šæ—¥è¿åŠ¿...", (val) => { if (val) processDivination('random', val); }); } else if (type === 'time') { openCustomPrompt("ã€æ—¶é—´èµ·å¦ã€‘å¿ƒä¸­æ‰€å ä½•äº‹ï¼Ÿ", "ä¸å¡«åˆ™é»˜è®¤ä¸ºé—®æ—¶", (val) => { if (val !== null) { const q = val === "" ? `é—®æ—¶: ${new Date().toLocaleString()}` : val; processDivination('time', q); } }); }
    }
    function renderGuaResult(content, type) { if (!content) return ''; return `<button class="toggle-btn" onclick="toggleCollapsible(this)"><span>${type === 'interpret' ? 'è§£å¦åˆ†æ' : 'AI è¯„ä»·'}</span><i class="fas fa-chevron-down"></i></button><div class="content expanded">${formatAIResponse(content)}</div>`; }
    function toggleCollapsible(btn) { const content = btn.nextElementSibling; const icon = btn.querySelector('.fas'); content.classList.toggle('expanded'); if (content.classList.contains('expanded')) { icon.style.transform = "rotate(0deg)"; } else { icon.style.transform = "rotate(-90deg)"; } }
    function openDetail(id) { currentYijingId = id; const rec = JSON.parse(localStorage.getItem('os_yijing')).find(r => r.id===id); document.getElementById('yijing-detail').style.display = 'flex'; document.getElementById('yijing-home').style.display = 'none'; document.getElementById('detail-q').innerText = rec.q; document.getElementById('detail-meta').innerText = `${rec.methodDesc} | åŠ¨: ${rec.dong}`; const sel = document.getElementById('detail-role'); sel.innerHTML = '<option value="">é»˜è®¤AI</option>'; JSON.parse(localStorage.getItem('os_chars')||'[]').forEach(r => sel.innerHTML += `<option value='${JSON.stringify(r)}'>${r.name}</option>`); document.getElementById('detail-note').value = rec.note || ''; document.getElementById('ai-interpret-res').innerHTML = renderGuaResult(rec.aiInterpret, 'interpret'); document.getElementById('ai-evaluate-res').innerHTML = renderGuaResult(rec.aiEvaluate, 'evaluate'); drawGua(rec.up, rec.low, rec.dong); }
    function closeDetail() { document.getElementById('yijing-detail').style.display='none'; document.getElementById('yijing-home').style.display='block'; currentYijingId=null; }
    
    function drawGua(upVal, lowVal, dongIdx) {
        const benFull = [...trigramBits[upVal], ...trigramBits[lowVal]];
        const huUpBits = [benFull[1], benFull[2], benFull[3]], huLowBits = [benFull[2], benFull[3], benFull[4]];
        const huUpVal = findTrigramVal(huUpBits), huLowVal = findTrigramVal(huLowBits);
        const changeBitIdx = 6 - dongIdx;
        const bianFull = [...benFull];
        bianFull[changeBitIdx] = 1 - bianFull[changeBitIdx];
        const bianUpVal = findTrigramVal(bianFull.slice(0,3)), bianLowVal = findTrigramVal(bianFull.slice(3,6));
        const benName = HEXAGRAM_DATA[`${upVal}_${lowVal}`] || 'æœªçŸ¥';
                const huName = HEXAGRAM_DATA[`${huUpVal}_${huLowVal}`] || 'æœªçŸ¥';
        const bianName = HEXAGRAM_DATA[`${bianUpVal}_${bianLowVal}`] || 'æœªçŸ¥';
        document.getElementById('detail-gua-area').innerHTML = `
            <div class="gua-visual-row">
                <div class="gua-col" onclick="promptYijingCharSelection('${benName}')">
                    <div class="gua-title">æœ¬å¦ (åŠ¨)</div>
                    <div class="gua-lines-box">${renderLinesHtml(benFull, dongIdx, benName)}</div>
                    <div class="gua-name">${benName}</div>
                </div>
                <div class="gua-col" onclick="promptYijingCharSelection('${huName}')">
                    <div class="gua-title">äº’å¦</div>
                    <div class="gua-lines-box">${renderLinesHtml([...huUpBits,...huLowBits], -1, "")}</div>
                    <div class="gua-name">${huName}</div>
                </div>
                <div class="gua-col" onclick="promptYijingCharSelection('${bianName}')">
                    <div class="gua-title">å˜å¦</div>
                    <div class="gua-lines-box">${renderLinesHtml(bianFull, 0, "", true)}</div>
                    <div class="gua-name" style="color:#ff3b30">${bianName}</div>
                </div>
            </div>`;
    }

    function renderLinesHtml(bits, moveLine, guaName, isBianGua = false) { 
        let html = ''; 
        bits.forEach((bit, i) => { 
            const lineNum = 6 - i; 
            const isMoving = (lineNum === moveLine); 
            const type = bit === 1 ? 'yang' : 'yin'; 
            let moveClass = '';
            let clickAttr = '';
            if (isMoving && !isBianGua) {
                moveClass = 'moving';
                clickAttr = `onclick="event.stopPropagation(); openYaoModal('${guaName}', ${lineNum}, ${bit})"`;
            }
            const content = bit === 1 ? '' : '<span></span><span></span>'; 
            html += `<div class="line ${type} ${moveClass}" ${clickAttr}>${content}</div>`; 
        }); 
        return html; 
    }

    function findTrigramVal(arr) { const str = arr.join(''); for(let k in trigramBits) { if(trigramBits[k].join('') === str && k!=='0') return parseInt(k); } return 8; }
    function toggleYijingEditMode() { isYijingEditMode = !isYijingEditMode; document.getElementById('yijing-batch-toolbar').style.display = isYijingEditMode ? 'flex' : 'none'; document.getElementById('btn-edit-yijing').innerText = isYijingEditMode ? 'å®Œæˆ' : 'ç®¡ç†'; renderYijingHistory(); }
    function renderYijingHistory() { const div = document.getElementById('yijing-history'); div.innerHTML = ''; const data = JSON.parse(localStorage.getItem('os_yijing')||'[]'); if(data.length===0) { div.innerHTML = '<div style="text-align:center;color:var(--text-sub);padding:10px;">æš‚æ— è®°å½•</div>'; return; } data.forEach(item => { if (isYijingEditMode) { div.innerHTML += `<div class="check-wrap"><input type="checkbox" class="yijing-check" value="${item.id}"><div class="check-content">${item.q} <br><small>${item.time.split(' ')[0]}</small></div></div>`; } else { div.innerHTML += `<div onclick="openDetail(${item.id})" style="padding:12px 0; border-bottom:1px solid var(--border-color);cursor:pointer;">${item.q} <small style="float:right;"><i class="fas fa-chevron-right"></i></small></div>`; } }); }
    function deleteSelectedYijing() { const checks = document.querySelectorAll('.yijing-check:checked'); if (checks.length === 0) return alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è®°å½•'); if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${checks.length} æ¡è®°å½•å—ï¼Ÿ`)) { const idsToDelete = Array.from(checks).map(c => parseInt(c.value)); let history = JSON.parse(localStorage.getItem('os_yijing') || '[]'); history = history.filter(item => !idsToDelete.includes(item.id)); localStorage.setItem('os_yijing', JSON.stringify(history)); toggleYijingEditMode(); } }
    async function callAI(mode) { const key = localStorage.getItem('os_key'); if(!key) return alert('è¯·é…ç½®Key'); const btn = mode==='interpret' ? document.getElementById('btn-interpret') : document.getElementById('btn-evaluate'); const targetDiv = mode==='interpret' ? document.getElementById('ai-interpret-res') : document.getElementById('ai-evaluate-res'); btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ€è€ƒä¸­...'; targetDiv.style.display = 'block'; targetDiv.innerHTML = "æ­£åœ¨è¿æ¥AIï¼Œè¯·ç¨å€™..."; try { const list = JSON.parse(localStorage.getItem('os_yijing')); const rec = list.find(r=>r.id===currentYijingId); const url = (localStorage.getItem('os_url') || "https://api.openai.com/v1").replace(/\/$/,''); const model = localStorage.getItem('os_model') || "gpt-3.5-turbo"; const benFull=[...trigramBits[rec.up],...trigramBits[rec.low]]; const huUpBits=[benFull[1],benFull[2],benFull[3]],huLowBits=[benFull[2],benFull[3],benFull[4]]; const huUpVal=findTrigramVal(huUpBits),huLowVal=findTrigramVal(huLowBits); const changeBitIdx=6-rec.dong; const bianFull=[...benFull];bianFull[changeBitIdx]=1-bianFull[changeBitIdx]; const bianUpVal=findTrigramVal(bianFull.slice(0,3)),bianLowVal=findTrigramVal(bianFull.slice(3,6)); const benName=HEXAGRAM_DATA[`${rec.up}_${rec.low}`],huName=HEXAGRAM_DATA[`${huUpVal}_${huLowVal}`],bianName=HEXAGRAM_DATA[`${bianUpVal}_${bianLowVal}`]; let userPrompt; const promptHeader=`ã€æ¢…èŠ±æ˜“æ•°æ’ç›˜ç»“æœã€‘\næ‰€å ä¹‹äº‹ï¼š${rec.q}\nèµ·å¦æ–¹å¼ï¼š${rec.methodDesc || 'æ•°å­—èµ·å¦'}\næœ¬å¦ï¼š${benName}(ç¬¬ ${rec.dong} çˆ»åŠ¨)\näº’å¦ï¼š${huName}\nå˜å¦ï¼š${bianName}\n\n`; if(mode==='interpret'){ userPrompt=promptHeader+"è¯·æ ¹æ®ä»¥ä¸Šå®Œæ•´çš„å¦è±¡ä¿¡æ¯ä¸ºæˆ‘è¯¦ç»†è§£è¯»ã€‚"; }else{ const note=document.getElementById('detail-note').value; if(!note)throw new Error("è¯·å…ˆå¡«å†™æ‚¨çš„ç¬”è®°ã€‚"); userPrompt=promptHeader+`ã€æˆ‘çš„ç¬”è®°ã€‘\n"${note}"\n\nè¯·ä½œä¸ºè€å¸ˆï¼ŒåŸºäºå®Œæ•´çš„å¦è±¡ä¿¡æ¯ï¼Œç‚¹è¯„æˆ‘çš„ç¬”è®°æ˜¯å¦å‡†ç¡®ï¼Ÿ`; } const masterPrompt = localStorage.getItem('os_master_prompt') || ''; let rolePrompt = "ä½ æ˜¯ä¸€ä½ç²¾é€šæ¢…èŠ±æ˜“æ•°çš„å›½å­¦å¤§å¸ˆã€‚"; const roleJSON=document.getElementById('detail-role').value; if(roleJSON){ const r=JSON.parse(roleJSON); rolePrompt=`è¯·ä¸¥æ ¼æ‰®æ¼”ä»¥ä¸‹è§’è‰²ï¼š\nã€è§’è‰²åã€‘: ${r.name}\nã€è§’è‰²è®¾å®šã€‘: ${r.desc}\nç”¨è¿™ä¸ªè§’è‰²çš„å£å»å’ŒçŸ¥è¯†èƒŒæ™¯æ¥å›ç­”ã€‚`; } const finalSystemPrompt = masterPrompt ? `${masterPrompt}\n\n---\n\n${rolePrompt}` : rolePrompt; const res=await fetch(url+'/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${key}`},body:JSON.stringify({model,messages:[{role:"system",content:finalSystemPrompt},{role:"user",content:userPrompt}]})}); if(!res.ok)throw new Error(`API è¯·æ±‚å¤±è´¥: ${res.status}`); const data=await res.json(); if(data.error)throw new Error(data.error.message); const reply=data.choices[0].message.content; targetDiv.innerHTML = renderGuaResult(reply, mode); const idx=list.findIndex(r=>r.id===currentYijingId); if(mode==='interpret')list[idx].aiInterpret=reply; else list[idx].aiEvaluate=reply; localStorage.setItem('os_yijing',JSON.stringify(list));} catch(e){ targetDiv.innerText="è¯·æ±‚å‡ºé”™ï¼š"+e.message; } finally { btn.disabled=false; btn.innerHTML=mode==='interpret'?'è¯·å¤§å¸ˆæŒ‡ç‚¹':'è®© AI è¯„ä»·'; }}
    function saveNote() { const list=JSON.parse(localStorage.getItem('os_yijing')); const idx=list.findIndex(r=>r.id===currentYijingId); list[idx].note = document.getElementById('detail-note').value; localStorage.setItem('os_yijing', JSON.stringify(list)); alert('ç¬”è®°å·²ä¿å­˜'); }
    
    function openYaoModal(guaName, lineNum, bitVal) {
        const modal = document.getElementById('yao-detail-overlay');
        const titleEl = document.getElementById('yao-detail-title');
        const subEl = document.getElementById('yao-detail-subtitle');
        const contentEl = document.getElementById('yao-detail-content');
        const positionNames = ["", "åˆ", "äºŒ", "ä¸‰", "å››", "äº”", "ä¸Š"];
        const yinYang = bitVal === 1 ? "ä¹" : "å…­";
        let yaoName = "";
        if (lineNum === 1 || lineNum === 6) { yaoName = `${positionNames[lineNum]}${yinYang}`; } else { yaoName = `${yinYang}${positionNames[lineNum]}`; }
        titleEl.innerText = `${guaName}`;
        subEl.innerText = `ã€${yaoName}ã€‘ åŠ¨çˆ»è¯¦è§£`;
        contentEl.innerHTML = `<div style="text-align:center; color:var(--text-sub); margin-top:30px;"><i class="fas fa-book-reader" style="font-size:24px; margin-bottom:10px;"></i><br>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è¯·æ±‚ AI è§£æ<br><small>è·å–ã€Š${guaName}ã€‹${yaoName} çš„çˆ»è¾ä¸ç¿»è¯‘</small></div>`;
        currentYaoRequest = { guaName, yaoName };
        modal.classList.add('show');
    }

    function closeYaoDetail() { document.getElementById('yao-detail-overlay').classList.remove('show'); currentYaoRequest = null; }
    
        async function fetchYaoText() {
        if (!currentYaoRequest) return;
        const { guaName, yaoName } = currentYaoRequest;
        const contentEl = document.getElementById('yao-detail-content');
        const btn = document.getElementById('btn-fetch-yao');
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è§£æä¸­...';
        contentEl.innerHTML = '<div style="text-align:center; margin-top:20px;">æ­£åœ¨æŸ¥é˜…å¤ç±...</div>';
        const key = localStorage.getItem('os_key');
        if (!key) { alert('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Key'); btn.disabled = false; btn.innerHTML = 'ğŸ“œ AI è§£ææ­¤çˆ»'; return; }
        try {
            const url = (localStorage.getItem('os_url') || "https://api.openai.com/v1").replace(/\/$/,'');
            const model = localStorage.getItem('os_model') || "gpt-3.5-turbo";
            const prompt = `è¯·ç›´æ¥ç»™å‡ºæ˜“ç»ä¸­ã€${guaName}ã€‘çš„ã€${yaoName}ã€‘çš„ï¼š\n1. çˆ»è¾åŸæ–‡\n2. è±¡æ›°åŸæ–‡\n3. ç®€ç»ƒçš„ç™½è¯ç¿»è¯‘\n4. å¯¹å åœçš„ç®€çŸ­å¯ç¤ºï¼ˆå‰å‡¶å»ºè®®ï¼‰ã€‚\n\nè¯·ç”¨HTMLæ ¼å¼è¿”å›ï¼Œä½¿ç”¨<b>åŠ ç²—</b>åŸæ–‡ï¼Œåˆ†æ®µæ˜¾ç¤ºï¼Œä¸è¦å•°å—¦ã€‚`;
            const res = await fetch(url+'/chat/completions', { method: 'POST', headers: {'Content-Type':'application/json', 'Authorization':`Bearer ${key}`}, body: JSON.stringify({ model: model, messages: [{role: "user", content: prompt}] }) });
            if (!res.ok) throw new Error("ç½‘ç»œè¯·æ±‚å¤±è´¥: " + res.status);
            const data = await res.json();
            const text = data.choices[0].message.content;
            contentEl.innerHTML = text.replace(/\n/g, '<br>');
        } catch (e) {
            contentEl.innerText = "è§£æå¤±è´¥ï¼š" + e.message;
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'ğŸ“œ é‡æ–°è§£æ';
        }
    }

    // --- NEW: Yijing AI Character Selection & Chat ---

    function promptYijingCharSelection(guaName) {
        currentGuaForSelection = guaName;
        const modal = document.getElementById('yijing-char-select-overlay');
        const listDiv = document.getElementById('yijing-char-list');
        listDiv.innerHTML = ''; 

        // Add Default AI option
        listDiv.innerHTML += `<div class="modal-list-item" onclick="selectYijingChar(null)"><div>é»˜è®¤AI (çµçŠ€)</div><small>å‹å¥½ã€è½»æ¾çš„æ˜“ç»ä¼™ä¼´</small></div>`;

        // Add characters from storage
        const chars = JSON.parse(localStorage.getItem('os_chars') || '[]');
        chars.forEach(char => {
            listDiv.innerHTML += `<div class="modal-list-item" onclick="selectYijingChar(${char.id})"><div>${escapeHTML(char.name)}</div><small>${escapeHTML(char.desc.substring(0, 25))}${char.desc.length > 25 ? '...' : ''}</small></div>`;
        });
        modal.classList.add('show');
    }

    function selectYijingChar(charId) {
        let selectedChar = null;
        if (charId !== null) {
            const chars = JSON.parse(localStorage.getItem('os_chars') || '[]');
            selectedChar = chars.find(c => c.id === charId);
        }
        document.getElementById('yijing-char-select-overlay').classList.remove('show');
        openYijingChat(currentGuaForSelection, selectedChar);
    }
    
    function openYijingChat(guaName, character = null) {
        currentYijingChatInfo = { guaName, character };
        yijingChatHistory = [];
        const charName = character ? character.name : 'çµçŠ€';
        document.getElementById('yijing-chat-title').innerText = `ä¸ ${charName} æ¢è®¨ã€${guaName}ã€‘`;
        document.getElementById('app-yijing-chat').style.display = 'flex';
        const feed = document.getElementById('yijing-chat-feed');
        feed.innerHTML = '';

        const initialMessages = [
            `ä½ å¥½å‘€ï¼æˆ‘æ˜¯${charName}ï¼Œæˆ‘ä»¬æ¥èŠèŠã€Œ${guaName}ã€è¿™ä¸ªå¦å§ï¼`,
            "æœ‰ä»€ä¹ˆæƒ³çŸ¥é“çš„ï¼Œéšæ—¶é—®æˆ‘ï¼"
        ];
        
        let delay = 500;
        initialMessages.forEach(msg => {
            setTimeout(() => {
                const bubble = createYijingChatBubble('ai', msg);
                yijingChatHistory.push({role: 'assistant', content: msg});
            }, delay);
            delay += 800;
        });
    }

    function closeYijingChat() {
        document.getElementById('app-yijing-chat').style.display = 'none';
        currentYijingChatInfo = {};
        yijingChatHistory = [];
    }

    function createYijingChatBubble(type, text = '') {
        const feed = document.getElementById('yijing-chat-feed');
        const div = document.createElement('div');
        div.className = `chat-bubble ${type}`;
        if (text) {
            div.innerHTML = formatAIResponse(text);
        }
        feed.appendChild(div);
        feed.scrollTop = feed.scrollHeight;
        return div;
    }

    async function sendYijingChatMessage() {
        if(isAIResponding) return;
        const input = document.getElementById('yijing-chat-input');
        const text = input.value.trim();
        if(!text) return;

        createYijingChatBubble('user', text);
        yijingChatHistory.push({role: 'user', content: text});
        input.value = '';
        triggerYijingAIStream();
    }

    async function triggerYijingAIStream() {
        const key = localStorage.getItem('os_key');
        if(!key) { createYijingChatBubble('ai', 'æŠ±æ­‰ï¼Œéœ€è¦å…ˆåœ¨è®¾ç½®é‡Œé…ç½®API Keyæ‰èƒ½èŠå¤©å“¦ã€‚'); return; }
        
        isAIResponding = true;
        document.getElementById('btn-yijing-chat-send').disabled = true;
        const thinkingBubble = createYijingChatBubble('ai thinking', 'æ­£åœ¨æ€è€ƒ...');

        try {
            const { guaName, character } = currentYijingChatInfo;
            let personaPrompt;
            if (character) {
                personaPrompt = `ä½ æ­£åœ¨æ‰®æ¼”è§’è‰²ã€${character.name}ã€‘ã€‚è§’è‰²è®¾å®šï¼š${character.desc}ã€‚ä½ çš„ä»»åŠ¡æ˜¯ä»¥è¿™ä¸ªè§’è‰²çš„å£å»å’Œæ€§æ ¼ï¼Œä¸ç”¨æˆ·è½»æ¾åœ°æ¢è®¨å…³äºã€${guaName}ã€‘å¦çš„é—®é¢˜ã€‚`;
            } else {
                personaPrompt = `ä½ æ˜¯ä¸€ä¸ªåå«â€œçµçŠ€â€çš„æ˜“ç»çˆ±å¥½è€…å’Œæœ‹å‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯ä»¥è½»æ¾ã€å‹å¥½ã€å¯¹è¯å¼çš„æ–¹å¼ï¼Œè§£é‡Šç”¨æˆ·å…³äºã€${guaName}ã€‘å¦çš„é—®é¢˜ã€‚`;
            }

            const systemPrompt = `${personaPrompt}
            ã€è¾“å‡ºè§„åˆ™ã€‘:
            1. **é£æ ¼**: åƒå’Œæœ‹å‹èŠå¤©ä¸€æ ·ï¼Œäº²åˆ‡è‡ªç„¶ï¼Œé¿å…ä½¿ç”¨å¤æ‚çš„æœ¯è¯­ã€‚
            2. **çŸ­å¥**: å¿…é¡»æŠŠä½ çš„å›ç­”åˆ†è§£æˆå¤šä¸ªéå¸¸ç®€çŸ­çš„å¥å­æˆ–æ®µè½ï¼ˆæ¯æ®µ1-3å¥è¯ï¼‰ã€‚
            3. **åˆ†éš”ç¬¦**: åœ¨æ¯æ¡çŸ­æ¶ˆæ¯çš„æœ«å°¾ï¼Œå¿…é¡»ä½¿ç”¨ç‰¹æ®Šåˆ†éš”ç¬¦ \`[MSG_BREAK]\`ã€‚
            4. **æ•°é‡**: æ¯æ¬¡å›ç­”ç”Ÿæˆ 1 åˆ° 10 æ¡ç”± \`[MSG_BREAK]\` åˆ†éš”çš„çŸ­æ¶ˆæ¯ã€‚
            5. **ç¦æ­¢**: ä¸è¦è¾“å‡ºä»»ä½• markdown è¯­æ³•ã€åˆ—è¡¨æˆ–åŠ ç²—ã€‚ä¿æŒçº¯æ–‡æœ¬å¯¹è¯ã€‚`;
            
            const messages = [{role: "system", content: systemPrompt}, ...yijingChatHistory];
            const url = (localStorage.getItem('os_url') || "https://api.openai.com/v1").replace(/\/$/,'');
            const model = localStorage.getItem('os_model') || "gpt-3.5-turbo";
            
            const res = await fetch(url + '/chat/completions', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` }, body: JSON.stringify({ model, messages, stream: true }) });

            if (!res.ok) throw new Error(`API è¯·æ±‚å¤±è´¥: ${res.status}`);
            
            thinkingBubble.remove();
            const reader = res.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let fullReply = "";

            while (true) {
                const { done, value } = await reader.read(); if (done) break;
                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const jsonStr = line.slice(6); if (jsonStr === '[DONE]') break;
                        try {
                            const json = JSON.parse(jsonStr);
                            fullReply += json.choices[0].delta.content || "";
                        } catch (e) { /* ignore */ }
                    }
                }
            }
            
                        const replyMessages = fullReply.split('[MSG_BREAK]').filter(m => m.trim() !== '');
            
            function showMessage(index) {
                if (index >= replyMessages.length) {
                    isAIResponding = false;
                    document.getElementById('btn-yijing-chat-send').disabled = false;
                    return;
                }
                const msgText = replyMessages[index].trim();
                createYijingChatBubble('ai', msgText);
                yijingChatHistory.push({ role: 'assistant', content: msgText });
                const delay = msgText.length < 20 ? 700 : 1200;
                setTimeout(() => showMessage(index + 1), delay);
            }
            showMessage(0);

        } catch (e) {
            thinkingBubble.remove();
            createYijingChatBubble('ai', `å“å‘€ï¼Œå‡ºé”™äº†: ${e.message}`);
            isAIResponding = false;
            document.getElementById('btn-yijing-chat-send').disabled = false;
        }
    }
    
    // --- Diary App (REFACTORED) ---
    function updateDiaryRolePicker() { /* This is now handled by the getAIReply logic */ }
    
    function insertDiaryTimestamp() {
        const input = document.getElementById('diary-input');
        const now = new Date();
        const timeString = `\n[${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}] `;
        input.value += timeString;
        input.focus();
    }

    function saveUserDiary() {
        const text = document.getElementById('diary-input').value.trim();
        if(!text) return;
        saveDiaryEntry('user', text, 'æˆ‘', new Date().toISOString().split('T')[0], Date.now());
        document.getElementById('diary-input').value = '';
        alert("æ—¥è®°å·²ä¿å­˜");
    }

    function saveDiaryEntry(type, text, name, date, id, replyTo = null) {
        const list = JSON.parse(localStorage.getItem('os_diary')||'[]');
        list.unshift({id, type, text, name, date, replyTo});
        localStorage.setItem('os_diary', JSON.stringify(list));
        renderDiaryFeed();
    }

    async function getAIReply(diaryId, btnElement) {
        const key = localStorage.getItem('os_key');
        if(!key) return alert('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®API Key');

        const diaryList = JSON.parse(localStorage.getItem('os_diary')||'[]');
        const diaryEntry = diaryList.find(d => d.id === diaryId);
        if(!diaryEntry) return alert('æ‰¾ä¸åˆ°è¯¥æ—¥è®°æ¡ç›®');

        const statusDiv = document.getElementById('diary-status');
        btnElement.disabled = true;
        btnElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AIå›åº”ä¸­...';
        statusDiv.style.display = 'block';
        statusDiv.innerText = 'æ­£åœ¨è¿æ¥AI...';
        
        try {
            openApp('app-chars'); // Temporarily open and close to get role picker
            const roleSelect = document.createElement('select');
            roleSelect.innerHTML = '<option value="">é»˜è®¤AI</option>';
            JSON.parse(localStorage.getItem('os_chars')||'[]').forEach(r => {
                roleSelect.innerHTML += `<option value='${JSON.stringify(r)}'>${r.name}</option>`;
            });
            closeApp('app-chars');
            
            // Now ask user to select a character
            const selectedChar = await new Promise(resolve => {
                const modal = document.getElementById('yijing-char-select-overlay');
                const listDiv = document.getElementById('yijing-char-list');
                const title = modal.querySelector('h4');
                const subtitle = modal.querySelector('p');
                const originalTitle = title.innerText;
                const originalSubtitle = subtitle.innerHTML;

                title.innerText = 'é€‰æ‹©å›åº”èº«ä»½';
                subtitle.innerHTML = 'é€‰æ‹©ä¸€ä¸ªè§’è‰²æ¥å›åº”è¿™ç¯‡æ—¥è®°ã€‚';
                listDiv.innerHTML = '';
                
                const chars = JSON.parse(localStorage.getItem('os_chars') || '[]');
                
                const defaultOption = document.createElement('div');
                defaultOption.className = 'modal-list-item';
                defaultOption.innerHTML = `<div>é»˜è®¤AI (ç¬”å‹)</div><small>æ¸©æš–çš„æ—¥è®°ç¬”å‹</small>`;
                defaultOption.onclick = () => {
                    modal.classList.remove('show');
                    title.innerText = originalTitle;
                    subtitle.innerHTML = originalSubtitle;
                    resolve(null);
                };
                listDiv.appendChild(defaultOption);

                chars.forEach(char => {
                    const item = document.createElement('div');
                    item.className = 'modal-list-item';
                    item.innerHTML = `<div>${escapeHTML(char.name)}</div><small>${escapeHTML(char.desc.substring(0, 25))}${char.desc.length > 25 ? '...' : ''}</small>`;
                    item.onclick = () => {
                        modal.classList.remove('show');
                        title.innerText = originalTitle;
                        subtitle.innerHTML = originalSubtitle;
                        resolve(char);
                    };
                    listDiv.appendChild(item);
                });
                modal.classList.add('show');
            });
            
            let rolePrompt = "ä½ æ˜¯ä¸€ä½æ¸©æš–çš„æ—¥è®°ç¬”å‹ã€‚";
            let aiName = "AIç¬”å‹";
            if(selectedChar) {
                rolePrompt = `è¯·ä¸¥æ ¼æ‰®æ¼”ä»¥ä¸‹è§’è‰²æ¥å›å¤æ—¥è®°ï¼š\nã€è§’è‰²åã€‘: ${selectedChar.name}\nã€è§’è‰²è®¾å®šã€‘: ${selectedChar.desc}`;
                aiName = selectedChar.name;
            }

            const masterPrompt = localStorage.getItem('os_master_prompt') || '';
            const finalSystemPrompt = masterPrompt ? `${masterPrompt}\n\n---\n\n${rolePrompt}` : rolePrompt;
            const url = (localStorage.getItem('os_url') || "https://api.openai.com/v1").replace(/\/$/,'');
            const model = localStorage.getItem('os_model') || "gpt-3.5-turbo";
            statusDiv.innerText = `æ­£åœ¨è¿æ¥ ${model}...`;

            const res = await fetch(url+'/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({
                    model,
                    messages: [
                        {role: "system", content: finalSystemPrompt},
                        {role: "user", content: `è¿™æ˜¯æˆ‘çš„ä¸€ç¯‡æ—¥è®°ï¼Œè¯·ä½ ä»¥æœ‹å‹çš„èº«ä»½ç»™æˆ‘ä¸€äº›å›åº”ã€‚\n\n---\n${diaryEntry.text}`}
                    ]
                })
            });

            if(!res.ok) throw new Error(`API Error: ${res.status}`);
            const data = await res.json();
            if(data.error) throw new Error(data.error.message);

            saveDiaryEntry('ai', data.choices[0].message.content, aiName, new Date().toISOString().split('T')[0], Date.now(), diaryId);

        } catch(e) {
            alert('AIå›å¤å¤±è´¥: ' + e.message);
        } finally {
            btnElement.disabled = false;
            btnElement.innerHTML = 'å¯»æ±‚å›åº”';
            statusDiv.style.display = 'none';
        }
    }


    function renderDiaryFeed() {
        const div = document.getElementById('diary-feed');
        div.innerHTML = '';
        const rawData = JSON.parse(localStorage.getItem('os_diary')||'[]');
        const respondedIds = new Set(rawData.filter(d => d.type === 'ai' && d.replyTo).map(d => d.replyTo));

        const grouped = {};
        rawData.forEach(d => {
            const dateKey = d.date || 'å¾€æ—¥è®°å¿†';
            if (!grouped[dateKey]) grouped[dateKey] = [];
            grouped[dateKey].push(d);
        });

        Object.keys(grouped).sort().reverse().forEach(date => {
            const isToday = date === new Date().toISOString().split('T')[0];
            const displayDate = isToday ? `${date} (ä»Šå¤©)` : date;
            const header = document.createElement('div');
            header.className = 'diary-date-header';
            header.innerHTML = `<span><i class="fas fa-calendar-day"></i> ${displayDate}</span> <i class="fas fa-chevron-down"></i>`;
            header.onclick = function() {
                const groupDiv = this.nextElementSibling;
                const icon = this.querySelector('.fas.fa-chevron-down');
                groupDiv.classList.toggle('collapsed');
                icon.style.transform = groupDiv.classList.contains('collapsed') ? 'rotate(-90deg)' : 'rotate(0deg)';
            };
            div.appendChild(header);

            const groupDiv = document.createElement('div');
            groupDiv.className = 'diary-group';
            // Sort entries within the group by id (timestamp)
            grouped[date].sort((a,b) => b.id - a.id).forEach(d => {
                let entryHtml = `<div class="card" style="border-left:3px solid ${d.type==='user'? '#555' : 'var(--accent-color)'}"><b>${escapeHTML(d.name)}</b><br><div style="margin-top:5px;">${formatAIResponse(d.text)}</div>`;
                
                // If it's a user entry and hasn't been responded to yet
                if (d.type === 'user' && !respondedIds.has(d.id)) {
                    entryHtml += `<div class="diary-entry-actions"><button class="diary-reply-btn" onclick="getAIReply(${d.id}, this)">å¯»æ±‚å›åº”</button></div>`;
                }

                entryHtml += '</div>';
                groupDiv.innerHTML += entryHtml;
            });
            div.appendChild(groupDiv);
        });
    }

    // --- Chat App (Streaming & Actions) ---
    function migrateChatData() { const oldChat = localStorage.getItem('os_chats'); const newChat = localStorage.getItem('os_chat_sessions'); if (oldChat && !newChat) { try { const oldMessages = JSON.parse(oldChat); if (Array.isArray(oldMessages) && oldMessages.length > 0) { const sessionId = Date.now(); const sessions = {}; sessions[sessionId] = oldMessages; localStorage.setItem('os_chat_sessions', JSON.stringify(sessions)); localStorage.setItem('os_current_chat_id', sessionId); } } catch(e) { console.error("Failed to migrate chat data", e); } localStorage.removeItem('os_chats'); } }
    function getAllChatSessions() { return JSON.parse(localStorage.getItem('os_chat_sessions') || '{}'); }
    function getCurrentChatId() { return localStorage.getItem('os_current_chat_id'); }
    function updateChatRolePicker() { const sel = document.getElementById('chat-role'); sel.innerHTML = '<option value="">é»˜è®¤AI</option>'; JSON.parse(localStorage.getItem('os_chars')||'[]').forEach(r => sel.innerHTML += `<option value='${JSON.stringify(r)}'>${r.name}</option>`); }
    function createNewChatSession() { const sessions = getAllChatSessions(); const newId = Date.now(); sessions[newId] = []; localStorage.setItem('os_chat_sessions', JSON.stringify(sessions)); localStorage.setItem('os_current_chat_id', newId); renderCurrentChatHistory(); updateSessionTriggerText(); }
    
    function openSessionList() {
        const modal = document.getElementById('session-list');
        const overlay = document.getElementById('session-list-overlay');
        const sessions = getAllChatSessions();
        const currentId = getCurrentChatId();
        modal.innerHTML = '';
        const newBtn = document.createElement('div');
        newBtn.className = 'modal-list-item';
        newBtn.style.textAlign = 'center';
        newBtn.style.color = 'var(--accent-color)';
        newBtn.innerHTML = '<i class="fas fa-plus"></i> åˆ›å»ºæ–°å¯¹è¯';
        newBtn.onclick = () => { createNewChatSession(); overlay.classList.remove('show'); };
        modal.appendChild(newBtn);
        const sortedIds = Object.keys(sessions).sort((a,b) => b-a);
        sortedIds.forEach(id => {
            const firstUserMsg = sessions[id].find(m => m.type === 'user');
            const sessionName = firstUserMsg ? firstUserMsg.text.substring(0, 15) + (firstUserMsg.text.length>15?'...':'') : 'æ–°å¯¹è¯';
            const date = new Date(parseInt(id)).toLocaleString();
            const item = document.createElement('div');
            item.className = 'modal-list-item ' + (id === currentId ? 'active' : '');
            item.innerHTML = `<div>${escapeHTML(sessionName)}</div><small>${date}</small>`;
            item.onclick = () => { localStorage.setItem('os_current_chat_id', id); renderCurrentChatHistory(); updateSessionTriggerText(); overlay.classList.remove('show'); };
            modal.appendChild(item);
        });
        overlay.classList.add('show');
    }

    function updateSessionTriggerText() {
        const sessions = getAllChatSessions();
        const currentId = getCurrentChatId();
        const history = sessions[currentId] || [];
        const firstUserMsg = history.find(m => m.type === 'user');
        const sessionName = firstUserMsg ? firstUserMsg.text.substring(0, 8) + (firstUserMsg.text.length>8?'...':'') : 'æ–°å¯¹è¯';
        document.getElementById('chat-session-name').innerText = sessionName;
    }
    
    function renderCurrentChatHistory() { 
        const feed = document.getElementById('chat-feed'); 
        feed.innerHTML = ''; 
        let currentId = getCurrentChatId(); 
        const sessions = getAllChatSessions(); 
        if (!currentId || !sessions[currentId]) { createNewChatSession(); currentId = getCurrentChatId(); } 
        const history = sessions[currentId] || []; 
        const totalChars = history.reduce((acc, msg) => acc + msg.text.length, 0);
        document.getElementById('chat-token-display').innerText = `Est. Tokens: ${Math.ceil(totalChars)}`;
        history.forEach((msg, index) => { 
            const div = document.createElement('div'); 
            div.className = `chat-bubble ${msg.type}`; 
            let htmlContent = formatAIResponse(msg.text);
            if (msg.type === 'ai') {
                htmlContent += `<div class="chat-actions"><span class="chat-action-btn" onclick="regenerateChatMsg(${index})" title="é‡æ–°ç”Ÿæˆ"><i class="fas fa-sync-alt"></i></span><span class="chat-action-btn" onclick="deleteChatMsg(${index})" title="åˆ é™¤"><i class="fas fa-trash"></i></span></div>`;
            }
            div.innerHTML = htmlContent; 
            feed.appendChild(div); 
        }); 
        feed.scrollTop = feed.scrollHeight; 
    }

    function deleteChatMsg(index) {
        if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) return;
        const sessions = getAllChatSessions();
        const currentId = getCurrentChatId();
        if (sessions[currentId]) {
            sessions[currentId].splice(index, 1);
            localStorage.setItem('os_chat_sessions', JSON.stringify(sessions));
            renderCurrentChatHistory();
        }
    }

    function regenerateChatMsg(index) {
        const sessions = getAllChatSessions();
        const currentId = getCurrentChatId();
        const history = sessions[currentId];
        let userMsgText = "";
        for (let i = index - 1; i >= 0; i--) { if (history[i].type === 'user') { userMsgText = history[i].text; break; } }
        if (!userMsgText) return alert("æ‰¾ä¸åˆ°å¯¹åº”çš„ä¸Šæ–‡ï¼Œæ— æ³•é‡æ–°ç”Ÿæˆã€‚");
        history.splice(index, 1);
        localStorage.setItem('os_chat_sessions', JSON.stringify(sessions));
        renderCurrentChatHistory();
        triggerAIStream(userMsgText);
    }

    async function triggerAIStream(text) {
        const key = localStorage.getItem('os_key'); if(!key) return alert('è¯·é…ç½®Key'); 
        const btn = document.getElementById('btn-chat-send'); btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; 
        const feed = document.getElementById('chat-feed'); 
        let currentBubble = document.createElement('div'); currentBubble.className = 'chat-bubble ai'; feed.appendChild(currentBubble); feed.scrollTop = feed.scrollHeight; 
        let fullReply = ""; 
        try { 
            let rolePrompt = "ä½ æ˜¯ä¸€ä¸ªé€šç”¨AIåŠ©ç†ã€‚"; const roleJSON = document.getElementById('chat-role').value; if(roleJSON) { const r = JSON.parse(roleJSON); rolePrompt = `è¯·ä¸¥æ ¼æ‰®æ¼”ä»¥ä¸‹è§’è‰²ï¼š\nã€è§’è‰²åã€‘: ${r.name}\nã€è§’è‰²è®¾å®šã€‘: ${r.desc}\nç”¨è¿™ä¸ªè§’è‰²çš„å£å»å¯¹è¯ã€‚`; } 
            const chatMode = localStorage.getItem('os_chat_mode') || 'casual'; let systemInstruction = ""; if (chatMode === 'casual') { systemInstruction = "\n\n[System Instruction: IMPERATIVE]\n1. You are chatting on a messenger app. REPLY AS A CLOSE FRIEND.\n2. Keep sentences SHORT and CASUAL. Do NOT write long paragraphs.\n3. STRICTLY FORBIDDEN: Markdown headers (###), Bold (**), Bullet points.\n4. Use plain text only. Split distinct thoughts into separate paragraphs.\n5. Tone: Relaxed, colloquial, human-like."; } 
            const masterPrompt = localStorage.getItem('os_master_prompt') || ''; const finalSystemPrompt = (masterPrompt ? `${masterPrompt}\n\n---\n\n${rolePrompt}` : rolePrompt) + systemInstruction; 
            const currentId = getCurrentChatId(); const sessions = getAllChatSessions(); const history = sessions[currentId] || []; 
            const messages = history.map(m => ({ role: m.type === 'user' ? 'user' : 'assistant', content: m.text })); messages.unshift({role: "system", content: finalSystemPrompt}); 
            const url = (localStorage.getItem('os_url') || "https://api.openai.com/v1").replace(/\/$/,''); const model = localStorage.getItem('os_model') || "gpt-3.5-turbo"; 
            const res = await fetch(url+'/chat/completions', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` }, body: JSON.stringify({ model, messages, stream: true }) }); 
            if(!res.ok) throw new Error(`API Error: ${res.status}`); 
            const reader = res.body.getReader(); const decoder = new TextDecoder("utf-8"); 
            while (true) { 
                const { done, value } = await reader.read(); if (done) break; 
                const chunk = decoder.decode(value, { stream: true }); const lines = chunk.split('\n'); 
                for (const line of lines) { 
                    if (line.startsWith('data: ')) { 
                        const jsonStr = line.slice(6); if (jsonStr === '[DONE]') break; 
                        try { 
                            const json = JSON.parse(jsonStr); const content = json.choices[0].delta.content || ""; fullReply += content; 
                            if (chatMode === 'casual' && fullReply.includes('\n\n')) { 
                                const parts = fullReply.split('\n\n'); const lastCompletePart = parts.slice(0, -1).join('\n\n'); 
                                currentBubble.innerHTML = formatAIResponse(lastCompletePart); saveChatMessage('ai', lastCompletePart.trim()); 
                                fullReply = parts[parts.length - 1]; currentBubble = document.createElement('div'); currentBubble.className = 'chat-bubble ai'; feed.appendChild(currentBubble); 
                            } 
                            currentBubble.innerHTML = formatAIResponse(fullReply); feed.scrollTop = feed.scrollHeight; 
                        } catch (e) { console.error("Stream parse error", e); } 
                    } 
                } 
            } 
            if (fullReply.trim()) { saveChatMessage('ai', fullReply.trim()); renderCurrentChatHistory(); updateSessionTriggerText(); } else { if(currentBubble.innerHTML === "") currentBubble.remove(); } 
        } catch (e) { currentBubble.innerHTML = `è¿æ¥æ–­å¼€ï¼š${e.message}`; saveChatMessage('ai', `[ç³»ç»Ÿé”™è¯¯] ${e.message}`); renderCurrentChatHistory(); } finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-arrow-up"></i>'; } 
    }
    
        async function sendChatMessage() { const input = document.getElementById('chat-input'); const text = input.value.trim(); if(!text) return; saveChatMessage('user', text); input.value = ''; renderCurrentChatHistory(); updateSessionTriggerText(); triggerAIStream(text); }
    function saveChatMessage(type, text) { const sessions = getAllChatSessions(); const currentId = getCurrentChatId(); if(!sessions[currentId]) sessions[currentId] = []; sessions[currentId].push({type, text}); localStorage.setItem('os_chat_sessions', JSON.stringify(sessions)); }
    function toggleChatMode() { const btn = document.getElementById('chat-mode-toggle'); let currentMode = localStorage.getItem('os_chat_mode') || 'casual'; const newMode = currentMode === 'casual' ? 'pro' : 'casual'; localStorage.setItem('os_chat_mode', newMode); setInitialChatModeIcon(); alert(`èŠå¤©æ¨¡å¼å·²åˆ‡æ¢ä¸ºï¼š${newMode === 'casual' ? 'æœ‹å‹é—²èŠ (çŸ­å¥/æµå¼)' : 'ä¸“ä¸šåŠ©ç† (é•¿æ–‡)'}`); }
    function setInitialChatModeIcon() { const btn = document.getElementById('chat-mode-toggle'); if (!btn) return; const currentMode = localStorage.getItem('os_chat_mode') || 'casual'; if (currentMode === 'casual') { btn.className = 'fas fa-bolt'; btn.style.color = 'var(--accent-color)'; } else { btn.className = 'fas fa-book'; btn.style.color = 'var(--text-sub)'; } }
            // --- Daily Widget Collapse Logic ---
    function toggleDailyContentCollapse() {
        const contentArea = document.getElementById('daily-collapsible-area');
        const collapseIcon = document.getElementById('daily-collapse-icon');
        if (!contentArea || !collapseIcon) return; // ç¡®ä¿å…ƒç´ å­˜åœ¨

        const isCollapsed = contentArea.classList.toggle('collapsed');
        collapseIcon.classList.toggle('rotated', isCollapsed);
        localStorage.setItem('os_daily_content_collapsed', isCollapsed); // ä¿å­˜æŠ˜å çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
    }
</script>
</body>
</html>