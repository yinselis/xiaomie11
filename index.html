<!-- START OF FILE ai_studio_os_v12_strawberry_edition.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çµçŠ€ OS (V12 è‰è“ç”œå¿ƒç‰ˆ)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            /* é»˜è®¤å˜é‡ */
            --wallpaper: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=800&auto=format&fit=crop');
            --text-color: #fff; --text-sub: #aaa; --text-shadow: 0 2px 5px rgba(0,0,0,0.5);
            --app-bg: #111; --card-bg: #222; --input-bg: #333; --input-border: #444;
            --border-color: rgba(255,255,255,0.1); --accent-color: #0af; --icon-bg: rgba(255, 255, 255, 0.2);
            --icon-border: 1px solid rgba(255, 255, 255, 0.3);
            --icon-radius: 18px;
            --icon-size: 30px;
            --icon-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* === ä¸»é¢˜å®šä¹‰ === */
        /* æ·±è‰²ç³» */
        body.theme-default { --wallpaper: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=800&auto=format&fit=crop'); }
        body.theme-nebula { --wallpaper: url('https://images.unsplash.com/photo-1538370965246-fe4c0b457e56?q=80&w=800&auto=format&fit=crop'); --app-bg: #1e1b2e; --card-bg: #2e2a44; --input-bg: #403a61; --accent-color: #bf55ec; }
        body.theme-forest { --wallpaper: url('https://images.unsplash.com/photo-1448375240586-882707db888b?q=80&w=800&auto=format&fit=crop'); --app-bg: #172f23; --card-bg: #214232; --input-bg: #2f5d42; --accent-color: #2ed573; }
        
        /* æµ…è‰²ç³» (Appå†…éƒ¨çº¯è‰²ä¸é€æ˜) */
        body.theme-cream-pink { --wallpaper: linear-gradient(135deg, #fff0f5 0%, #ffd1dc 100%); --text-color: #5d4037; --text-sub: #8d6e63; --text-shadow: none; --app-bg: #fff0f5; --card-bg: #ffffff; --input-bg: #ffffff; --input-border: #ffcce0; --border-color: rgba(0,0,0,0.05); --accent-color: #ff80ab; --icon-bg: rgba(255, 128, 171, 0.4); }
        body.theme-cream-blue { --wallpaper: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); --text-color: #37474f; --text-sub: #78909c; --text-shadow: none; --app-bg: #e1f5fe; --card-bg: #ffffff; --input-bg: #ffffff; --input-border: #b3e5fc; --border-color: rgba(0,0,0,0.05); --accent-color: #29b6f6; --icon-bg: rgba(41, 182, 246, 0.3); }
        body.theme-cream-yellow { --wallpaper: linear-gradient(135deg, #fffde7 0%, #fff59d 100%); --text-color: #5d4037; --text-sub: #8d6e63; --text-shadow: none; --app-bg: #fff9c4; --card-bg: #ffffff; --input-bg: #ffffff; --input-border: #fff176; --border-color: rgba(0,0,0,0.05); --accent-color: #fbc02d; --icon-bg: rgba(251, 192, 45, 0.3); }
        
        /* å¯çˆ±ç³» */
        body.theme-taro { --wallpaper: linear-gradient(135deg, #f3e7e9 0%, #e3eeff 99%, #e3eeff 100%); --text-color: #4a4a4a; --text-sub: #888; --text-shadow: none; --app-bg: #f4eeff; --card-bg: #fff; --input-bg: #fff; --input-border: #dcd6f7; --border-color: rgba(0,0,0,0.05); --accent-color: #a29bfe; --icon-bg: rgba(162, 155, 254, 0.4); }
        body.theme-matcha { --wallpaper: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%); --text-color: #2d3436; --text-sub: #636e72; --text-shadow: none; --app-bg: #f0fff4; --card-bg: #fff; --input-bg: #fff; --input-border: #b8e994; --border-color: rgba(0,0,0,0.05); --accent-color: #78e08f; --icon-bg: rgba(120, 224, 143, 0.4); }
        body.theme-peach { --wallpaper: linear-gradient(120deg, #f6d365 0%, #fda085 100%); --text-color: #4a4a4a; --text-sub: #888; --text-shadow: none; --app-bg: #fff5ee; --card-bg: #fff; --input-bg: #fff; --input-border: #ffccbc; --border-color: rgba(0,0,0,0.05); --accent-color: #ff9f43; --icon-bg: rgba(255, 159, 67, 0.4); }

        /* ğŸ“ è‰è“ç”œå¿ƒé™å®šç‰ˆ Theme ğŸ“ */
        body.theme-strawberry { 
            --wallpaper: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); 
            --text-color: #5d4037; --text-sub: #bcaaa4; --text-shadow: none; 
            --app-bg: #fff0f5; /* çº¯è‰²ç²‰ */
            --card-bg: #ffffff; 
            --input-bg: #fff; --input-border: #ffcdd2; 
            --border-color: #ffcdd2; 
            --accent-color: #ff5252; /* è‰è“çº¢ */
            --icon-bg: rgba(255, 82, 82, 0.3); 
        }
        /* è‰è“ä¸»é¢˜ä¸“å±è£…é¥° */
        body.theme-strawberry .app-nav { border-bottom: 2px dashed var(--accent-color); }
        body.theme-strawberry .nav-btn i { display: none; } /* éšè—åŸæ¥çš„ç®­å¤´ */
        body.theme-strawberry .nav-btn::before { content: 'ğŸ“'; font-size: 20px; margin-right:5px; } /* ç”¨è‰è“ä»£æ›¿è¿”å› */
        body.theme-strawberry .app-title::after { content: ' ğŸ°'; font-size: 14px; }
        body.theme-strawberry .card { border: 1px solid #ffebee; position: relative; overflow: hidden; }
        body.theme-strawberry .card::before { content: 'âœ¨'; position: absolute; top: 5px; right: 5px; font-size: 10px; opacity: 0.5; color: var(--accent-color); pointer-events: none; }
        body.theme-strawberry .yijing-menu-btn { border: 2px dashed #ffcdd2; }

        /* === å›¾æ ‡æ ·å¼å®šä¹‰ (Icon Styles) === */
        
        /* 1. é»˜è®¤: Glass (æ¯›ç»ç’ƒ) */
        body.style-glass .frosted-icon { backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); }
        
        /* 2. é•‚ç©º (Outline) */
        body.style-outline .frosted-icon { background: transparent !important; border: 2px solid var(--accent-color); color: var(--accent-color); box-shadow: none; backdrop-filter: none; }
        body.style-outline .frosted-icon i { text-shadow: none; }

        /* 3. æ‰å¹³ (Flat) */
        body.style-flat .frosted-icon { background: var(--card-bg); border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.1); backdrop-filter: none; }
        body.style-flat .frosted-icon i { color: var(--accent-color); }

        /* 4. Emoji (å¤§è¡¨æƒ…) */
        body.style-emoji .frosted-icon { background: transparent; border: none; box-shadow: none; backdrop-filter: none; font-size: 52px; animation: bounce 2s infinite ease-in-out; }
        body.style-emoji .frosted-icon i { display: none; } 
        body.style-emoji .frosted-icon::after { content: attr(data-emoji); }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* 5. çº¯ç™½ (White) - é€‚åˆæ·±è‰²å£çº¸ */
        body.style-white .frosted-icon { 
            background: rgba(255, 255, 255, 0.2); 
            border: 1px solid rgba(255, 255, 255, 0.5); 
            color: #fff; 
            backdrop-filter: blur(8px); 
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        /* 6. çº¯é»‘ (Black) - é€‚åˆæµ…è‰²å£çº¸ */
        body.style-black .frosted-icon { 
            background: rgba(0, 0, 0, 0.5); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            color: #fff; 
            backdrop-filter: blur(8px); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        /* 7. æ°´æ»´è´¨æ„Ÿ (Water) - é«˜çº§é€æ˜ */
        body.style-water .frosted-icon {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 
                inset 0 0 15px rgba(255, 255, 255, 0.6), /* å†…éƒ¨é«˜å…‰ */
                inset 2px 2px 5px rgba(255,255,255,0.8), /* è¾¹ç¼˜é«˜å…‰ */
                5px 5px 15px rgba(0,0,0,0.1); /* å¤–éƒ¨é˜´å½± */
            backdrop-filter: blur(3px);
            border-radius: 22px;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        /* å¦‚æœæ˜¯æµ…è‰²ä¸»é¢˜ä¸‹çš„æ°´æ»´ï¼Œå›¾æ ‡é¢œè‰²æ·±ä¸€ç‚¹ */
        body[class*="theme-cream"].style-water .frosted-icon,
        body[class*="theme-strawberry"].style-water .frosted-icon,
        body[class*="theme-taro"].style-water .frosted-icon {
            color: #fff;
            background: rgba(255, 255, 255, 0.25);
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }


        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent; }
        html, body { margin: 0; padding: 0; height: 100vh; overflow: hidden; }
        body { background: #000; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; justify-content: center; align-items: center; }

        #phone-frame { 
            width: 100%; height: 100%; 
            background: var(--wallpaper) center/cover no-repeat; 
            position: relative; overflow: hidden; display: flex; flex-direction: column; 
            transition: background 0.3s ease; 
        }

        @media (max-width: 450px) { body { background: #000; } #phone-frame { border-radius: 0; border: none; } .notch { display: none !important; } .status-bar { padding-top: constant(safe-area-inset-top); padding-top: env(safe-area-inset-top); } }
        @media (min-width: 450px) { #phone-frame { max-width: 420px; max-height: 900px; border-radius: 44px; border: 12px solid #1a1a1a; box-shadow: 0 0 50px rgba(0,0,0,0.7); height: 88vh; } .notch { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 130px; height: 30px; background: #000; border-radius: 0 0 16px 16px; z-index: 20; } }

        .status-bar { height: 44px; padding: 0 24px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: var(--text-color); font-weight: 600; z-index: 10; text-shadow: var(--text-shadow); position: absolute; top:0; left:0; right:0; }
        #desktop { flex: 1; padding: 20px; padding-top: 64px; display: flex; flex-direction: column; }
        .clock-widget { padding: 20px 0 30px 10px; color: var(--text-color); text-shadow: var(--text-shadow); }
        .clock-time { font-size: 72px; font-weight: 200; line-height: 1; }
        .clock-date { font-size: 18px; margin-top: 5px; opacity: 0.8; }

        .app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px 12px; }
        .icon-wrap { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: transform 0.1s; }
        .icon-wrap:active { transform: scale(0.95); }
        
        .frosted-icon { width: 68px; height: 68px; border-radius: var(--icon-radius); background: var(--icon-bg); border: var(--icon-border); box-shadow: var(--icon-shadow); display: flex; justify-content: center; align-items: center; font-size: var(--icon-size); color: #fff; margin-bottom: 8px; transition: all 0.3s; }
        body[class*="theme-cream"] .frosted-icon { color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2); } 
        
        .icon-name { font-size: 12px; color: var(--text-color); text-shadow: var(--text-shadow); font-weight: 500; }
        .dock { margin-top: auto; padding: 16px; background: rgba(255,255,255,0.1); border-radius: 30px; margin-bottom: 10px; backdrop-filter: blur(15px); }
        
        .app-window { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--app-bg); z-index: 100; display: flex; flex-direction: column; transform: translateY(105%); opacity: 0; transition: transform 0.35s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.35s; pointer-events: none; color: var(--text-color); }
        .app-window.active { transform: translateY(0); opacity: 1; pointer-events: auto; }
        
        .app-nav { height: 50px; margin-top: 40px; display: flex; align-items: center; padding: 0 16px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .app-title { flex: 1; text-align: center; font-size: 17px; font-weight: 600; color: var(--text-color); display: flex; flex-direction: column; justify-content: center; line-height: 1.2; }
        .app-subtitle { font-size: 11px; font-weight: normal; opacity: 0.7; }
        .nav-btn { color: var(--accent-color); font-size: 16px; width: 60px; cursor: pointer; display: flex; align-items: center; }

        .app-content { flex: 1; overflow-y: auto; padding: 16px; color: var(--text-color); }
        .card { background: var(--card-bg); border-radius: 14px; padding: 16px; margin-bottom: 16px; border: 1px solid var(--border-color); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        /* Yijing & Common Styles */
        .yijing-menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .yijing-menu-btn { background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 16px; padding: 20px 10px; text-align: center; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; height: 120px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .yijing-menu-btn:active { transform: scale(0.96); border-color: var(--accent-color); }
        .yijing-menu-btn i { font-size: 32px; color: var(--accent-color); margin-bottom: 5px; }
        .yijing-menu-btn span { font-size: 14px; font-weight: 600; color: var(--text-color); }

        input, textarea, select { width: 100%; background: var(--input-bg); border: 1px solid var(--input-border); padding: 12px; color: var(--text-color); border-radius: 10px; font-size: 16px; margin-bottom: 12px; font-family: inherit; resize: none; outline: none; transition: border 0.2s; }
        input:focus, textarea:focus { border-color: var(--accent-color); }
        
        button { width: 100%; padding: 14px; background: var(--accent-color); border: none; border-radius: 12px; color: #fff; font-size: 16px; font-weight: 600; cursor: pointer; display:flex; justify-content:center; align-items:center; gap:8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        button:disabled { background: #888; cursor: not-allowed; }
        button.secondary { background: rgba(128,128,128,0.3); color: var(--text-color); box-shadow: none; }
        button.outline { background: transparent; border: 1px solid var(--accent-color); color: var(--accent-color); box-shadow: none; }
        button.danger { background: #ff3b30; color: #fff; border:none; box-shadow: 0 4px 10px rgba(255, 59, 48, 0.3); }
        
        .theme-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 10px 0; }
        .theme-button { width: 100%; padding-bottom: 100%; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); cursor: pointer; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.2); background-size: cover; background-position: center; }
        .theme-button.active { box-shadow: 0 0 0 3px var(--accent-color); border-color: #fff; }
        .theme-emoji { position: absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-size: 24px; }

        .icon-style-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
        .icon-style-btn { padding: 15px 5px; border-radius: 10px; background: var(--card-bg); border: 1px solid var(--border-color); text-align: center; cursor: pointer; font-size: 12px; }
        .icon-style-btn.active { border-color: var(--accent-color); background: rgba(128,128,128,0.1); color: var(--accent-color); font-weight: bold; }

        /* Gua Styles */
        .gua-visual-row { display: flex; justify-content: space-between; margin: 10px 0 20px 0; text-align: center; }
        .gua-col { width: 32%; background: rgba(128,128,128,0.1); border-radius: 8px; padding: 10px 5px; }
        .gua-lines-box { display: flex; flex-direction: column; gap: 6px; margin: 10px auto; width: 60px; }
        .line { width: 100%; height: 8px; border-radius: 2px; }
        .line.yang { background-color: var(--text-color); } 
        .line.yin { background: transparent; display: flex; justify-content: space-between; }
        .line.yin span { display: block; width: 42%; height: 100%; background-color: var(--text-color); border-radius: 2px; }
        .line.moving.yang, .line.moving.yin span { background-color: #ff3b30; }
        .gua-title { font-size: 12px; font-weight: bold; color: var(--text-sub); text-transform: uppercase; }
        .gua-name { font-size: 16px; font-weight: bold; margin-top: 5px; color: var(--accent-color); }
        
        .ai-collapsible .content { display: none; margin-top:10px; border-top:1px solid var(--border-color); padding-top:10px; line-height: 1.6; }
        .ai-collapsible .content.expanded { display: block; }
        .ai-collapsible .toggle-btn { font-size: 14px; text-align:left; padding: 8px; background: rgba(128,128,128,0.1); border-radius: 8px; color: var(--accent-color); box-shadow: none; width: 100%; display: flex; justify-content: space-between; align-items: center; }
        
        /* Chat Styles */
        .chat-feed { flex:1; overflow-y:auto; padding-bottom:10px; }
        .chat-bubble { max-width: 80%; padding: 10px 15px; border-radius: 18px; line-height: 1.6; margin-bottom: 10px; font-size: 15px; word-break: break-word; position: relative; }
        .chat-bubble.user { background: var(--accent-color); color: #fff; margin-left: auto; border-bottom-right-radius: 4px; }
        .chat-bubble.ai { background: var(--card-bg); color: var(--text-color); margin-right: auto; border-bottom-left-radius: 4px; border: 1px solid var(--border-color); }
        .chat-input-area { display: flex; gap: 10px; padding-top:10px; border-top:1px solid var(--border-color); }
        .chat-actions { display: flex; gap: 10px; margin-top: 5px; justify-content: flex-end; opacity: 0.6; }
        .chat-action-btn { font-size: 12px; cursor: pointer; padding: 2px 5px; color: var(--text-sub); display: flex; align-items: center; gap: 4px; }
        .chat-action-btn:hover { color: var(--accent-color); opacity: 1; }
        
        /* Session Trigger Button */
        .session-trigger { flex:1; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 10px; padding: 0 12px; display: flex; align-items: center; height: 42px; cursor: pointer; font-size: 14px; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; justify-content: space-between; }
        .session-trigger i { font-size: 12px; opacity: 0.5; }

        /* Custom Modals (Common) */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 20px; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-box { width: 100%; max-width: 320px; background: var(--card-bg); border-radius: 16px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 1px solid var(--border-color); transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; flex-direction: column; max-height: 70vh; }
        .modal-overlay.show .modal-box { transform: scale(1); }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; flex-shrink: 0; }
        .modal-list { overflow-y: auto; display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .modal-list-item { padding: 12px; background: rgba(128,128,128,0.1); border-radius: 10px; cursor: pointer; border: 1px solid transparent; text-align: left; }
        .modal-list-item:hover, .modal-list-item.active { border-color: var(--accent-color); background: rgba(128,128,128,0.2); }
        .modal-list-item div { font-weight: bold; font-size: 14px; margin-bottom: 2px; }
        .modal-list-item small { color: var(--text-sub); font-size: 11px; }
        
        .diary-date-header { padding: 10px; background: var(--icon-bg); margin-bottom: 10px; border-radius: 8px; font-size: 14px; font-weight: bold; color: var(--text-color); cursor: pointer; display: flex; justify-content: space-between; align-items: center; backdrop-filter: blur(5px); }
        .diary-group { display: block; }
        .diary-group.collapsed { display: none; }
        
        .check-wrap { display: flex; align-items: center; gap: 10px; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        .check-wrap input[type="checkbox"] { width: 20px; height: 20px; margin: 0; }
        .check-content { flex: 1; }
        .batch-toolbar { position: absolute; bottom: 20px; left: 20px; right: 20px; display: flex; gap: 10px; z-index: 200; }
        
        h4 { margin: 10px 0; color: var(--text-color); }
        small { color: var(--text-sub); }
    </style>
</head>
<body class="theme-default style-glass">

<!-- Custom Prompt Modal -->
<div id="custom-prompt-overlay" class="modal-overlay">
    <div class="modal-box">
        <h4 id="custom-prompt-title">è¾“å…¥ä¿¡æ¯</h4>
        <input type="text" id="custom-prompt-input" style="margin-top:10px;">
        <div class="modal-btns">
            <button class="secondary" onclick="closeCustomPrompt()">å–æ¶ˆ</button>
            <button onclick="confirmCustomPrompt()">ç¡®å®š</button>
        </div>
    </div>
</div>

<!-- Session List Modal -->
<div id="session-list-overlay" class="modal-overlay">
    <div class="modal-box">
        <h4>åˆ‡æ¢ä¼šè¯</h4>
        <div id="session-list" class="modal-list"></div>
        <div class="modal-btns">
            <button class="secondary" onclick="document.getElementById('session-list-overlay').classList.remove('show')">å…³é—­</button>
        </div>
    </div>
</div>

<div id="phone-frame">
    <div class="notch"></div>
    <div class="status-bar"><span id="clock-small"></span><span id="battery-status"></span></div>
    <div id="desktop">
        <div class="clock-widget"><div class="clock-time" id="clock-big"></div><div class="clock-date" id="clock-date"></div></div>
        
        <!-- App Grid (Icons with Data-Emoji for Emoji Mode) -->
        <div class="app-grid">
            <div class="icon-wrap" onclick="openApp('app-chars')">
                <div class="frosted-icon" data-emoji="ğŸ‘¥" style="background: linear-gradient(135deg, #FF9A9E, #FECFEF);"><i class="fas fa-users"></i></div>
                <div class="icon-name">è§’è‰²</div>
            </div>
            <div class="icon-wrap" onclick="openApp('app-yijing')">
                <div class="frosted-icon" data-emoji="â˜¯ï¸" style="background: linear-gradient(135deg, #a18cd1, #fbc2eb);"><i class="fas fa-yin-yang"></i></div>
                <div class="icon-name">æ¢…èŠ±æ˜“æ•°</div>
            </div>
            <div class="icon-wrap" onclick="openApp('app-diary')">
                <div class="frosted-icon" data-emoji="ğŸ“”" style="background: linear-gradient(135deg, #84fab0, #8fd3f4);"><i class="fas fa-book-open"></i></div>
                <div class="icon-name">äº¤æ¢æ—¥è®°</div>
            </div>
            <div class="icon-wrap" onclick="openApp('app-chat')">
                <div class="frosted-icon" data-emoji="ğŸ’¬" style="background: linear-gradient(135deg, #fccb90, #d57eeb);"><i class="fas fa-comments"></i></div>
                <div class="icon-name">ç§äººåŠ©ç†</div>
            </div>
        </div>
        <div class="dock app-grid">
            <div class="icon-wrap" onclick="openApp('app-instructions')">
                <div class="frosted-icon" data-emoji="ğŸ“œ"><i class="fas fa-scroll"></i></div>
            </div>
            <div class="icon-wrap" onclick="openApp('app-settings')">
                <div class="frosted-icon" data-emoji="âš™ï¸"><i class="fas fa-cog"></i></div>
            </div>
        </div>
    </div>

    <!-- Apps -->
    <div id="app-settings" class="app-window">
        <div class="app-nav"><div class="nav-btn" onclick="closeApp('app-settings')"><i class="fas fa-chevron-left"></i> æ¡Œé¢</div><div class="app-title">è®¾ç½®</div><div class="nav-btn"></div></div>
        <div class="app-content">
            <div class="card">
                <h4>å¤–è§‚ä¸»é¢˜</h4>
                <div class="theme-grid">
                    <div class="theme-button" style="background-image: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=200&auto=format&fit=crop');" data-theme="theme-default" onclick="applyTheme('theme-default')"></div>
                    <div class="theme-button" style="background-image: url('https://images.unsplash.com/photo-1538370965246-fe4c0b457e56?q=80&w=200&auto=format&fit=crop');" data-theme="theme-nebula" onclick="applyTheme('theme-nebula')"></div>
                    <div class="theme-button" style="background-image: url('https://images.unsplash.com/photo-1448375240586-882707db888b?q=80&w=200&auto=format&fit=crop');" data-theme="theme-forest" onclick="applyTheme('theme-forest')"></div>
                    
                    <div class="theme-button" style="background:linear-gradient(135deg, #fff0f5 0%, #ffd1dc 100%);" data-theme="theme-cream-pink" onclick="applyTheme('theme-cream-pink')"><span class="theme-emoji">ğŸŒ¸</span></div>
                    <div class="theme-button" style="background:linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);" data-theme="theme-cream-blue" onclick="applyTheme('theme-cream-blue')"><span class="theme-emoji">â˜ï¸</span></div>
                    <div class="theme-button" style="background:linear-gradient(135deg, #fffde7 0%, #fff59d 100%);" data-theme="theme-cream-yellow" onclick="applyTheme('theme-cream-yellow')"><span class="theme-emoji">ğŸ‹</span></div>
                    
                    <div class="theme-button" style="background:linear-gradient(135deg, #f3e7e9 0%, #e3eeff 100%);" data-theme="theme-taro" onclick="applyTheme('theme-taro')"><span class="theme-emoji">ğŸ </span></div>
                    <div class="theme-button" style="background:linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);" data-theme="theme-matcha" onclick="applyTheme('theme-matcha')"><span class="theme-emoji">ğŸµ</span></div>
                    <div class="theme-button" style="background:linear-gradient(120deg, #f6d365 0%, #fda085 100%);" data-theme="theme-peach" onclick="applyTheme('theme-peach')"><span class="theme-emoji">ğŸ‘</span></div>
                    
                    <!-- New Strawberry Theme -->
                    <div class="theme-button" style="background:linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);" data-theme="theme-strawberry" onclick="applyTheme('theme-strawberry')"><span class="theme-emoji">ğŸ“</span></div>
                </div>
                
                <h4 style="margin-top:20px;">å›¾æ ‡æ ·å¼</h4>
                <div class="icon-style-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="icon-style-btn" onclick="applyIconStyle('style-glass')">é»˜è®¤</div>
                    <div class="icon-style-btn" onclick="applyIconStyle('style-outline')">é•‚ç©º</div>
                    <div class="icon-style-btn" onclick="applyIconStyle('style-emoji')">Emoji</div>
                    <div class="icon-style-btn" onclick="applyIconStyle('style-flat')">çº¯å¹³</div>
                    <div class="icon-style-btn" onclick="applyIconStyle('style-white')">çº¯ç™½</div>
                    <div class="icon-style-btn" onclick="applyIconStyle('style-black')">çº¯é»‘</div>
                    <div class="icon-style-btn" onclick="applyIconStyle('style-water')">æ°´æ»´</div>
                </div>

                <h4 style="margin-top: 20px;">è‡ªå®šä¹‰å£çº¸</h4>
                <input type="file" id="wallpaper-upload" accept="image/*" style="display: none;" onchange="handleWallpaperUpload(this.files)">
                <button class="secondary" onclick="document.getElementById('wallpaper-upload').click()"><i class="fas fa-image"></i> ä»ç›¸å†Œé€‰æ‹©</button>
                <button class="outline" onclick="removeCustomWallpaper()" style="margin-top: 10px;"><i class="fas fa-times-circle"></i> ç§»é™¤è‡ªå®šä¹‰å£çº¸</button>
                <p style="font-size:12px; color:var(--text-sub); margin-top:5px;">æç¤ºï¼šè‡ªå®šä¹‰å£çº¸å°†è¦†ç›–æ‰€æœ‰ä¸»é¢˜èƒŒæ™¯ï¼Œä»…åœ¨æ¡Œé¢æ˜¾ç¤ºã€‚</p>
            </div>
            <div class="card"><h4>API è®¾ç½®</h4><input type="text" id="cfg-url" placeholder="API Host"><input type="password" id="cfg-key" placeholder="API Key"><button class="secondary" onclick="fetchModels()" id="btn-fetch" style="margin-bottom:10px;"><i class="fas fa-sync"></i> æ‹‰å–æ¨¡å‹åˆ—è¡¨</button><select id="cfg-model"></select><button onclick="saveConfig()" style="margin-top:10px;">ä¿å­˜ API é…ç½®</button></div>
            <div class="card"><h4>æ•°æ®ç®¡ç†</h4><input type="file" id="import-file" style="display:none" onchange="handleImport(this.files)"><button class="secondary" onclick="document.getElementById('import-file').click();"><i class="fas fa-upload"></i> ä»æ–‡ä»¶æ¢å¤æ•°æ®</button><button class="secondary" onclick="exportData()" style="margin-top:10px;"><i class="fas fa-download"></i> å¤‡ä»½æ•°æ®åˆ°æ–‡ä»¶</button></div>
        </div>
    </div>
    
    <div id="app-chars" class="app-window"><div class="app-nav"><div class="nav-btn" onclick="closeApp('app-chars')"><i class="fas fa-chevron-left"></i></div><div class="app-title">è§’è‰²èµ„æ–™</div><div class="nav-btn" style="justify-content:flex-end;" onclick="openCharForm()"><i class="fas fa-plus"></i></div></div><div class="app-content"><div id="char-form-modal" class="card" style="display:none; border: 2px solid var(--accent-color);"><h4 id="char-form-title">æ–°å»ºè§’è‰²</h4><input type="hidden" id="char-form-id"><input type="text" id="char-form-name" placeholder="è§’è‰²å"><textarea id="char-form-desc" rows="2" placeholder="äººè®¾"></textarea><div style="display:flex; gap:10px;"><button class="secondary" onclick="closeCharForm()">å–æ¶ˆ</button><button onclick="saveChar()">ä¿å­˜</button></div></div><div id="char-list"></div></div></div>
    
    <!-- Yijing App -->
    <div id="app-yijing" class="app-window">
        <div id="yijing-home" style="height:100%; display:flex; flex-direction:column;">
            <div class="app-nav"><div class="nav-btn" onclick="closeApp('app-yijing')"><i class="fas fa-chevron-left"></i></div><div class="app-title">æ¢…èŠ±æ˜“æ•°</div><div class="nav-btn"></div></div>
            <div class="app-content">
                <div id="yijing-menu" class="yijing-menu-grid">
                    <div class="yijing-menu-btn" onclick="showNumberInput()"><i class="fas fa-sort-numeric-up-alt"></i><span>æ•°å­—èµ·å¦</span></div>
                    <div class="yijing-menu-btn" onclick="startDivination('random')"><i class="fas fa-dice"></i><span>éšæœºèµ·å¦</span></div>
                    <div class="yijing-menu-btn" onclick="showThreeNumberInput()"><i class="fas fa-list-ol"></i><span>ä¸‰æ•°èµ·å¦</span></div>
                    <div class="yijing-menu-btn" onclick="startDivination('time')"><i class="fas fa-clock"></i><span>æ—¶é—´èµ·å¦</span></div>
                </div>
                <div id="yijing-input-2" class="card" style="display:none;">
                    <h4>æ•°å­—èµ·å¦</h4>
                    <input type="text" id="yijing-q-2" placeholder="å¿ƒä¸­æ‰€å ä½•äº‹ï¼Ÿ (å¿…å¡«)">
                    <div style="display:flex;gap:10px;"><input type="number" id="yijing-n1" placeholder="ä¸Šå¦æ•°"><input type="number" id="yijing-n2" placeholder="ä¸‹å¦æ•°"></div>
                    <div style="display:flex;gap:10px;"><button class="secondary" onclick="showYijingMenu()">å–æ¶ˆ</button><button onclick="startDivination('number2')">ç«‹å³æ’ç›˜</button></div>
                </div>
                <div id="yijing-input-3" class="card" style="display:none;">
                    <h4>ä¸‰æ•°èµ·å¦</h4>
                    <input type="text" id="yijing-q-3" placeholder="å¿ƒä¸­æ‰€å ä½•äº‹ï¼Ÿ (å¿…å¡«)">
                    <div style="display:flex;gap:10px;"><input type="number" id="yijing-n3-1" placeholder="æ•°1(ä¸Šå¦)"><input type="number" id="yijing-n3-2" placeholder="æ•°2(ä¸‹å¦)"><input type="number" id="yijing-n3-3" placeholder="æ•°3(åŠ¨çˆ»)"></div>
                    <div style="display:flex;gap:10px;"><button class="secondary" onclick="showYijingMenu()">å–æ¶ˆ</button><button onclick="startDivination('number3')">ç«‹å³æ’ç›˜</button></div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin:20px 0 10px;">
                    <h4 style="margin:0;">å†å²è®°å½•</h4>
                    <button id="btn-edit-yijing" onclick="toggleYijingEditMode()" class="outline" style="width:auto; padding:5px 10px; font-size:12px;">ç®¡ç†</button>
                </div>
                <div id="yijing-history" class="card" style="padding:0 16px; margin-bottom: 60px;"></div>
            </div>
            <div id="yijing-batch-toolbar" class="batch-toolbar" style="display:none;">
                <button class="secondary" onclick="toggleYijingEditMode()">å–æ¶ˆ</button>
                <button class="danger" onclick="deleteSelectedYijing()">åˆ é™¤é€‰ä¸­</button>
            </div>
        </div>
        <div id="yijing-detail" style="display:none; height:100%; flex-direction:column;"><div class="app-nav"><div class="nav-btn" onclick="closeDetail()"><i class="fas fa-chevron-left"></i> è¿”å›</div><div class="app-title">å¦è±¡è¯¦æƒ…</div><div class="nav-btn"></div></div><div class="app-content"><div class="card" style="text-align:center;"><h3 id="detail-q" style="margin:5px 0;"></h3><div id="detail-meta" style="font-size:12px;color:var(--text-sub);"></div></div><div id="detail-gua-area" class="card"></div><div class="card"><h4><i class="fas fa-robot"></i> AI è§£å¦</h4><select id="detail-role"></select><button onclick="callAI('interpret')" id="btn-interpret">è¯·å¤§å¸ˆæŒ‡ç‚¹</button><div id="ai-interpret-res" class="ai-collapsible"></div></div><div class="card"><h4><i class="fas fa-pen"></i> æˆ‘çš„ç¬”è®°</h4><textarea id="detail-note" rows="3" placeholder="å†™ä¸‹ä½ çš„æ–­è¯­..."></textarea><div style="display:flex; gap:10px;"><button class="secondary" onclick="saveNote()">ä¿å­˜ç¬”è®°</button><button id="btn-evaluate" class="outline" onclick="callAI('evaluate')">è®© AI è¯„ä»·</button></div><div id="ai-evaluate-res" class="ai-collapsible"></div></div></div></div>
    </div>
    
    <div id="app-diary" class="app-window"><div class="app-nav"><div class="nav-btn" onclick="closeApp('app-diary')"><i class="fas fa-chevron-left"></i></div><div class="app-title">äº¤æ¢æ—¥è®°</div><div class="nav-btn"></div></div><div class="app-content"><div class="card"><textarea id="diary-input" rows="4" placeholder="å†™ä¸‹ä»Šå¤©çš„æ•…äº‹..."></textarea><div style="display:flex;gap:10px;"><select id="diary-role"></select><button id="btn-send-diary" onclick="sendDiary()" style="width:auto;"><i class="fas fa-paper-plane"></i></button></div><div id="diary-status" style="display:none;font-size:12px;color:var(--text-sub);margin-top:5px;"></div></div><div id="diary-feed"></div></div></div>
    
    <div id="app-instructions" class="app-window"><div class="app-nav"><div class="nav-btn" onclick="closeApp('app-instructions')"><i class="fas fa-chevron-left"></i> æ¡Œé¢</div><div class="app-title">æŒ‡ä»¤ä¸­å¿ƒ</div><div class="nav-btn"></div></div><div class="app-content"><div class="card"><h4>å…¨å±€æŒ‡ä»¤ (Master Prompt)</h4><p style="font-size:12px; color:var(--text-sub); margin:-10px 0 10px;">è¿™é‡Œçš„æŒ‡ä»¤å°†ä½œä¸ºæœ€é«˜ä¼˜å…ˆçº§ï¼Œå½±å“æ‰€æœ‰AIçš„è¡Œä¸ºã€‚</p><textarea id="master-prompt-input" rows="10" placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä¸ªå¯Œæœ‰æƒ…æ„Ÿçš„AIï¼Œæœ‰è‡ªå·±çš„å°è„¾æ°”..."></textarea><button onclick="saveMasterPrompt()">ä¿å­˜å…¨å±€æŒ‡ä»¤</button></div></div></div>
    
    <div id="app-chat" class="app-window">
        <div class="app-nav">
            <div class="nav-btn" onclick="closeApp('app-chat')"><i class="fas fa-chevron-left"></i></div>
            <div class="app-title">ç§äººåŠ©ç†<div class="app-subtitle" id="chat-token-display">Token: 0</div></div>
            <div class="nav-btn" style="justify-content:flex-end; gap: 18px; cursor: default;">
                <i id="chat-mode-toggle" class="fas fa-bolt" onclick="toggleChatMode()" style="cursor: pointer; font-size: 18px;"></i>
                <i class="fas fa-plus" onclick="createNewChatSession()" style="cursor: pointer; font-size: 18px;"></i>
            </div>
        </div>
        <div class="app-content" style="display:flex; flex-direction:column;">
            <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-shrink:0;">
                <select id="chat-role" style="flex:1; margin:0;"></select>
                <!-- Custom Trigger for Session List -->
                <div id="chat-session-trigger" class="session-trigger" onclick="openSessionList()">
                    <span id="chat-session-name">æ–°å¯¹è¯</span> <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            <div class="chat-feed" id="chat-feed"></div>
            <div class="chat-input-area"><textarea id="chat-input" rows="1" placeholder="é—®ç‚¹ä»€ä¹ˆ..." style="margin:0; flex:1;"></textarea><button id="btn-chat-send" onclick="sendChatMessage()" style="width:auto;"><i class="fas fa-arrow-up"></i></button></div>
        </div>
    </div>
</div>

<script>
    const trigramBits = { 1:[1,1,1], 2:[0,1,1], 3:[1,0,1], 4:[0,0,1], 5:[1,1,0], 6:[0,1,0], 7:[1,0,0], 8:[0,0,0], 0:[0,0,0] };
    const HEXAGRAM_DATA = { '1_1':"ä¹¾ä¸ºå¤©",'1_2':"å¤©åœ°å¦",'1_3':"å¤©æ³½å±¥",'1_4':"å¤©ç«åŒäºº",'1_5':"å¤©é£å§¤",'1_6':"å¤©æ°´è®¼",'1_7':"å¤©å±±é",'1_8':"å¤©é›·æ— å¦„", '2_1':"åœ°å¤©æ³°",'2_2':"å¤ä¸ºåœ°",'2_3':"åœ°æ³½ä¸´",'2_4':"åœ°ç«æ˜å¤·",'2_5':"åœ°é£å‡",'2_6':"åœ°æ°´å¸ˆ",'2_7':"åœ°å±±è°¦",'2_8':"åœ°é›·å¤", '3_1':"æ³½å¤©å¤¬",'3_2':"æ³½åœ°èƒ",'3_3':"å…‘ä¸ºå…‘",'3_4':"æ³½ç«é©",'3_5':"æ³½é£å¤§è¿‡",'3_6':"æ³½æ°´å›°",'3_7':"æ³½å±±å’¸",'3_8':"æ³½é›·éš", '4_1':"ç«å¤©å¤§æœ‰",'4_2':"ç«åœ°æ™‹",'4_3':"ç«æ³½ç½",'4_4':"ç¦»ä¸ºç«",'4_5':"ç«é£é¼",'4_6':"ç«æ°´æœªæµ",'4_7':"ç«å±±æ—…",'4_8':"ç«é›·å™¬å—‘", '5_1':"é£å¤©å°ç•œ",'5_2':"é£åœ°è§‚",'5_3':"é£æ³½ä¸­å­š",'5_4':"é£ç«å®¶äºº",'5_5':"å·½ä¸ºé£",'5_6':"é£æ°´æ¶£",'5_7':"é£å±±æ¸",'5_8':"é£é›·ç›Š", '6_1':"æ°´å¤©éœ€",'6_2':"æ°´åœ°æ¯”",'6_3':"æ°´æ³½èŠ‚",'6_4':"æ°´ç«æ—¢æµ",'6_5':"æ°´é£äº•",'6_6':"åä¸ºæ°´",'6_7':"æ°´å±±è¹‡",'6_8':"æ°´é›·å±¯", '7_1':"å±±å¤©å¤§ç•œ",'7_2':"å±±åœ°å‰¥",'7_3':"å±±æ³½æŸ",'7_4':"å±±ç«è´²",'7_5':"å±±é£è›Š",'7_6':"å±±æ°´è’™",'7_7':"è‰®ä¸ºå±±",'7_8':"å±±é›·é¢", '8_1':"é›·å¤©å¤§å£®",'8_2':"é›·åœ°è±«",'8_3':"é›·æ³½å½’å¦¹",'8_4':"é›·ç«ä¸°",'8_5':"é›·é£æ’",'8_6':"é›·æ°´è§£",'8_7':"é›·å±±å°è¿‡",'8_8':"éœ‡ä¸ºé›·" };
    let currentYijingId = null;
    let isYijingEditMode = false;
    let customPromptCallback = null;

    // --- Init & System Functions ---
    updateClock(); setInterval(updateClock, 1000);
    initBattery();
    migrateChatData(); 
    window.onload = () => { 
        loadCustomWallpaper(); 
        loadTheme(); 
        loadIconStyle(); // Load Icon Style
        loadConfig(); 
        renderCharList(); 
        renderYijingHistory(); 
        renderDiaryFeed(); 
        renderCurrentChatHistory(); 
    };

    function updateClock() { const t = new Date(); const timeStr = `${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`; document.getElementById('clock-small').innerText = timeStr; document.getElementById('clock-big').innerText = timeStr; const days=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"]; document.getElementById('clock-date').innerText = `${t.getMonth()+1}æœˆ${t.getDate()}æ—¥, æ˜ŸæœŸ${days[t.getDay()]}`; }
    function initBattery() { const status = document.getElementById('battery-status'); if ('getBattery' in navigator) { navigator.getBattery().then(bat => { const update = () => { const icon = bat.charging ? 'fa-bolt' : bat.level > 0.8 ? 'fa-battery-full' : bat.level > 0.5 ? 'fa-battery-three-quarters' : bat.level > 0.2 ? 'fa-battery-quarter' : 'fa-battery-empty'; status.innerHTML = `<i class="fas ${icon}"></i> ${Math.round(bat.level*100)}%`; }; update(); bat.addEventListener('levelchange', update); bat.addEventListener('chargingchange', update); }); } }

    function openApp(id) { document.getElementById(id).classList.add('active'); if(id==='app-diary') updateDiaryRolePicker(); if(id==='app-chat') { updateChatRolePicker(); updateSessionTriggerText(); renderCurrentChatHistory(); setInitialChatModeIcon(); } if(id==='app-instructions') loadMasterPrompt(); }
    function closeApp(id) { document.getElementById(id).classList.remove('active'); }
    
    // --- Custom Modal Functions ---
    function openCustomPrompt(title, placeholder, callback) {
        document.getElementById('custom-prompt-title').innerText = title;
        const input = document.getElementById('custom-prompt-input');
        input.value = '';
        input.placeholder = placeholder || '';
        document.getElementById('custom-prompt-overlay').classList.add('show');
        input.focus();
        customPromptCallback = callback;
    }
    function closeCustomPrompt() { document.getElementById('custom-prompt-overlay').classList.remove('show'); if (customPromptCallback) customPromptCallback(null); customPromptCallback = null; }
    function confirmCustomPrompt() { const val = document.getElementById('custom-prompt-input').value.trim(); document.getElementById('custom-prompt-overlay').classList.remove('show'); if (customPromptCallback) customPromptCallback(val); customPromptCallback = null; }

    // --- Appearance, Wallpaper & Icon Style ---
    function applyTheme(themeName) { 
        // Remove old theme classes
        document.body.className = document.body.className.replace(/theme-[\w-]+/g, '').trim();
        document.body.classList.add(themeName);
        localStorage.setItem('os_theme', themeName); 
        document.querySelectorAll('.theme-button').forEach(btn => btn.classList.toggle('active', btn.dataset.theme === themeName));
        const customWallpaper = localStorage.getItem('os_custom_wallpaper');
        if (customWallpaper) { applyCustomWallpaper(customWallpaper); } 
        else { document.getElementById('phone-frame').style.background = ''; }
    }
    function loadTheme() { const savedTheme = localStorage.getItem('os_theme') || 'theme-default'; applyTheme(savedTheme); }
    
    function applyIconStyle(styleName) {
        document.body.className = document.body.className.replace(/style-[\w-]+/g, '').trim();
        document.body.classList.add(styleName);
        localStorage.setItem('os_icon_style', styleName);
        document.querySelectorAll('.icon-style-btn').forEach(btn => btn.classList.toggle('active', btn.getAttribute('onclick').includes(styleName)));
    }
    function loadIconStyle() { const savedStyle = localStorage.getItem('os_icon_style') || 'style-glass'; applyIconStyle(savedStyle); }

    function handleWallpaperUpload(files) { if (!files.length) return; const file = files[0]; const reader = new FileReader(); reader.onload = (e) => { const dataUrl = e.target.result; localStorage.setItem('os_custom_wallpaper', dataUrl); applyCustomWallpaper(dataUrl); alert('è‡ªå®šä¹‰å£çº¸å·²è®¾ç½®ï¼'); }; reader.readAsDataURL(file); }
    function applyCustomWallpaper(url) { const frame = document.getElementById('phone-frame'); if (frame) { frame.style.background = `url(${url}) center/cover no-repeat`; } }
    function removeCustomWallpaper() { if (localStorage.getItem('os_custom_wallpaper')) { localStorage.removeItem('os_custom_wallpaper'); document.getElementById('phone-frame').style.background = ''; alert('è‡ªå®šä¹‰å£çº¸å·²ç§»é™¤ã€‚'); applyTheme(localStorage.getItem('os_theme') || 'theme-default'); } else { alert('æ²¡æœ‰è®¾ç½®è‡ªå®šä¹‰å£çº¸ã€‚'); } }
    function loadCustomWallpaper() { const customWallpaper = localStorage.getItem('os_custom_wallpaper'); if (customWallpaper) { applyCustomWallpaper(customWallpaper); } }

    // --- Data Management & AI Formatting ---
    function exportData() { const allData = {}; for (let i = 0; i < localStorage.length; i++){ const key = localStorage.key(i); if (key.startsWith('os_')) { allData[key] = localStorage.getItem(key); } } const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const date = new Date().toISOString().slice(0, 10); a.download = `lingxi_os_backup_${date}.json`; a.click(); URL.revokeObjectURL(url); alert('å¤‡ä»½æ–‡ä»¶å·²å¼€å§‹ä¸‹è½½ï¼'); }
    function handleImport(files) { if (!files.length) return; const file = files[0]; const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); if (confirm('è¿™å°†è¦†ç›–æ‰€æœ‰å½“å‰æ•°æ®ï¼Œç¡®å®šè¦ä»æ–‡ä»¶æ¢å¤å—ï¼Ÿ')) { Object.keys(data).forEach(key => { if (key.startsWith('os_')) { localStorage.setItem(key, data[key]); } }); alert('æ•°æ®æ¢å¤æˆåŠŸï¼åº”ç”¨å³å°†åˆ·æ–°ã€‚'); location.reload(); } } catch (err) { alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–å·²æŸåã€‚'); } }; reader.readAsText(file); }
    function escapeHTML(str) { if (!str) return ''; return str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m]));}
    function formatAIResponse(text) { return escapeHTML(text).replace(/\n/g, '<br>'); }
    
    // --- Global & API Settings ---
    function saveMasterPrompt() { localStorage.setItem('os_master_prompt', document.getElementById('master-prompt-input').value); alert('å…¨å±€æŒ‡ä»¤å·²ä¿å­˜'); }
    function loadMasterPrompt() { document.getElementById('master-prompt-input').value = localStorage.getItem('os_master_prompt') || ''; }
    async function fetchModels() { const url = (document.getElementById('cfg-url').value || "https://api.openai.com/v1").replace(/\/$/,""); const key = document.getElementById('cfg-key').value; const btn = document.getElementById('btn-fetch'); if(!key) return alert('è¯·è¾“å…¥ API Key'); btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ‹‰å–ä¸­...'; try { const res = await fetch(url+'/models', {headers:{'Authorization':`Bearer ${key}`}}); const data = await res.json(); const models = data.data || data; if (!Array.isArray(models)) { const errorMsg = data.error ? data.error.message : JSON.stringify(data); throw new Error(`APIæœªè¿”å›æœ‰æ•ˆçš„æ¨¡å‹åˆ—è¡¨ã€‚æœåŠ¡å™¨å“åº”: ${errorMsg}`); } const sel = document.getElementById('cfg-model'); sel.innerHTML = ''; models.forEach(m => sel.innerHTML += `<option value="${m.id}">${m.id}</option>`); alert(`æˆåŠŸè·å– ${models.length} ä¸ªæ¨¡å‹ï¼`); } catch(e) { alert('æ‹‰å–å¤±è´¥: ' + e.message); } finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-sync"></i> æ‹‰å–æ¨¡å‹åˆ—è¡¨'; } }
    function saveConfig() { localStorage.setItem('os_url', document.getElementById('cfg-url').value); localStorage.setItem('os_key', document.getElementById('cfg-key').value); localStorage.setItem('os_model', document.getElementById('cfg-model').value); alert('API é…ç½®å·²ä¿å­˜'); }
    function loadConfig() { document.getElementById('cfg-url').value = localStorage.getItem('os_url') || ''; document.getElementById('cfg-key').value = localStorage.getItem('os_key') || ''; const savedModel = localStorage.getItem('os_model'); if(savedModel) document.getElementById('cfg-model').innerHTML = `<option>${savedModel}</option>`; }
    
    // --- Character App ---
    function openCharForm(char = null) { const modal = document.getElementById('char-form-modal'); const idInput = document.getElementById('char-form-id'); const nameInput = document.getElementById('char-form-name'); const descInput = document.getElementById('char-form-desc'); const title = document.getElementById('char-form-title'); if (char) { title.innerText = 'ç¼–è¾‘è§’è‰²'; idInput.value = char.id; nameInput.value = char.name; descInput.value = char.desc; } else { title.innerText = 'æ–°å»ºè§’è‰²'; idInput.value = ''; nameInput.value = ''; descInput.value = ''; } modal.style.display = 'block'; }
    function closeCharForm() { document.getElementById('char-form-modal').style.display = 'none'; }
    function saveChar() { const id = document.getElementById('char-form-id').value; const name = document.getElementById('char-form-name').value.trim(); if (!name) return alert('è§’è‰²åä¸èƒ½ä¸ºç©º'); const desc = document.getElementById('char-form-desc').value.trim(); let roles = JSON.parse(localStorage.getItem('os_chars') || '[]'); if (id) { roles = roles.map(role => role.id == id ? { ...role, name, desc } : role ); } else { roles.push({ id: Date.now(), name, desc }); } localStorage.setItem('os_chars', JSON.stringify(roles)); renderCharList(); closeCharForm(); }
    function renderCharList() { const div = document.getElementById('char-list'); if (!div) return; div.innerHTML = ''; JSON.parse(localStorage.getItem('os_chars')||'[]').forEach(r => { div.innerHTML += `<div class="card" style="display:flex; justify-content:space-between; align-items:center;"><div><b>${r.name}</b><br><small>${r.desc}</small></div><i class="fas fa-edit" style="cursor:pointer; color:var(--accent-color);" onclick='editChar(${r.id})'></i></div>`; }); }
    function editChar(id) { const roles = JSON.parse(localStorage.getItem('os_chars') || '[]'); const char = roles.find(r => r.id === id); if (char) openCharForm(char); }

    // --- I-Ching Divination App ---
    function showYijingMenu() { document.getElementById('yijing-menu').style.display = 'grid'; document.getElementById('yijing-input-2').style.display = 'none'; document.getElementById('yijing-input-3').style.display = 'none'; }
    function showNumberInput() { document.getElementById('yijing-menu').style.display = 'none'; document.getElementById('yijing-input-2').style.display = 'block'; }
    function showThreeNumberInput() { document.getElementById('yijing-menu').style.display = 'none'; document.getElementById('yijing-input-3').style.display = 'block'; }
    function processDivination(type, q) {
        let up, low, dong, methodDesc;
        if (type === 'random') {
            const n1 = Math.floor(Math.random() * 900) + 100; const n2 = Math.floor(Math.random() * 900) + 100; up = n1 % 8 || 8; low = n2 % 8 || 8; dong = (n1 + n2) % 6 || 6; methodDesc = `éšæœºæ•°: ${n1},${n2}`;
        } else if (type === 'time') {
            const now = new Date(); const year = now.getFullYear(); const month = now.getMonth() + 1; const day = now.getDate(); const hour = now.getHours(); const numUpper = year + month + day; const numLower = year + month + day + hour; up = numUpper % 8 || 8; low = numLower % 8 || 8; dong = numLower % 6 || 6; methodDesc = `æ—¶é—´: ${month}æœˆ${day}æ—¥${hour}æ—¶`;
        }
        const rec = {id:Date.now(), time:new Date().toLocaleString(), q, up, low, dong, methodDesc, note:"", aiInterpret:"", aiEvaluate:""}; const list = JSON.parse(localStorage.getItem('os_yijing')||'[]'); list.unshift(rec); localStorage.setItem('os_yijing', JSON.stringify(list)); showYijingMenu(); renderYijingHistory(); openDetail(rec.id);
    }
    function startDivination(type) { 
        if (type === 'number2') {
            const q = document.getElementById('yijing-q-2').value.trim(); const n1 = parseInt(document.getElementById('yijing-n1').value); const n2 = parseInt(document.getElementById('yijing-n2').value); if (!q) return alert('è¯·å¡«å†™æ‰€å ä½•äº‹'); if (!n1 || !n2) return alert('è¯·å¡«å†™æ•°å­—'); const up = n1 % 8 || 8; const low = n2 % 8 || 8; const dong = (n1 + n2) % 6 || 6; const methodDesc = `æ•°: ${n1},${n2}`; const rec = {id:Date.now(), time:new Date().toLocaleString(), q, up, low, dong, methodDesc, note:"", aiInterpret:"", aiEvaluate:""}; const list = JSON.parse(localStorage.getItem('os_yijing')||'[]'); list.unshift(rec); localStorage.setItem('os_yijing', JSON.stringify(list)); showYijingMenu(); renderYijingHistory(); openDetail(rec.id); 
        } else if (type === 'number3') {
            const q = document.getElementById('yijing-q-3').value.trim(); const n1 = parseInt(document.getElementById('yijing-n3-1').value); const n2 = parseInt(document.getElementById('yijing-n3-2').value); const n3 = parseInt(document.getElementById('yijing-n3-3').value); if (!q) return alert('è¯·å¡«å†™æ‰€å ä½•äº‹'); if (!n1 || !n2 || !n3) return alert('è¯·å¡«å†™æ‰€æœ‰ä¸‰ä¸ªæ•°å­—'); const up = n1 % 8 || 8; const low = n2 % 8 || 8; const dong = n3 % 6 || 6; const methodDesc = `ä¸‰æ•°: ${n1},${n2},${n3}`; const rec = {id:Date.now(), time:new Date().toLocaleString(), q, up, low, dong, methodDesc, note:"", aiInterpret:"", aiEvaluate:""}; const list = JSON.parse(localStorage.getItem('os_yijing')||'[]'); list.unshift(rec); localStorage.setItem('os_yijing', JSON.stringify(list)); showYijingMenu(); renderYijingHistory(); openDetail(rec.id); 
        } else if (type === 'random') { openCustomPrompt("ã€éšæœºèµ·å¦ã€‘å¿ƒä¸­æ‰€å ä½•äº‹ï¼Ÿ", "ä¾‹å¦‚ï¼šä»Šæ—¥è¿åŠ¿...", (val) => { if (val) processDivination('random', val); }); } else if (type === 'time') { openCustomPrompt("ã€æ—¶é—´èµ·å¦ã€‘å¿ƒä¸­æ‰€å ä½•äº‹ï¼Ÿ", "ä¸å¡«åˆ™é»˜è®¤ä¸ºé—®æ—¶", (val) => { if (val !== null) { const q = val === "" ? `é—®æ—¶: ${new Date().toLocaleString()}` : val; processDivination('time', q); } }); }
    }
    function renderGuaResult(content, type) { if (!content) return ''; return `<button class="toggle-btn" onclick="toggleCollapsible(this)"><span>${type === 'interpret' ? 'è§£å¦åˆ†æ' : 'AI è¯„ä»·'}</span><i class="fas fa-chevron-down"></i></button><div class="content expanded">${formatAIResponse(content)}</div>`; }
    function toggleCollapsible(btn) { const content = btn.nextElementSibling; const icon = btn.querySelector('.fas'); content.classList.toggle('expanded'); if (content.classList.contains('expanded')) { icon.style.transform = "rotate(0deg)"; } else { icon.style.transform = "rotate(-90deg)"; } }
    function openDetail(id) { currentYijingId = id; const rec = JSON.parse(localStorage.getItem('os_yijing')).find(r => r.id===id); document.getElementById('yijing-detail').style.display = 'flex'; document.getElementById('yijing-home').style.display = 'none'; document.getElementById('detail-q').innerText = rec.q; document.getElementById('detail-meta').innerText = `${rec.methodDesc} | åŠ¨: ${rec.dong}`; const sel = document.getElementById('detail-role'); sel.innerHTML = '<option value="">é»˜è®¤AI</option>'; JSON.parse(localStorage.getItem('os_chars')||'[]').forEach(r => sel.innerHTML += `<option value='${JSON.stringify(r)}'>${r.name}</option>`); document.getElementById('detail-note').value = rec.note || ''; document.getElementById('ai-interpret-res').innerHTML = renderGuaResult(rec.aiInterpret, 'interpret'); document.getElementById('ai-evaluate-res').innerHTML = renderGuaResult(rec.aiEvaluate, 'evaluate'); drawGua(rec.up, rec.low, rec.dong); }
    function closeDetail() { document.getElementById('yijing-detail').style.display='none'; document.getElementById('yijing-home').style.display='block'; currentYijingId=null; }
    function drawGua(upVal, lowVal, dongIdx) { const benFull = [...trigramBits[upVal], ...trigramBits[lowVal]]; const huUpBits = [benFull[1], benFull[2], benFull[3]], huLowBits = [benFull[2], benFull[3], benFull[4]]; const huUpVal = findTrigramVal(huUpBits), huLowVal = findTrigramVal(huLowBits); const changeBitIdx = 6-dongIdx; const bianFull = [...benFull]; bianFull[changeBitIdx] = 1 - bianFull[changeBitIdx]; const bianUpVal = findTrigramVal(bianFull.slice(0,3)), bianLowVal = findTrigramVal(bianFull.slice(3,6)); document.getElementById('detail-gua-area').innerHTML = `<div class="gua-visual-row"><div class="gua-col"><div class="gua-title">æœ¬å¦</div><div class="gua-lines-box">${renderLinesHtml(benFull, dongIdx)}</div><div class="gua-name">${HEXAGRAM_DATA[`${upVal}_${lowVal}`] || 'æœªçŸ¥'}</div></div><div class="gua-col"><div class="gua-title">äº’å¦</div><div class="gua-lines-box">${renderLinesHtml([...huUpBits,...huLowBits], -1)}</div><div class="gua-name">${HEXAGRAM_DATA[`${huUpVal}_${huLowVal}`] || 'æœªçŸ¥'}</div></div><div class="gua-col"><div class="gua-title">å˜å¦</div><div class="gua-lines-box">${renderLinesHtml(bianFull, dongIdx)}</div><div class="gua-name" style="color:#ff3b30">${HEXAGRAM_DATA[`${bianUpVal}_${bianLowVal}`] || 'æœªçŸ¥'}</div></div></div>`; }
    function renderLinesHtml(bits, moveLine) { let html = ''; bits.forEach((bit, i) => { const lineNum = 6 - i; const isMoving = (lineNum === moveLine); const type = bit === 1 ? 'yang' : 'yin'; const moveClass = isMoving ? 'moving' : ''; const content = bit === 1 ? '' : '<span></span><span></span>'; html += `<div class="line ${type} ${moveClass}">${content}</div>`; }); return html; }
    function findTrigramVal(arr) { const str = arr.join(''); for(let k in trigramBits) { if(trigramBits[k].join('') === str && k!=='0') return parseInt(k); } return 8; }
    function toggleYijingEditMode() { isYijingEditMode = !isYijingEditMode; document.getElementById('yijing-batch-toolbar').style.display = isYijingEditMode ? 'flex' : 'none'; document.getElementById('btn-edit-yijing').innerText = isYijingEditMode ? 'å®Œæˆ' : 'ç®¡ç†'; renderYijingHistory(); }
    function renderYijingHistory() { const div = document.getElementById('yijing-history'); div.innerHTML = ''; const data = JSON.parse(localStorage.getItem('os_yijing')||'[]'); if(data.length===0) { div.innerHTML = '<div style="text-align:center;color:var(--text-sub);padding:10px;">æš‚æ— è®°å½•</div>'; return; } data.forEach(item => { if (isYijingEditMode) { div.innerHTML += `<div class="check-wrap"><input type="checkbox" class="yijing-check" value="${item.id}"><div class="check-content">${item.q} <br><small>${item.time.split(' ')[0]}</small></div></div>`; } else { div.innerHTML += `<div onclick="openDetail(${item.id})" style="padding:12px 0; border-bottom:1px solid var(--border-color);cursor:pointer;">${item.q} <small style="float:right;"><i class="fas fa-chevron-right"></i></small></div>`; } }); }
    function deleteSelectedYijing() { const checks = document.querySelectorAll('.yijing-check:checked'); if (checks.length === 0) return alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è®°å½•'); if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${checks.length} æ¡è®°å½•å—ï¼Ÿ`)) { const idsToDelete = Array.from(checks).map(c => parseInt(c.value)); let history = JSON.parse(localStorage.getItem('os_yijing') || '[]'); history = history.filter(item => !idsToDelete.includes(item.id)); localStorage.setItem('os_yijing', JSON.stringify(history)); toggleYijingEditMode(); } }
    async function callAI(mode) { const key = localStorage.getItem('os_key'); if(!key) return alert('è¯·é…ç½®Key'); const btn = mode==='interpret' ? document.getElementById('btn-interpret') : document.getElementById('btn-evaluate'); const targetDiv = mode==='interpret' ? document.getElementById('ai-interpret-res') : document.getElementById('ai-evaluate-res'); btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ€è€ƒä¸­...'; targetDiv.style.display = 'block'; targetDiv.innerHTML = "æ­£åœ¨è¿æ¥AIï¼Œè¯·ç¨å€™..."; try { const list = JSON.parse(localStorage.getItem('os_yijing')); const rec = list.find(r=>r.id===currentYijingId); const url = (localStorage.getItem('os_url') || "https://api.openai.com/v1").replace(/\/$/,''); const model = localStorage.getItem('os_model') || "gpt-3.5-turbo"; const benFull=[...trigramBits[rec.up],...trigramBits[rec.low]]; const huUpBits=[benFull[1],benFull[2],benFull[3]],huLowBits=[benFull[2],benFull[3],benFull[4]]; const huUpVal=findTrigramVal(huUpBits),huLowVal=findTrigramVal(huLowBits); const changeBitIdx=6-rec.dong; const bianFull=[...benFull];bianFull[changeBitIdx]=1-bianFull[changeBitIdx]; const bianUpVal=findTrigramVal(bianFull.slice(0,3)),bianLowVal=findTrigramVal(bianFull.slice(3,6)); const benName=HEXAGRAM_DATA[`${rec.up}_${rec.low}`],huName=HEXAGRAM_DATA[`${huUpVal}_${huLowVal}`],bianName=HEXAGRAM_DATA[`${bianUpVal}_${bianLowVal}`]; let userPrompt; const promptHeader=`ã€æ¢…èŠ±æ˜“æ•°æ’ç›˜ç»“æœã€‘\næ‰€å ä¹‹äº‹ï¼š${rec.q}\nèµ·å¦æ–¹å¼ï¼š${rec.methodDesc || 'æ•°å­—èµ·å¦'}\næœ¬å¦ï¼š${benName}(ç¬¬ ${rec.dong} çˆ»åŠ¨)\näº’å¦ï¼š${huName}\nå˜å¦ï¼š${bianName}\n\n`; if(mode==='interpret'){ userPrompt=promptHeader+"è¯·æ ¹æ®ä»¥ä¸Šå®Œæ•´çš„å¦è±¡ä¿¡æ¯ä¸ºæˆ‘è¯¦ç»†è§£è¯»ã€‚"; }else{ const note=document.getElementById('detail-note').value; if(!note)throw new Error("è¯·å…ˆå¡«å†™æ‚¨çš„ç¬”è®°ã€‚"); userPrompt=promptHeader+`ã€æˆ‘çš„ç¬”è®°ã€‘\n"${note}"\n\nè¯·ä½œä¸ºè€å¸ˆï¼ŒåŸºäºå®Œæ•´çš„å¦è±¡ä¿¡æ¯ï¼Œç‚¹è¯„æˆ‘çš„ç¬”è®°æ˜¯å¦å‡†ç¡®ï¼Ÿ`; } const masterPrompt = localStorage.getItem('os_master_prompt') || ''; let rolePrompt = "ä½ æ˜¯ä¸€ä½ç²¾é€šæ¢…èŠ±æ˜“æ•°çš„å›½å­¦å¤§å¸ˆã€‚"; const roleJSON=document.getElementById('detail-role').value; if(roleJSON){ const r=JSON.parse(roleJSON); rolePrompt=`è¯·ä¸¥æ ¼æ‰®æ¼”ä»¥ä¸‹è§’è‰²ï¼š\nã€è§’è‰²åã€‘: ${r.name}\nã€è§’è‰²è®¾å®šã€‘: ${r.desc}\nç”¨è¿™ä¸ªè§’è‰²çš„å£å»å’ŒçŸ¥è¯†èƒŒæ™¯æ¥å›ç­”ã€‚`; } const finalSystemPrompt = masterPrompt ? `${masterPrompt}\n\n---\n\n${rolePrompt}` : rolePrompt; const res=await fetch(url+'/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${key}`},body:JSON.stringify({model,messages:[{role:"system",content:finalSystemPrompt},{role:"user",content:userPrompt}]})}); if(!res.ok)throw new Error(`API è¯·æ±‚å¤±è´¥: ${res.status}`); const data=await res.json(); if(data.error)throw new Error(data.error.message); const reply=data.choices[0].message.content; targetDiv.innerHTML = renderGuaResult(reply, mode); const idx=list.findIndex(r=>r.id===currentYijingId); if(mode==='interpret')list[idx].aiInterpret=reply; else list[idx].aiEvaluate=reply; localStorage.setItem('os_yijing',JSON.stringify(list));} catch(e){ targetDiv.innerText="è¯·æ±‚å‡ºé”™ï¼š"+e.message; } finally { btn.disabled=false; btn.innerHTML=mode==='interpret'?'è¯·å¤§å¸ˆæŒ‡ç‚¹':'è®© AI è¯„ä»·'; }}
    function saveNote() { const list=JSON.parse(localStorage.getItem('os_yijing')); const idx=list.findIndex(r=>r.id===currentYijingId); list[idx].note = document.getElementById('detail-note').value; localStorage.setItem('os_yijing', JSON.stringify(list)); alert('ç¬”è®°å·²ä¿å­˜'); }
    
    // --- Diary App ---
    function updateDiaryRolePicker() { const sel = document.getElementById('diary-role'); sel.innerHTML = '<option value="">é»˜è®¤AI</option>'; JSON.parse(localStorage.getItem('os_chars')||'[]').forEach(r => sel.innerHTML += `<option value='${JSON.stringify(r)}'>${r.name}</option>`); }
    function renderDiaryFeed() { const div = document.getElementById('diary-feed'); div.innerHTML = ''; const rawData = JSON.parse(localStorage.getItem('os_diary')||'[]'); const grouped = {}; rawData.forEach(d => { const dateKey = d.date || 'å¾€æ—¥è®°å¿†'; if (!grouped[dateKey]) grouped[dateKey] = []; grouped[dateKey].push(d); }); Object.keys(grouped).sort().reverse().forEach(date => { const isToday = date === new Date().toISOString().split('T')[0]; const displayDate = isToday ? `${date} (ä»Šå¤©)` : date; const header = document.createElement('div'); header.className = 'diary-date-header'; header.innerHTML = `<span><i class="fas fa-calendar-day"></i> ${displayDate}</span> <i class="fas fa-chevron-down"></i>`; header.onclick = function() { const groupDiv = this.nextElementSibling; const icon = this.querySelector('.fas'); if (groupDiv.classList.contains('collapsed')) { groupDiv.classList.remove('collapsed'); icon.style.transform = 'rotate(0deg)'; } else { groupDiv.classList.add('collapsed'); icon.style.transform = 'rotate(-90deg)'; } }; div.appendChild(header); const groupDiv = document.createElement('div'); groupDiv.className = 'diary-group'; grouped[date].forEach(d => { groupDiv.innerHTML += `<div class="card" style="border-left:3px solid ${d.type==='user'? '#555' : 'var(--accent-color)'}"><b>${d.name}</b><br><div style="margin-top:5px;">${formatAIResponse(d.text)}</div></div>`; }); div.appendChild(groupDiv); }); }
    async function sendDiary() { const text = document.getElementById('diary-input').value; if(!text) return; const key = localStorage.getItem('os_key'); if(!key) return alert('è¯·é…ç½®Key'); const btn = document.getElementById('btn-send-diary'); const status = document.getElementById('diary-status'); btn.disabled = true; status.style.display='block'; status.innerText = 'å‘é€ä¸­...'; let rolePrompt = "ä½ æ˜¯ä¸€ä½æ¸©æš–çš„æ—¥è®°ç¬”å‹ã€‚", aiName = "AI"; const roleJSON = document.getElementById('diary-role').value; if(roleJSON) { const r = JSON.parse(roleJSON); rolePrompt = `è¯·ä¸¥æ ¼æ‰®æ¼”ä»¥ä¸‹è§’è‰²ï¼š\nã€è§’è‰²åã€‘: ${r.name}\nã€è§’è‰²è®¾å®šã€‘: ${r.desc}\nç”¨è¿™ä¸ªè§’è‰²çš„å£å»å›å¤æ—¥è®°ã€‚`; aiName = r.name; } const todayStr = new Date().toISOString().split('T')[0]; saveDiaryEntry('user', text, 'æˆ‘', todayStr); try { const masterPrompt = localStorage.getItem('os_master_prompt') || ''; const finalSystemPrompt = masterPrompt ? `${masterPrompt}\n\n---\n\n${rolePrompt}` : rolePrompt; const url = (localStorage.getItem('os_url') || "https://api.openai.com/v1").replace(/\/$/,''); const model = localStorage.getItem('os_model') || "gpt-3.5-turbo"; status.innerText = `æ­£åœ¨è¿æ¥ ${model}...`; const res = await fetch(url+'/chat/completions', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` }, body: JSON.stringify({ model, messages: [{role:"system",content:finalSystemPrompt},{role:"user",content:text}] }) }); if(!res.ok) throw new Error(`API Error: ${res.status}`); const data = await res.json(); if(data.error) throw new Error(data.error.message); saveDiaryEntry('ai', data.choices[0].message.content, aiName, todayStr); document.getElementById('diary-input').value = ''; } catch(e) { alert('AIå›å¤å¤±è´¥: ' + e.message); } finally { btn.disabled = false; status.style.display='none'; } }
    function saveDiaryEntry(type, text, name, date) { const list = JSON.parse(localStorage.getItem('os_diary')||'[]'); list.unshift({type, text, name, date}); localStorage.setItem('os_diary', JSON.stringify(list)); renderDiaryFeed(); }

    // --- Chat App (Streaming & Actions) ---
    function migrateChatData() { const oldChat = localStorage.getItem('os_chats'); const newChat = localStorage.getItem('os_chat_sessions'); if (oldChat && !newChat) { try { const oldMessages = JSON.parse(oldChat); if (Array.isArray(oldMessages) && oldMessages.length > 0) { const sessionId = Date.now(); const sessions = {}; sessions[sessionId] = oldMessages; localStorage.setItem('os_chat_sessions', JSON.stringify(sessions)); localStorage.setItem('os_current_chat_id', sessionId); } } catch(e) { console.error("Failed to migrate chat data", e); } localStorage.removeItem('os_chats'); } }
    function getAllChatSessions() { return JSON.parse(localStorage.getItem('os_chat_sessions') || '{}'); }
    function getCurrentChatId() { return localStorage.getItem('os_current_chat_id'); }
    function updateChatRolePicker() { const sel = document.getElementById('chat-role'); sel.innerHTML = '<option value="">é»˜è®¤AI</option>'; JSON.parse(localStorage.getItem('os_chars')||'[]').forEach(r => sel.innerHTML += `<option value='${JSON.stringify(r)}'>${r.name}</option>`); }
    function createNewChatSession() { const sessions = getAllChatSessions(); const newId = Date.now(); sessions[newId] = []; localStorage.setItem('os_chat_sessions', JSON.stringify(sessions)); localStorage.setItem('os_current_chat_id', newId); renderCurrentChatHistory(); updateSessionTriggerText(); }
    
    // Updated Session Management with Custom Modal
    function openSessionList() {
        const modal = document.getElementById('session-list');
        const overlay = document.getElementById('session-list-overlay');
        const sessions = getAllChatSessions();
        const currentId = getCurrentChatId();
        modal.innerHTML = '';
        const newBtn = document.createElement('div');
        newBtn.className = 'modal-list-item';
        newBtn.style.textAlign = 'center';
        newBtn.style.color = 'var(--accent-color)';
        newBtn.innerHTML = '<i class="fas fa-plus"></i> åˆ›å»ºæ–°å¯¹è¯';
        newBtn.onclick = () => { createNewChatSession(); overlay.classList.remove('show'); };
        modal.appendChild(newBtn);
        const sortedIds = Object.keys(sessions).sort((a,b) => b-a);
        sortedIds.forEach(id => {
            const firstUserMsg = sessions[id].find(m => m.type === 'user');
            const sessionName = firstUserMsg ? firstUserMsg.text.substring(0, 15) + (firstUserMsg.text.length>15?'...':'') : 'æ–°å¯¹è¯';
            const date = new Date(parseInt(id)).toLocaleString();
            const item = document.createElement('div');
            item.className = 'modal-list-item ' + (id === currentId ? 'active' : '');
            item.innerHTML = `<div>${escapeHTML(sessionName)}</div><small>${date}</small>`;
            item.onclick = () => { localStorage.setItem('os_current_chat_id', id); renderCurrentChatHistory(); updateSessionTriggerText(); overlay.classList.remove('show'); };
            modal.appendChild(item);
        });
        overlay.classList.add('show');
    }

    function updateSessionTriggerText() {
        const sessions = getAllChatSessions();
        const currentId = getCurrentChatId();
        const history = sessions[currentId] || [];
        const firstUserMsg = history.find(m => m.type === 'user');
        const sessionName = firstUserMsg ? firstUserMsg.text.substring(0, 8) + (firstUserMsg.text.length>8?'...':'') : 'æ–°å¯¹è¯';
        document.getElementById('chat-session-name').innerText = sessionName;
    }
    
    function renderCurrentChatHistory() { 
        const feed = document.getElementById('chat-feed'); 
        feed.innerHTML = ''; 
        let currentId = getCurrentChatId(); 
        const sessions = getAllChatSessions(); 
        if (!currentId || !sessions[currentId]) { createNewChatSession(); currentId = getCurrentChatId(); } 
        const history = sessions[currentId] || []; 
        const totalChars = history.reduce((acc, msg) => acc + msg.text.length, 0);
        document.getElementById('chat-token-display').innerText = `Est. Tokens: ${Math.ceil(totalChars)}`;

        history.forEach((msg, index) => { 
            const div = document.createElement('div'); 
            div.className = `chat-bubble ${msg.type}`; 
            let htmlContent = formatAIResponse(msg.text);
            if (msg.type === 'ai') {
                htmlContent += `<div class="chat-actions"><span class="chat-action-btn" onclick="regenerateChatMsg(${index})" title="é‡æ–°ç”Ÿæˆ"><i class="fas fa-sync-alt"></i></span><span class="chat-action-btn" onclick="deleteChatMsg(${index})" title="åˆ é™¤"><i class="fas fa-trash"></i></span></div>`;
            }
            div.innerHTML = htmlContent; 
            feed.appendChild(div); 
        }); 
        feed.scrollTop = feed.scrollHeight; 
    }

    function deleteChatMsg(index) {
        if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) return;
        const sessions = getAllChatSessions();
        const currentId = getCurrentChatId();
        if (sessions[currentId]) {
            sessions[currentId].splice(index, 1);
            localStorage.setItem('os_chat_sessions', JSON.stringify(sessions));
            renderCurrentChatHistory();
        }
    }

    function regenerateChatMsg(index) {
        const sessions = getAllChatSessions();
        const currentId = getCurrentChatId();
        const history = sessions[currentId];
        let userMsgText = "";
        for (let i = index - 1; i >= 0; i--) { if (history[i].type === 'user') { userMsgText = history[i].text; break; } }
        if (!userMsgText) return alert("æ‰¾ä¸åˆ°å¯¹åº”çš„ä¸Šæ–‡ï¼Œæ— æ³•é‡æ–°ç”Ÿæˆã€‚");
        history.splice(index, 1);
        localStorage.setItem('os_chat_sessions', JSON.stringify(sessions));
        renderCurrentChatHistory();
        triggerAIStream(userMsgText);
    }

    async function triggerAIStream(text) {
        const key = localStorage.getItem('os_key'); if(!key) return alert('è¯·é…ç½®Key'); 
        const btn = document.getElementById('btn-chat-send'); btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; 
        const feed = document.getElementById('chat-feed'); 
        let currentBubble = document.createElement('div'); currentBubble.className = 'chat-bubble ai'; feed.appendChild(currentBubble); feed.scrollTop = feed.scrollHeight; 
        let fullReply = ""; 
        try { 
            let rolePrompt = "ä½ æ˜¯ä¸€ä¸ªé€šç”¨AIåŠ©ç†ã€‚"; const roleJSON = document.getElementById('chat-role').value; if(roleJSON) { const r = JSON.parse(roleJSON); rolePrompt = `è¯·ä¸¥æ ¼æ‰®æ¼”ä»¥ä¸‹è§’è‰²ï¼š\nã€è§’è‰²åã€‘: ${r.name}\nã€è§’è‰²è®¾å®šã€‘: ${r.desc}\nç”¨è¿™ä¸ªè§’è‰²çš„å£å»å¯¹è¯ã€‚`; } 
            const chatMode = localStorage.getItem('os_chat_mode') || 'casual'; let systemInstruction = ""; if (chatMode === 'casual') { systemInstruction = "\n\n[System Instruction: IMPERATIVE]\n1. You are chatting on a messenger app. REPLY AS A CLOSE FRIEND.\n2. Keep sentences SHORT and CASUAL. Do NOT write long paragraphs.\n3. STRICTLY FORBIDDEN: Markdown headers (###), Bold (**), Bullet points.\n4. Use plain text only. Split distinct thoughts into separate paragraphs.\n5. Tone: Relaxed, colloquial, human-like."; } 
            const masterPrompt = localStorage.getItem('os_master_prompt') || ''; const finalSystemPrompt = (masterPrompt ? `${masterPrompt}\n\n---\n\n${rolePrompt}` : rolePrompt) + systemInstruction; 
            const currentId = getCurrentChatId(); const sessions = getAllChatSessions(); const history = sessions[currentId] || []; 
            const messages = history.map(m => ({ role: m.type === 'user' ? 'user' : 'assistant', content: m.text })); messages.unshift({role: "system", content: finalSystemPrompt}); 
            const url = (localStorage.getItem('os_url') || "https://api.openai.com/v1").replace(/\/$/,''); const model = localStorage.getItem('os_model') || "gpt-3.5-turbo"; 
            const res = await fetch(url+'/chat/completions', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` }, body: JSON.stringify({ model, messages, stream: true }) }); 
            if(!res.ok) throw new Error(`API Error: ${res.status}`); 
            const reader = res.body.getReader(); const decoder = new TextDecoder("utf-8"); 
            while (true) { 
                const { done, value } = await reader.read(); if (done) break; 
                const chunk = decoder.decode(value, { stream: true }); const lines = chunk.split('\n'); 
                for (const line of lines) { 
                    if (line.startsWith('data: ')) { 
                        const jsonStr = line.slice(6); if (jsonStr === '[DONE]') break; 
                        try { 
                            const json = JSON.parse(jsonStr); const content = json.choices[0].delta.content || ""; fullReply += content; 
                            if (chatMode === 'casual' && fullReply.includes('\n\n')) { 
                                const parts = fullReply.split('\n\n'); const lastCompletePart = parts.slice(0, -1).join('\n\n'); 
                                currentBubble.innerHTML = formatAIResponse(lastCompletePart); saveChatMessage('ai', lastCompletePart.trim()); 
                                fullReply = parts[parts.length - 1]; currentBubble = document.createElement('div'); currentBubble.className = 'chat-bubble ai'; feed.appendChild(currentBubble); 
                            } 
                            currentBubble.innerHTML = formatAIResponse(fullReply); feed.scrollTop = feed.scrollHeight; 
                        } catch (e) { console.error("Stream parse error", e); } 
                    } 
                } 
            } 
            if (fullReply.trim()) { saveChatMessage('ai', fullReply.trim()); renderCurrentChatHistory(); updateSessionTriggerText(); } else { if(currentBubble.innerHTML === "") currentBubble.remove(); } 
        } catch (e) { currentBubble.innerHTML = `è¿æ¥æ–­å¼€ï¼š${e.message}`; saveChatMessage('ai', `[ç³»ç»Ÿé”™è¯¯] ${e.message}`); renderCurrentChatHistory(); } finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-arrow-up"></i>'; } 
    }

    async function sendChatMessage() { const input = document.getElementById('chat-input'); const text = input.value.trim(); if(!text) return; saveChatMessage('user', text); input.value = ''; renderCurrentChatHistory(); updateSessionTriggerText(); triggerAIStream(text); }
    function saveChatMessage(type, text) { const sessions = getAllChatSessions(); const currentId = getCurrentChatId(); if(!sessions[currentId]) sessions[currentId] = []; sessions[currentId].push({type, text}); localStorage.setItem('os_chat_sessions', JSON.stringify(sessions)); }
    function toggleChatMode() { const btn = document.getElementById('chat-mode-toggle'); let currentMode = localStorage.getItem('os_chat_mode') || 'casual'; const newMode = currentMode === 'casual' ? 'pro' : 'casual'; localStorage.setItem('os_chat_mode', newMode); setInitialChatModeIcon(); alert(`èŠå¤©æ¨¡å¼å·²åˆ‡æ¢ä¸ºï¼š${newMode === 'casual' ? 'æœ‹å‹é—²èŠ (çŸ­å¥/æµå¼)' : 'ä¸“ä¸šåŠ©ç† (é•¿æ–‡)'}`); }
    function setInitialChatModeIcon() { const btn = document.getElementById('chat-mode-toggle'); if (!btn) return; const currentMode = localStorage.getItem('os_chat_mode') || 'casual'; if (currentMode === 'casual') { btn.className = 'fas fa-bolt'; btn.style.color = 'var(--accent-color)'; } else { btn.className = 'fas fa-book'; btn.style.color = 'var(--text-sub)'; } }
</script>
</body>
</html>