<!-- START OF FILE ai_studio_os_v6_fixed.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çµçŠ€ OS (ç»ˆæç‰ˆ)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            /* é»˜è®¤æ·±è‰²ä¸»é¢˜å˜é‡ */
            --wallpaper: url('https://source.unsplash.com/random/800x1600/?dark,space') center/cover;
            --text-color: #fff; --text-sub: #aaa; --text-shadow: 0 2px 5px rgba(0,0,0,0.5);
            --app-bg: #111; --card-bg: #222; --input-bg: #333; --input-border: #444;
            --border-color: rgba(255,255,255,0.1); --accent-color: #0af; --icon-bg: rgba(255, 255, 255, 0.2);
        }
        /* ä¸»é¢˜å®šä¹‰ */
        body.theme-nebula { --wallpaper: url('https://source.unsplash.com/random/800x1600/?nebula,purple') center/cover; --app-bg: #1e1b2e; --card-bg: #2e2a44; --input-bg: #403a61; --accent-color: #bf55ec; }
        body.theme-forest { --wallpaper: url('https://source.unsplash.com/random/800x1600/?forest,green') center/cover; --app-bg: #172f23; --card-bg: #214232; --input-bg: #2f5d42; --accent-color: #2ed573; }
        body.theme-cream-pink { --wallpaper: linear-gradient(135deg, #fff0f5 0%, #ffd1dc 100%); --text-color: #5d4037; --text-sub: #8d6e63; --text-shadow: none; --app-bg: #fff5f8; --card-bg: rgba(255,255,255,0.7); --input-bg: rgba(255,255,255,0.9); --input-border: #ffcce0; --border-color: rgba(0,0,0,0.05); --accent-color: #ff80ab; --icon-bg: rgba(255, 128, 171, 0.4); }
        body.theme-cream-blue { --wallpaper: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); --text-color: #37474f; --text-sub: #78909c; --text-shadow: none; --app-bg: #e1f5fe; --card-bg: rgba(255,255,255,0.6); --input-bg: rgba(255,255,255,0.8); --input-border: #b3e5fc; --border-color: rgba(0,0,0,0.05); --accent-color: #29b6f6; --icon-bg: rgba(41, 182, 246, 0.3); }
        body.theme-cream-yellow { --wallpaper: linear-gradient(135deg, #fffde7 0%, #fff59d 100%); --text-color: #5d4037; --text-sub: #8d6e63; --text-shadow: none; --app-bg: #fff9c4; --card-bg: rgba(255,255,255,0.6); --input-bg: rgba(255,255,255,0.8); --input-border: #fff176; --border-color: rgba(0,0,0,0.05); --accent-color: #fbc02d; --icon-bg: rgba(251, 192, 45, 0.3); }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent; }
        html, body { margin: 0; padding: 0; height: 100vh; overflow: hidden; }
        body { background: #000; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; justify-content: center; align-items: center; }

        #phone-frame { width: 100%; height: 100%; background: var(--wallpaper); position: relative; overflow: hidden; display: flex; flex-direction: column; transition: background 0.5s ease; }

        @media (max-width: 450px) {
            body { background: var(--wallpaper); }
            #phone-frame { border-radius: 0; border: none; }
            .notch { display: none !important; }
            .status-bar { padding-top: constant(safe-area-inset-top); padding-top: env(safe-area-inset-top); } /* iOS SafeArea */
        }
        @media (min-width: 450px) { #phone-frame { max-width: 420px; max-height: 900px; border-radius: 44px; border: 12px solid #1a1a1a; box-shadow: 0 0 50px rgba(0,0,0,0.7); height: 88vh; } .notch { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 130px; height: 30px; background: #000; border-radius: 0 0 16px 16px; z-index: 20; } }

        .status-bar { height: 44px; padding: 0 24px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: var(--text-color); font-weight: 600; z-index: 10; text-shadow: var(--text-shadow); position: absolute; top:0; left:0; right:0; }
        #desktop { flex: 1; padding: 20px; padding-top: 64px; display: flex; flex-direction: column; }
        .clock-widget { padding: 20px 0 30px 10px; color: var(--text-color); text-shadow: var(--text-shadow); }
        .clock-time { font-size: 72px; font-weight: 200; line-height: 1; }
        .clock-date { font-size: 18px; margin-top: 5px; opacity: 0.8; }

        .app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px 12px; }
        .icon-wrap { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: transform 0.1s; }
        .icon-wrap:active { transform: scale(0.95); }
        
        .frosted-icon { width: 68px; height: 68px; border-radius: 18px; background: var(--icon-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); display: flex; justify-content: center; align-items: center; font-size: 30px; color: #fff; margin-bottom: 8px; transition: background 0.3s; }
        body[class*="theme-cream"] .frosted-icon { color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2); } 
        
        .icon-name { font-size: 12px; color: var(--text-color); text-shadow: var(--text-shadow); font-weight: 500; }
        .dock { margin-top: auto; padding: 16px; background: rgba(255,255,255,0.1); border-radius: 30px; margin-bottom: 10px; backdrop-filter: blur(15px); }
        
        .app-window { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--app-bg); z-index: 100; display: flex; flex-direction: column; transform: translateY(105%); opacity: 0; transition: transform 0.35s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.35s; pointer-events: none; color: var(--text-color); }
        .app-window.active { transform: translateY(0); opacity: 1; pointer-events: auto; }
        
        .app-nav { height: 50px; margin-top: 40px; display: flex; align-items: center; padding: 0 16px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .app-title { flex: 1; text-align: center; font-size: 17px; font-weight: 600; color: var(--text-color); display: flex; flex-direction: column; justify-content: center; line-height: 1.2; }
        .app-subtitle { font-size: 11px; font-weight: normal; opacity: 0.7; }
        .nav-btn { color: var(--accent-color); font-size: 16px; width: 60px; cursor: pointer; display: flex; align-items: center; }
        .nav-btn .fas { transition: transform 0.2s; }

        .app-content { flex: 1; overflow-y: auto; padding: 16px; color: var(--text-color); }
        .card { background: var(--card-bg); border-radius: 14px; padding: 16px; margin-bottom: 16px; border: 1px solid var(--border-color); backdrop-filter: blur(10px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        input, textarea, select { width: 100%; background: var(--input-bg); border: 1px solid var(--input-border); padding: 12px; color: var(--text-color); border-radius: 10px; font-size: 16px; margin-bottom: 12px; font-family: inherit; resize: none; outline: none; transition: border 0.2s; }
        input:focus, textarea:focus { border-color: var(--accent-color); }
        
        button { width: 100%; padding: 14px; background: var(--accent-color); border: none; border-radius: 12px; color: #fff; font-size: 16px; font-weight: 600; cursor: pointer; display:flex; justify-content:center; align-items:center; gap:8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        button:disabled { background: #888; cursor: not-allowed; }
        button.secondary { background: rgba(128,128,128,0.3); color: var(--text-color); box-shadow: none; }
        button.outline { background: transparent; border: 1px solid var(--accent-color); color: var(--accent-color); box-shadow: none; }
        
        .theme-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 10px 0; }
        .theme-button { width: 100%; padding-bottom: 100%; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); cursor: pointer; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .theme-button.active { box-shadow: 0 0 0 3px var(--accent-color); border-color: #fff; }
        .theme-emoji { position: absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-size: 24px; }

        .gua-visual-row { display: flex; justify-content: space-between; margin: 10px 0 20px 0; text-align: center; }
        .gua-col { width: 32%; background: rgba(128,128,128,0.1); border-radius: 8px; padding: 10px 5px; }
        .gua-lines-box { display: flex; flex-direction: column; gap: 6px; margin: 10px auto; width: 60px; }
        .line { width: 100%; height: 8px; border-radius: 2px; }
        .line.yang { background-color: var(--text-color); } 
        .line.yin { background: transparent; display: flex; justify-content: space-between; }
        .line.yin span { display: block; width: 42%; height: 100%; background-color: var(--text-color); border-radius: 2px; }
        .line.moving.yang, .line.moving.yin span { background-color: #ff3b30; }
        
        .gua-title { font-size: 12px; font-weight: bold; color: var(--text-sub); text-transform: uppercase; }
        .gua-name { font-size: 16px; font-weight: bold; margin-top: 5px; color: var(--accent-color); }
        
        .ai-collapsible .content { display: none; margin-top:10px; border-top:1px solid var(--border-color); padding-top:10px; line-height: 1.6; }
        .ai-collapsible .content.expanded { display: block; }
        .ai-collapsible .toggle-btn { font-size: 14px; text-align:left; padding: 8px; background: rgba(128,128,128,0.1); border-radius: 8px; color: var(--accent-color); box-shadow: none; width: 100%; display: flex; justify-content: space-between; align-items: center; }
        
        .chat-feed { flex:1; overflow-y:auto; padding-bottom:10px; }
        .chat-bubble { max-width: 80%; padding: 10px 15px; border-radius: 18px; line-height: 1.6; margin-bottom: 10px; font-size: 15px; word-break: break-word; }
        .chat-bubble.user { background: var(--accent-color); color: #fff; margin-left: auto; border-bottom-right-radius: 4px; }
        .chat-bubble.ai { background: var(--card-bg); color: var(--text-color); margin-right: auto; border-bottom-left-radius: 4px; border: 1px solid var(--border-color); }
        
        .chat-input-area { display: flex; gap: 10px; padding-top:10px; border-top:1px solid var(--border-color); }

        /* New Diary Styles */
        .diary-date-header { padding: 10px; background: var(--icon-bg); margin-bottom: 10px; border-radius: 8px; font-size: 14px; font-weight: bold; color: var(--text-color); cursor: pointer; display: flex; justify-content: space-between; align-items: center; backdrop-filter: blur(5px); }
        .diary-group { display: block; }
        .diary-group.collapsed { display: none; }
        
        h4 { margin: 10px 0; color: var(--text-color); }
        small { color: var(--text-sub); }
    </style>
</head>
<body class="theme-default">

<div id="phone-frame">
    <div class="notch"></div>
    <div class="status-bar"><span id="clock-small"></span><span id="battery-status"></span></div>
    <div id="desktop">
        <div class="clock-widget"><div class="clock-time" id="clock-big"></div><div class="clock-date" id="clock-date"></div></div>
        <div class="app-grid">
            <div class="icon-wrap" onclick="openApp('app-chars')"><div class="frosted-icon" style="background: linear-gradient(135deg, #FF9A9E, #FECFEF);"><i class="fas fa-users"></i></div><div class="icon-name">è§’è‰²</div></div>
            <div class="icon-wrap" onclick="openApp('app-yijing')"><div class="frosted-icon" style="background: linear-gradient(135deg, #a18cd1, #fbc2eb);"><i class="fas fa-yin-yang"></i></div><div class="icon-name">æ¢…èŠ±æ˜“æ•°</div></div>
            <div class="icon-wrap" onclick="openApp('app-diary')"><div class="frosted-icon" style="background: linear-gradient(135deg, #84fab0, #8fd3f4);"><i class="fas fa-book-open"></i></div><div class="icon-name">äº¤æ¢æ—¥è®°</div></div>
            <div class="icon-wrap" onclick="openApp('app-chat')"><div class="frosted-icon" style="background: linear-gradient(135deg, #fccb90, #d57eeb);"><i class="fas fa-comments"></i></div><div class="icon-name">ç§äººåŠ©ç†</div></div>
        </div>
        <div class="dock app-grid"><div class="icon-wrap" onclick="openApp('app-instructions')"><div class="frosted-icon"><i class="fas fa-scroll"></i></div></div><div class="icon-wrap" onclick="openApp('app-settings')"><div class="frosted-icon"><i class="fas fa-cog"></i></div></div></div>
    </div>

    <!-- Apps -->
    <div id="app-settings" class="app-window"><div class="app-nav"><div class="nav-btn" onclick="closeApp('app-settings')"><i class="fas fa-chevron-left"></i> æ¡Œé¢</div><div class="app-title">è®¾ç½®</div><div class="nav-btn"></div></div><div class="app-content"><div class="card"><h4>å¤–è§‚ä¸»é¢˜</h4><div class="theme-grid"><div class="theme-button" style="background:#111;" data-theme="theme-default" onclick="applyTheme('theme-default')"></div><div class="theme-button" style="background:linear-gradient(45deg, #bf55ec, #614385);" data-theme="theme-nebula" onclick="applyTheme('theme-nebula')"></div><div class="theme-button" style="background:linear-gradient(45deg, #2ed573, #00b894);" data-theme="theme-forest" onclick="applyTheme('theme-forest')"></div><div class="theme-button" style="background:#fff0f5;" data-theme="theme-cream-pink" onclick="applyTheme('theme-cream-pink')"><span class="theme-emoji">ğŸŒ¸</span></div><div class="theme-button" style="background:#e0f7fa;" data-theme="theme-cream-blue" onclick="applyTheme('theme-cream-blue')"><span class="theme-emoji">â˜ï¸</span></div><div class="theme-button" style="background:#fffde7;" data-theme="theme-cream-yellow" onclick="applyTheme('theme-cream-yellow')"><span class="theme-emoji">ğŸ‹</span></div></div></div><div class="card"><h4>API è®¾ç½®</h4><input type="text" id="cfg-url" placeholder="API Host"><input type="password" id="cfg-key" placeholder="API Key"><button class="secondary" onclick="fetchModels()" id="btn-fetch" style="margin-bottom:10px;"><i class="fas fa-sync"></i> æ‹‰å–æ¨¡å‹åˆ—è¡¨</button><select id="cfg-model"></select><button onclick="saveConfig()" style="margin-top:10px;">ä¿å­˜ API é…ç½®</button></div><div class="card"><h4>æ•°æ®ç®¡ç†</h4><input type="file" id="import-file" style="display:none" onchange="handleImport(this.files)"><button class="secondary" onclick="document.getElementById('import-file').click();"><i class="fas fa-upload"></i> ä»æ–‡ä»¶æ¢å¤æ•°æ®</button><button class="secondary" onclick="exportData()" style="margin-top:10px;"><i class="fas fa-download"></i> å¤‡ä»½æ•°æ®åˆ°æ–‡ä»¶</button></div></div></div>
    
    <div id="app-chars" class="app-window"><div class="app-nav"><div class="nav-btn" onclick="closeApp('app-chars')"><i class="fas fa-chevron-left"></i></div><div class="app-title">è§’è‰²èµ„æ–™</div><div class="nav-btn" style="justify-content:flex-end;" onclick="openCharForm()"><i class="fas fa-plus"></i></div></div><div class="app-content"><div id="char-form-modal" class="card" style="display:none; border: 2px solid var(--accent-color);"><h4 id="char-form-title">æ–°å»ºè§’è‰²</h4><input type="hidden" id="char-form-id"><input type="text" id="char-form-name" placeholder="è§’è‰²å"><textarea id="char-form-desc" rows="2" placeholder="äººè®¾"></textarea><div style="display:flex; gap:10px;"><button class="secondary" onclick="closeCharForm()">å–æ¶ˆ</button><button onclick="saveChar()">ä¿å­˜</button></div></div><div id="char-list"></div></div></div>
    
    <div id="app-yijing" class="app-window"><div id="yijing-home" style="height:100%; display:flex; flex-direction:column;"><div class="app-nav"><div class="nav-btn" onclick="closeApp('app-yijing')"><i class="fas fa-chevron-left"></i></div><div class="app-title">æ¢…èŠ±æ˜“æ•°</div><div class="nav-btn"></div></div><div class="app-content"><div class="card"><input type="text" id="yijing-q" placeholder="å¿ƒä¸­æ‰€å ä½•äº‹ï¼Ÿ (å¿…å¡«)"><div style="display:flex;gap:10px;"><input type="number" id="yijing-n1" placeholder="ä¸Šå¦æ•°"><input type="number" id="yijing-n2" placeholder="ä¸‹å¦æ•°"></div><button onclick="startDivination()">ç«‹å³æ’ç›˜</button></div><h4 style="margin:20px 0 10px;">å†å²è®°å½•</h4><div id="yijing-history" class="card" style="padding:0 16px;"></div></div></div><div id="yijing-detail" style="display:none; height:100%; flex-direction:column;"><div class="app-nav"><div class="nav-btn" onclick="closeDetail()"><i class="fas fa-chevron-left"></i> è¿”å›</div><div class="app-title">å¦è±¡è¯¦æƒ…</div><div class="nav-btn"></div></div><div class="app-content"><div class="card" style="text-align:center;"><h3 id="detail-q" style="margin:5px 0;"></h3><div id="detail-meta" style="font-size:12px;color:var(--text-sub);"></div></div><div id="detail-gua-area" class="card"></div><div class="card"><h4><i class="fas fa-robot"></i> AI è§£å¦</h4><select id="detail-role"></select><button onclick="callAI('interpret')" id="btn-interpret">è¯·å¤§å¸ˆæŒ‡ç‚¹</button><div id="ai-interpret-res" class="ai-collapsible"></div></div><div class="card"><h4><i class="fas fa-pen"></i> æˆ‘çš„ç¬”è®°</h4><textarea id="detail-note" rows="3" placeholder="å†™ä¸‹ä½ çš„æ–­è¯­..."></textarea><div style="display:flex; gap:10px;"><button class="secondary" onclick="saveNote()">ä¿å­˜ç¬”è®°</button><button id="btn-evaluate" class="outline" onclick="callAI('evaluate')">è®© AI è¯„ä»·</button></div><div id="ai-evaluate-res" class="ai-collapsible"></div></div></div></div></div>
    
    <!-- Diary: Added Date Grouping -->
    <div id="app-diary" class="app-window"><div class="app-nav"><div class="nav-btn" onclick="closeApp('app-diary')"><i class="fas fa-chevron-left"></i></div><div class="app-title">äº¤æ¢æ—¥è®°</div><div class="nav-btn"></div></div><div class="app-content"><div class="card"><textarea id="diary-input" rows="4" placeholder="å†™ä¸‹ä»Šå¤©çš„æ•…äº‹..."></textarea><div style="display:flex;gap:10px;"><select id="diary-role"></select><button id="btn-send-diary" onclick="sendDiary()" style="width:auto;"><i class="fas fa-paper-plane"></i></button></div><div id="diary-status" style="display:none;font-size:12px;color:var(--text-sub);margin-top:5px;"></div></div><div id="diary-feed"></div></div></div>
    
    <div id="app-instructions" class="app-window"><div class="app-nav"><div class="nav-btn" onclick="closeApp('app-instructions')"><i class="fas fa-chevron-left"></i> æ¡Œé¢</div><div class="app-title">æŒ‡ä»¤ä¸­å¿ƒ</div><div class="nav-btn"></div></div><div class="app-content"><div class="card"><h4>å…¨å±€æŒ‡ä»¤ (Master Prompt)</h4><p style="font-size:12px; color:var(--text-sub); margin:-10px 0 10px;">è¿™é‡Œçš„æŒ‡ä»¤å°†ä½œä¸ºæœ€é«˜ä¼˜å…ˆçº§ï¼Œå½±å“æ‰€æœ‰AIçš„è¡Œä¸ºã€‚</p><textarea id="master-prompt-input" rows="10" placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä¸ªå¯Œæœ‰æƒ…æ„Ÿçš„AIï¼Œæœ‰è‡ªå·±çš„å°è„¾æ°”..."></textarea><button onclick="saveMasterPrompt()">ä¿å­˜å…¨å±€æŒ‡ä»¤</button></div></div></div>
    
    <!-- App: ç§äººåŠ©ç† (Fixed Token Display) -->
    <div id="app-chat" class="app-window">
        <div class="app-nav">
            <div class="nav-btn" onclick="closeApp('app-chat')"><i class="fas fa-chevron-left"></i></div>
            <div class="app-title">ç§äººåŠ©ç†<div class="app-subtitle" id="chat-token-display">Token: 0</div></div>
            <div class="nav-btn" style="justify-content:flex-end; gap: 18px; cursor: default;">
                <i id="chat-mode-toggle" class="fas fa-stream" onclick="toggleChatMode()" style="cursor: pointer; font-size: 18px;"></i>
                <i class="fas fa-plus" onclick="createNewChatSession()" style="cursor: pointer; font-size: 18px;"></i>
            </div>
        </div>
        <div class="app-content" style="display:flex; flex-direction:column;">
            <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-shrink:0;">
                <select id="chat-role" style="flex:1; margin:0;"></select>
                <select id="chat-session-picker" style="flex:1; margin:0;" onchange="switchChatSession(this.value)"></select>
            </div>
            <div class="chat-feed" id="chat-feed"></div>
            <div class="chat-input-area"><textarea id="chat-input" rows="1" placeholder="é—®ç‚¹ä»€ä¹ˆ..." style="margin:0; flex:1;"></textarea><button id="btn-chat-send" onclick="sendChatMessage()" style="width:auto;"><i class="fas fa-arrow-up"></i></button></div>
        </div>
    </div>
</div>

<script>
    const trigramBits = { 1:[1,1,1], 2:[0,1,1], 3:[1,0,1], 4:[0,0,1], 5:[1,1,0], 6:[0,1,0], 7:[1,0,0], 8:[0,0,0], 0:[0,0,0] };
    const HEXAGRAM_DATA = { '1_1':"ä¹¾ä¸ºå¤©",'1_2':"å¤©åœ°å¦",'1_3':"å¤©æ³½å±¥",'1_4':"å¤©ç«åŒäºº",'1_5':"å¤©é£å§¤",'1_6':"å¤©æ°´è®¼",'1_7':"å¤©å±±é",'1_8':"å¤©é›·æ— å¦„", '2_1':"åœ°å¤©æ³°",'2_2':"å¤ä¸ºåœ°",'2_3':"åœ°æ³½ä¸´",'2_4':"åœ°ç«æ˜å¤·",'2_5':"åœ°é£å‡",'2_6':"åœ°æ°´å¸ˆ",'2_7':"åœ°å±±è°¦",'2_8':"åœ°é›·å¤", '3_1':"æ³½å¤©å¤¬",'3_2':"æ³½åœ°èƒ",'3_3':"å…‘ä¸ºå…‘",'3_4':"æ³½ç«é©",'3_5':"æ³½é£å¤§è¿‡",'3_6':"æ³½æ°´å›°",'3_7':"æ³½å±±å’¸",'3_8':"æ³½é›·éš", '4_1':"ç«å¤©å¤§æœ‰",'4_2':"ç«åœ°æ™‹",'4_3':"ç«æ³½ç½",'4_4':"ç¦»ä¸ºç«",'4_5':"ç«é£é¼",'4_6':"ç«æ°´æœªæµ",'4_7':"ç«å±±æ—…",'4_8':"ç«é›·å™¬å—‘", '5_1':"é£å¤©å°ç•œ",'5_2':"é£åœ°è§‚",'5_3':"é£æ³½ä¸­å­š",'5_4':"é£ç«å®¶äºº",'5_5':"å·½ä¸ºé£",'5_6':"é£æ°´æ¶£",'5_7':"é£å±±æ¸",'5_8':"é£é›·ç›Š", '6_1':"æ°´å¤©éœ€",'6_2':"æ°´åœ°æ¯”",'6_3':"æ°´æ³½èŠ‚",'6_4':"æ°´ç«æ—¢æµ",'6_5':"æ°´é£äº•",'6_6':"åä¸ºæ°´",'6_7':"æ°´å±±è¹‡",'6_8':"æ°´é›·å±¯", '7_1':"å±±å¤©å¤§ç•œ",'7_2':"å±±åœ°å‰¥",'7_3':"å±±æ³½æŸ",'7_4':"å±±ç«è´²",'7_5':"å±±é£è›Š",'7_6':"å±±æ°´è’™",'7_7':"è‰®ä¸ºå±±",'7_8':"å±±é›·é¢", '8_1':"é›·å¤©å¤§å£®",'8_2':"é›·åœ°è±«",'8_3':"é›·æ³½å½’å¦¹",'8_4':"é›·ç«ä¸°",'8_5':"é›·é£æ’",'8_6':"é›·æ°´è§£",'8_7':"é›·å±±å°è¿‡",'8_8':"éœ‡ä¸ºé›·" };
    let currentYijingId = null;

    // --- Init & System Functions ---
    updateClock(); setInterval(updateClock, 1000);
    initBattery();
    migrateChatData(); 
    window.onload = () => { loadTheme(); loadConfig(); renderCharList(); renderYijingHistory(); renderDiaryFeed(); renderCurrentChatHistory(); };

    function updateClock() { const t = new Date(); const timeStr = `${String(t.getHours()).padStart(2,'0')}:${String(t.getMinutes()).padStart(2,'0')}`; document.getElementById('clock-small').innerText = timeStr; document.getElementById('clock-big').innerText = timeStr; const days=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"]; document.getElementById('clock-date').innerText = `${t.getMonth()+1}æœˆ${t.getDate()}æ—¥, æ˜ŸæœŸ${days[t.getDay()]}`; }
    function initBattery() { const status = document.getElementById('battery-status'); if ('getBattery' in navigator) { navigator.getBattery().then(bat => { const update = () => { const icon = bat.charging ? 'fa-bolt' : bat.level > 0.8 ? 'fa-battery-full' : bat.level > 0.5 ? 'fa-battery-three-quarters' : bat.level > 0.2 ? 'fa-battery-quarter' : 'fa-battery-empty'; status.innerHTML = `<i class="fas ${icon}"></i> ${Math.round(bat.level*100)}%`; }; update(); bat.addEventListener('levelchange', update); bat.addEventListener('chargingchange', update); }); } }

    function openApp(id) { document.getElementById(id).classList.add('active'); if(id==='app-diary') updateDiaryRolePicker(); if(id==='app-chat') { updateChatRolePicker(); renderChatSessionPicker(); renderCurrentChatHistory(); setInitialChatModeIcon(); } if(id==='app-instructions') loadMasterPrompt(); }
    function closeApp(id) { document.getElementById(id).classList.remove('active'); }
    function applyTheme(themeName) { document.body.className = themeName; localStorage.setItem('os_theme', themeName); document.querySelectorAll('.theme-button').forEach(btn => btn.classList.toggle('active', btn.dataset.theme === themeName)); }
    function loadTheme() { const savedTheme = localStorage.getItem('os_theme') || 'theme-default'; applyTheme(savedTheme); }
    
    // --- Data Management & AI Formatting ---
    function exportData() { const allData = {}; for (let i = 0; i < localStorage.length; i++){ const key = localStorage.key(i); if (key.startsWith('os_')) { allData[key] = localStorage.getItem(key); } } const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const date = new Date().toISOString().slice(0, 10); a.download = `lingxi_os_backup_${date}.json`; a.click(); URL.revokeObjectURL(url); alert('å¤‡ä»½æ–‡ä»¶å·²å¼€å§‹ä¸‹è½½ï¼'); }
    function handleImport(files) { if (!files.length) return; const file = files[0]; const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); if (confirm('è¿™å°†è¦†ç›–æ‰€æœ‰å½“å‰æ•°æ®ï¼Œç¡®å®šè¦ä»æ–‡ä»¶æ¢å¤å—ï¼Ÿ')) { Object.keys(data).forEach(key => { if (key.startsWith('os_')) { localStorage.setItem(key, data[key]); } }); alert('æ•°æ®æ¢å¤æˆåŠŸï¼åº”ç”¨å³å°†åˆ·æ–°ã€‚'); location.reload(); } } catch (err) { alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–å·²æŸåã€‚'); } }; reader.readAsText(file); }
    function escapeHTML(str) { if (!str) return ''; return str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m]));}
    function formatAIResponse(text) { return escapeHTML(text).replace(/\n/g, '<br>'); }
    
    // --- Global & API Settings ---
    function saveMasterPrompt() { localStorage.setItem('os_master_prompt', document.getElementById('master-prompt-input').value); alert('å…¨å±€æŒ‡ä»¤å·²ä¿å­˜'); }
    function loadMasterPrompt() { document.getElementById('master-prompt-input').value = localStorage.getItem('os_master_prompt') || ''; }
    async function fetchModels() { const url = (document.getElementById('cfg-url').value || "https://api.openai.com/v1").replace(/\/$/,""); const key = document.getElementById('cfg-key').value; const btn = document.getElementById('btn-fetch'); if(!key) return alert('è¯·è¾“å…¥ API Key'); btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ‹‰å–ä¸­...'; try { const res = await fetch(url+'/models', {headers:{'Authorization':`Bearer ${key}`}}); const data = await res.json(); const models = data.data || data; if (!Array.isArray(models)) { const errorMsg = data.error ? data.error.message : JSON.stringify(data); throw new Error(`APIæœªè¿”å›æœ‰æ•ˆçš„æ¨¡å‹åˆ—è¡¨ã€‚æœåŠ¡å™¨å“åº”: ${errorMsg}`); } const sel = document.getElementById('cfg-model'); sel.innerHTML = ''; models.forEach(m => sel.innerHTML += `<option value="${m.id}">${m.id}</option>`); alert(`æˆåŠŸè·å– ${models.length} ä¸ªæ¨¡å‹ï¼`); } catch(e) { alert('æ‹‰å–å¤±è´¥: ' + e.message); } finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-sync"></i> æ‹‰å–æ¨¡å‹åˆ—è¡¨'; } }
    function saveConfig() { localStorage.setItem('os_url', document.getElementById('cfg-url').value); localStorage.setItem('os_key', document.getElementById('cfg-key').value); localStorage.setItem('os_model', document.getElementById('cfg-model').value); alert('API é…ç½®å·²ä¿å­˜'); }
    function loadConfig() { document.getElementById('cfg-url').value = localStorage.getItem('os_url') || ''; document.getElementById('cfg-key').value = localStorage.getItem('os_key') || ''; const savedModel = localStorage.getItem('os_model'); if(savedModel) document.getElementById('cfg-model').innerHTML = `<option>${savedModel}</option>`; }
    
    // --- Character App ---
    function openCharForm(char = null) { const modal = document.getElementById('char-form-modal'); const idInput = document.getElementById('char-form-id'); const nameInput = document.getElementById('char-form-name'); const descInput = document.getElementById('char-form-desc'); const title = document.getElementById('char-form-title'); if (char) { title.innerText = 'ç¼–è¾‘è§’è‰²'; idInput.value = char.id; nameInput.value = char.name; descInput.value = char.desc; } else { title.innerText = 'æ–°å»ºè§’è‰²'; idInput.value = ''; nameInput.value = ''; descInput.value = ''; } modal.style.display = 'block'; }
    function closeCharForm() { document.getElementById('char-form-modal').style.display = 'none'; }
    function saveChar() { const id = document.getElementById('char-form-id').value; const name = document.getElementById('char-form-name').value.trim(); if (!name) return alert('è§’è‰²åä¸èƒ½ä¸ºç©º'); const desc = document.getElementById('char-form-desc').value.trim(); let roles = JSON.parse(localStorage.getItem('os_chars') || '[]'); if (id) { roles = roles.map(role => role.id == id ? { ...role, name, desc } : role ); } else { roles.push({ id: Date.now(), name, desc }); } localStorage.setItem('os_chars', JSON.stringify(roles)); renderCharList(); closeCharForm(); }
    function renderCharList() { const div = document.getElementById('char-list'); if (!div) return; div.innerHTML = ''; JSON.parse(localStorage.getItem('os_chars')||'[]').forEach(r => { div.innerHTML += `<div class="card" style="display:flex; justify-content:space-between; align-items:center;"><div><b>${r.name}</b><br><small>${r.desc}</small></div><i class="fas fa-edit" style="cursor:pointer; color:var(--accent-color);" onclick='editChar(${r.id})'></i></div>`; }); }
    function editChar(id) { const roles = JSON.parse(localStorage.getItem('os_chars') || '[]'); const char = roles.find(r => r.id === id); if (char) openCharForm(char); }

    // --- I-Ching Divination App (Fixed Visibility) ---
    function startDivination() { const q = document.getElementById('yijing-q').value.trim(); if(!q) return alert('è¯·å¡«å†™æ‰€å ä½•äº‹'); const n1 = parseInt(document.getElementById('yijing-n1').value), n2 = parseInt(document.getElementById('yijing-n2').value); if(!n1||!n2) return alert('è¯·å¡«å†™æ•°å­—'); const up = n1%8||8, low = n2%8||8, dong = (n1+n2)%6||6; const rec = {id:Date.now(), time:new Date().toLocaleString(), q, n1, n2, up, low, dong, note:"", aiInterpret:"", aiEvaluate:""}; const list = JSON.parse(localStorage.getItem('os_yijing')||'[]'); list.unshift(rec); localStorage.setItem('os_yijing', JSON.stringify(list)); renderYijingHistory(); openDetail(rec.id); }
    
    function renderGuaResult(content, type) {
        if (!content) return '';
        return `
            <button class="toggle-btn" onclick="toggleCollapsible(this)">
                <span>${type === 'interpret' ? 'è§£å¦åˆ†æ' : 'AI è¯„ä»·'}</span>
                <i class="fas fa-chevron-down"></i>
            </button>
            <div class="content expanded">${formatAIResponse(content)}</div>
        `;
    }

    function toggleCollapsible(btn) {
        const content = btn.nextElementSibling;
        const icon = btn.querySelector('.fa-chevron-down');
        content.classList.toggle('expanded');
        if (content.classList.contains('expanded')) {
            btn.style.opacity = "1";
            if(icon) icon.style.transform = "rotate(0deg)";
        } else {
            btn.style.opacity = "0.7";
            if(icon) icon.style.transform = "rotate(-90deg)";
        }
    }

    function openDetail(id) { 
        currentYijingId = id; 
        const rec = JSON.parse(localStorage.getItem('os_yijing')).find(r => r.id===id); 
        document.getElementById('yijing-detail').style.display = 'flex'; 
        document.getElementById('yijing-home').style.display = 'none'; 
        document.getElementById('detail-q').innerText = rec.q; 
        document.getElementById('detail-meta').innerText = `æ•°: ${rec.n1},${rec.n2} | åŠ¨: ${rec.dong}`; 
        const sel = document.getElementById('detail-role'); sel.innerHTML = '<option value="">é»˜è®¤AI</option>'; JSON.parse(localStorage.getItem('os_chars')||'[]').forEach(r => sel.innerHTML += `<option value='${JSON.stringify(r)}'>${r.name}</option>`); 
        document.getElementById('detail-note').value = rec.note || ''; 
        document.getElementById('ai-interpret-res').innerHTML = renderGuaResult(rec.aiInterpret, 'interpret');
        document.getElementById('ai-evaluate-res').innerHTML = renderGuaResult(rec.aiEvaluate, 'evaluate');
        drawGua(rec.up, rec.low, rec.dong); 
    }

    function closeDetail() { document.getElementById('yijing-detail').style.display='none'; document.getElementById('yijing-home').style.display='block'; }
    function drawGua(upVal, lowVal, dongIdx) { const benFull = [...trigramBits[upVal], ...trigramBits[lowVal]]; const huUpBits = [benFull[1], benFull[2], benFull[3]], huLowBits = [benFull[2], benFull[3], benFull[4]]; const huUpVal = findTrigramVal(huUpBits), huLowVal = findTrigramVal(huLowBits); const changeBitIdx = 6-dongIdx; const bianFull = [...benFull]; bianFull[changeBitIdx] = 1 - bianFull[changeBitIdx]; const bianUpVal = findTrigramVal(bianFull.slice(0,3)), bianLowVal = findTrigramVal(bianFull.slice(3,6)); document.getElementById('detail-gua-area').innerHTML = `<div class="gua-visual-row"><div class="gua-col"><div class="gua-title">æœ¬å¦</div><div class="gua-lines-box">${renderLinesHtml(benFull, dongIdx)}</div><div class="gua-name">${HEXAGRAM_DATA[`${upVal}_${lowVal}`] || 'æœªçŸ¥'}</div></div><div class="gua-col"><div class="gua-title">äº’å¦</div><div class="gua-lines-box">${renderLinesHtml([...huUpBits,...huLowBits], -1)}</div><div class="gua-name">${HEXAGRAM_DATA[`${huUpVal}_${huLowVal}`] || 'æœªçŸ¥'}</div></div><div class="gua-col"><div class="gua-title">å˜å¦</div><div class="gua-lines-box">${renderLinesHtml(bianFull, dongIdx)}</div><div class="gua-name" style="color:#ff3b30">${HEXAGRAM_DATA[`${bianUpVal}_${bianLowVal}`] || 'æœªçŸ¥'}</div></div></div>`; }
    function renderLinesHtml(bits, moveLine) { let html = ''; bits.forEach((bit, i) => { const lineNum = 6 - i; const isMoving = (lineNum === moveLine); const type = bit === 1 ? 'yang' : 'yin'; const moveClass = isMoving ? 'moving' : ''; const content = bit === 1 ? '' : '<span></span><span></span>'; html += `<div class="line ${type} ${moveClass}">${content}</div>`; }); return html; }
    function findTrigramVal(arr) { const str = arr.join(''); for(let k in trigramBits) { if(trigramBits[k].join('') === str && k!=='0') return parseInt(k); } return 8; }
    function renderYijingHistory() { const div = document.getElementById('yijing-history'); div.innerHTML = ''; const data = JSON.parse(localStorage.getItem('os_yijing')||'[]'); if(data.length===0) div.innerHTML = '<div style="text-align:center;color:var(--text-sub);padding:10px;">æš‚æ— è®°å½•</div>'; data.forEach(item => div.innerHTML += `<div onclick="openDetail(${item.id})" style="padding:12px 0; border-bottom:1px solid var(--border-color);cursor:pointer;">${item.q} <small style="float:right;"><i class="fas fa-chevron-right"></i></small></div>`); }
    async function callAI(mode) { 
        const key = localStorage.getItem('os_key'); if(!key) return alert('è¯·é…ç½®Key'); 
        const btn = mode==='interpret' ? document.getElementById('btn-interpret') : document.getElementById('btn-evaluate'); 
        const targetDiv = mode==='interpret' ? document.getElementById('ai-interpret-res') : document.getElementById('ai-evaluate-res'); 
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ€è€ƒä¸­...'; 
        targetDiv.style.display = 'block'; targetDiv.innerHTML = "æ­£åœ¨è¿æ¥AIï¼Œè¯·ç¨å€™..."; 
        
        try { 
            const list = JSON.parse(localStorage.getItem('os_yijing')); const rec = list.find(r=>r.id===currentYijingId); 
            const url = (localStorage.getItem('os_url') || "https://api.openai.com/v1").replace(/\/$/,''); 
            const model = localStorage.getItem('os_model') || "gpt-3.5-turbo"; 
            const benFull=[...trigramBits[rec.up],...trigramBits[rec.low]]; 
            const huUpBits=[benFull[1],benFull[2],benFull[3]],huLowBits=[benFull[2],benFull[3],benFull[4]]; const huUpVal=findTrigramVal(huUpBits),huLowVal=findTrigramVal(huLowBits); 
            const changeBitIdx=6-rec.dong; const bianFull=[...benFull];bianFull[changeBitIdx]=1-bianFull[changeBitIdx]; const bianUpVal=findTrigramVal(bianFull.slice(0,3)),bianLowVal=findTrigramVal(bianFull.slice(3,6)); 
            const benName=HEXAGRAM_DATA[`${rec.up}_${rec.low}`],huName=HEXAGRAM_DATA[`${huUpVal}_${huLowVal}`],bianName=HEXAGRAM_DATA[`${bianUpVal}_${bianLowVal}`]; 
            let userPrompt; const promptHeader=`ã€æ¢…èŠ±æ˜“æ•°æ’ç›˜ç»“æœã€‘\næ‰€å ä¹‹äº‹ï¼š${rec.q}\næœ¬å¦ï¼š${benName}(ç¬¬ ${rec.dong} çˆ»åŠ¨)\näº’å¦ï¼š${huName}\nå˜å¦ï¼š${bianName}\n\n`; 
            if(mode==='interpret'){ userPrompt=promptHeader+"è¯·æ ¹æ®ä»¥ä¸Šå®Œæ•´çš„å¦è±¡ä¿¡æ¯ä¸ºæˆ‘è¯¦ç»†è§£è¯»ã€‚"; }else{ const note=document.getElementById('detail-note').value; if(!note)throw new Error("è¯·å…ˆå¡«å†™æ‚¨çš„ç¬”è®°ã€‚"); userPrompt=promptHeader+`ã€æˆ‘çš„ç¬”è®°ã€‘\n"${note}"\n\nè¯·ä½œä¸ºè€å¸ˆï¼ŒåŸºäºå®Œæ•´çš„å¦è±¡ä¿¡æ¯ï¼Œç‚¹è¯„æˆ‘çš„ç¬”è®°æ˜¯å¦å‡†ç¡®ï¼Ÿ`; } 
            
            const masterPrompt = localStorage.getItem('os_master_prompt') || ''; 
            let rolePrompt = "ä½ æ˜¯ä¸€ä½ç²¾é€šæ¢…èŠ±æ˜“æ•°çš„å›½å­¦å¤§å¸ˆã€‚"; 
            const roleJSON=document.getElementById('detail-role').value; 
            if(roleJSON){ const r=JSON.parse(roleJSON); rolePrompt=`è¯·ä¸¥æ ¼æ‰®æ¼”ä»¥ä¸‹è§’è‰²ï¼š\nã€è§’è‰²åã€‘: ${r.name}\nã€è§’è‰²è®¾å®šã€‘: ${r.desc}\nç”¨è¿™ä¸ªè§’è‰²çš„å£å»å’ŒçŸ¥è¯†èƒŒæ™¯æ¥å›ç­”ã€‚`; } 
            const finalSystemPrompt = masterPrompt ? `${masterPrompt}\n\n---\n\n${rolePrompt}` : rolePrompt; 
            
            const res=await fetch(url+'/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${key}`},body:JSON.stringify({model,messages:[{role:"system",content:finalSystemPrompt},{role:"user",content:userPrompt}]})}); 
            if(!res.ok)throw new Error(`API è¯·æ±‚å¤±è´¥: ${res.status}`); 
            const data=await res.json(); 
            if(data.error)throw new Error(data.error.message); 
            const reply=data.choices[0].message.content; 
            targetDiv.innerHTML = renderGuaResult(reply, mode);
            const idx=list.findIndex(r=>r.id===currentYijingId); if(mode==='interpret')list[idx].aiInterpret=reply; else list[idx].aiEvaluate=reply; localStorage.setItem('os_yijing',JSON.stringify(list));
        } catch(e){ targetDiv.innerText="è¯·æ±‚å‡ºé”™ï¼š"+e.message; } finally { btn.disabled=false; btn.innerHTML=mode==='interpret'?'è¯·å¤§å¸ˆæŒ‡ç‚¹':'è®© AI è¯„ä»·'; }
    }
    function saveNote() { const list=JSON.parse(localStorage.getItem('os_yijing')); const idx=list.findIndex(r=>r.id===currentYijingId); list[idx].note = document.getElementById('detail-note').value; localStorage.setItem('os_yijing', JSON.stringify(list)); alert('ç¬”è®°å·²ä¿å­˜'); }
    
    // --- Diary App (Fixed: Date Grouping) ---
    function updateDiaryRolePicker() { const sel = document.getElementById('diary-role'); sel.innerHTML = '<option value="">é»˜è®¤AI</option>'; JSON.parse(localStorage.getItem('os_chars')||'[]').forEach(r => sel.innerHTML += `<option value='${JSON.stringify(r)}'>${r.name}</option>`); }
    function renderDiaryFeed() { 
        const div = document.getElementById('diary-feed'); div.innerHTML = ''; 
        const rawData = JSON.parse(localStorage.getItem('os_diary')||'[]');
        const grouped = {};
        rawData.forEach(d => { const dateKey = d.date || 'å¾€æ—¥è®°å¿†'; if (!grouped[dateKey]) grouped[dateKey] = []; grouped[dateKey].push(d); });
        Object.keys(grouped).sort().reverse().forEach(date => {
            const isToday = date === new Date().toISOString().split('T')[0];
            const displayDate = isToday ? `${date} (ä»Šå¤©)` : date;
            const header = document.createElement('div'); header.className = 'diary-date-header';
            header.innerHTML = `<span><i class="fas fa-calendar-day"></i> ${displayDate}</span> <i class="fas fa-chevron-down"></i>`;
            header.onclick = function() { const groupDiv = this.nextElementSibling; const icon = this.querySelector('.fa-chevron-down'); if (groupDiv.classList.contains('collapsed')) { groupDiv.classList.remove('collapsed'); icon.style.transform = 'rotate(0deg)'; } else { groupDiv.classList.add('collapsed'); icon.style.transform = 'rotate(-90deg)'; } };
            div.appendChild(header);
            const groupDiv = document.createElement('div'); groupDiv.className = 'diary-group'; 
            grouped[date].forEach(d => { groupDiv.innerHTML += `<div class="card" style="border-left:3px solid ${d.type==='user'? '#555' : 'var(--accent-color)'}"><b>${d.name}</b><br><div style="margin-top:5px;">${formatAIResponse(d.text)}</div></div>`; });
            div.appendChild(groupDiv);
        });
    }
    async function sendDiary() { 
        const text = document.getElementById('diary-input').value; if(!text) return; 
        const key = localStorage.getItem('os_key'); if(!key) return alert('è¯·é…ç½®Key'); 
        const btn = document.getElementById('btn-send-diary'); const status = document.getElementById('diary-status'); 
        btn.disabled = true; status.style.display='block'; status.innerText = 'å‘é€ä¸­...'; 
        let rolePrompt = "ä½ æ˜¯ä¸€ä½æ¸©æš–çš„æ—¥è®°ç¬”å‹ã€‚", aiName = "AI"; 
        const roleJSON = document.getElementById('diary-role').value; if(roleJSON) { const r = JSON.parse(roleJSON); rolePrompt = `è¯·ä¸¥æ ¼æ‰®æ¼”ä»¥ä¸‹è§’è‰²ï¼š\nã€è§’è‰²åã€‘: ${r.name}\nã€è§’è‰²è®¾å®šã€‘: ${r.desc}\nç”¨è¿™ä¸ªè§’è‰²çš„å£å»å›å¤æ—¥è®°ã€‚`; aiName = r.name; } 
        const todayStr = new Date().toISOString().split('T')[0];
        saveDiaryEntry('user', text, 'æˆ‘', todayStr); 
        try { 
            const masterPrompt = localStorage.getItem('os_master_prompt') || ''; const finalSystemPrompt = masterPrompt ? `${masterPrompt}\n\n---\n\n${rolePrompt}` : rolePrompt; 
            const url = (localStorage.getItem('os_url') || "https://api.openai.com/v1").replace(/\/$/,''); const model = localStorage.getItem('os_model') || "gpt-3.5-turbo"; status.innerText = `æ­£åœ¨è¿æ¥ ${model}...`; 
            const res = await fetch(url+'/chat/completions', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` }, body: JSON.stringify({ model, messages: [{role:"system",content:finalSystemPrompt},{role:"user",content:text}] }) }); 
            if(!res.ok) throw new Error(`API Error: ${res.status}`); 
            const data = await res.json(); if(data.error) throw new Error(data.error.message); 
            saveDiaryEntry('ai', data.choices[0].message.content, aiName, todayStr); document.getElementById('diary-input').value = ''; 
        } catch(e) { alert('AIå›å¤å¤±è´¥: ' + e.message); } finally { btn.disabled = false; status.style.display='none'; } 
    }
    function saveDiaryEntry(type, text, name, date) { const list = JSON.parse(localStorage.getItem('os_diary')||'[]'); list.unshift({type, text, name, date}); localStorage.setItem('os_diary', JSON.stringify(list)); renderDiaryFeed(); }

    // --- Chat App (Final Version - Streaming & Friend Mode) ---
    function migrateChatData() { const oldChat = localStorage.getItem('os_chats'); const newChat = localStorage.getItem('os_chat_sessions'); if (oldChat && !newChat) { try { const oldMessages = JSON.parse(oldChat); if (Array.isArray(oldMessages) && oldMessages.length > 0) { const sessionId = Date.now(); const sessions = {}; sessions[sessionId] = oldMessages; localStorage.setItem('os_chat_sessions', JSON.stringify(sessions)); localStorage.setItem('os_current_chat_id', sessionId); } } catch(e) { console.error("Failed to migrate chat data", e); } localStorage.removeItem('os_chats'); } }
    function getAllChatSessions() { return JSON.parse(localStorage.getItem('os_chat_sessions') || '{}'); }
    function getCurrentChatId() { return localStorage.getItem('os_current_chat_id'); }
    function updateChatRolePicker() { const sel = document.getElementById('chat-role'); sel.innerHTML = '<option value="">é»˜è®¤AI</option>'; JSON.parse(localStorage.getItem('os_chars')||'[]').forEach(r => sel.innerHTML += `<option value='${JSON.stringify(r)}'>${r.name}</option>`); }
    function renderChatSessionPicker() { const picker = document.getElementById('chat-session-picker'); const sessions = getAllChatSessions(); const currentId = getCurrentChatId(); picker.innerHTML = ''; const sortedIds = Object.keys(sessions).sort((a,b) => b-a); sortedIds.forEach(id => { const firstUserMsg = sessions[id].find(m => m.type === 'user'); const sessionName = firstUserMsg ? firstUserMsg.text.substring(0, 12) + '...' : 'æ–°å¯¹è¯'; const date = new Date(parseInt(id)).toLocaleTimeString(); picker.innerHTML += `<option value="${id}" ${id == currentId ? 'selected' : ''}>${sessionName} (${date})</option>`; });}
    function createNewChatSession() { const sessions = getAllChatSessions(); const newId = Date.now(); sessions[newId] = []; localStorage.setItem('os_chat_sessions', JSON.stringify(sessions)); localStorage.setItem('os_current_chat_id', newId); renderCurrentChatHistory(); renderChatSessionPicker(); }
    function switchChatSession(sessionId) { localStorage.setItem('os_current_chat_id', sessionId); renderCurrentChatHistory(); document.getElementById('chat-token-display').innerText = `Token: 0`; }
    function renderCurrentChatHistory() { const feed = document.getElementById('chat-feed'); feed.innerHTML = ''; let currentId = getCurrentChatId(); const sessions = getAllChatSessions(); if (!currentId || !sessions[currentId]) { createNewChatSession(); currentId = getCurrentChatId(); } const history = sessions[currentId] || []; history.forEach(msg => { const div = document.createElement('div'); div.className = `chat-bubble ${msg.type}`; div.innerHTML = formatAIResponse(msg.text); feed.appendChild(div); }); feed.scrollTop = feed.scrollHeight; }
    
    // ----------------------------------------------------------------------
    // ğŸš€ æ ¸å¿ƒä¿®æ”¹ï¼šæµå¼è¾“å‡º + æœ‹å‹é—²èŠæ¨¡å¼
    // ----------------------------------------------------------------------
    async function sendChatMessage() { 
        const input = document.getElementById('chat-input'); 
        const text = input.value.trim(); if(!text) return; 
        
        saveChatMessage('user', text); // ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
        input.value = ''; 
        renderCurrentChatHistory(); // æ¸²æŸ“ç•Œé¢
        
        const key = localStorage.getItem('os_key'); if(!key) return alert('è¯·é…ç½®Key'); 
        const btn = document.getElementById('btn-chat-send'); 
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-stop"></i>'; // æŒ‰é’®å˜åœæ­¢å›¾æ ‡ï¼ˆæš‚æœªå®ç°åœæ­¢åŠŸèƒ½ï¼Œä»…è§†è§‰ï¼‰
        
        // å‡†å¤‡æ°”æ³¡ç”¨äºæµå¼æ˜¾ç¤º
        const feed = document.getElementById('chat-feed');
        let currentBubble = document.createElement('div');
        currentBubble.className = 'chat-bubble ai';
        feed.appendChild(currentBubble);
        feed.scrollTop = feed.scrollHeight;
        
        let fullReply = "";
        
        try { 
            let rolePrompt = "ä½ æ˜¯ä¸€ä¸ªé€šç”¨AIåŠ©ç†ã€‚"; 
            const roleJSON = document.getElementById('chat-role').value; 
            if(roleJSON) { const r = JSON.parse(roleJSON); rolePrompt = `è¯·ä¸¥æ ¼æ‰®æ¼”ä»¥ä¸‹è§’è‰²ï¼š\nã€è§’è‰²åã€‘: ${r.name}\nã€è§’è‰²è®¾å®šã€‘: ${r.desc}\nç”¨è¿™ä¸ªè§’è‰²çš„å£å»å¯¹è¯ã€‚`; } 
            
            // --- æœ‹å‹æ¨¡å¼é€»è¾‘ ---
            const chatMode = localStorage.getItem('os_chat_mode') || 'casual'; // é»˜è®¤ä¸º casual
            let systemInstruction = "";
            
            if (chatMode === 'casual') {
                // å¼ºåˆ¶æ³¨å…¥â€œè®²äººè¯â€çš„æŒ‡ä»¤
                systemInstruction = "\n\n[System Instruction: IMPERATIVE]\n1. You are chatting on a messenger app. REPLY AS A CLOSE FRIEND.\n2. Keep sentences SHORT and CASUAL. Do NOT write long paragraphs.\n3. STRICTLY FORBIDDEN: Markdown headers (###), Bold (**), Bullet points.\n4. Use plain text only. Split distinct thoughts into separate paragraphs.\n5. Tone: Relaxed, colloquial, human-like.";
            }
            
            const masterPrompt = localStorage.getItem('os_master_prompt') || ''; 
            const finalSystemPrompt = (masterPrompt ? `${masterPrompt}\n\n---\n\n${rolePrompt}` : rolePrompt) + systemInstruction; 
            
            const currentId = getCurrentChatId(); const sessions = getAllChatSessions(); const history = sessions[currentId] || []; 
            const messages = history.map(m => ({ role: m.type === 'user' ? 'user' : 'assistant', content: m.text })); 
            messages.unshift({role: "system", content: finalSystemPrompt}); 
            
            const url = (localStorage.getItem('os_url') || "https://api.openai.com/v1").replace(/\/$/,''); 
            const model = localStorage.getItem('os_model') || "gpt-3.5-turbo"; 
            
            // --- å¼€å¯ stream: true ---
            const res = await fetch(url+'/chat/completions', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` }, 
                body: JSON.stringify({ model, messages, stream: true }) 
            }); 

            if(!res.ok) throw new Error(`API Error: ${res.status}`); 
            
            // --- å¤„ç†æµå¼å“åº” ---
            const reader = res.body.getReader();
            const decoder = new TextDecoder("utf-8");
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const jsonStr = line.slice(6);
                        if (jsonStr === '[DONE]') break;
                        try {
                            const json = JSON.parse(jsonStr);
                            const content = json.choices[0].delta.content || "";
                            
                            // å®æ—¶æ˜¾ç¤º
                            fullReply += content;
                            
                            // æœ‹å‹æ¨¡å¼ç‰¹æŠ€ï¼šå¦‚æœæ£€æµ‹åˆ°æ˜æ˜¾çš„æ¢è¡Œï¼ˆä»£è¡¨æ–°çš„ä¸€å¥è¯ï¼‰ï¼Œå°è¯•åˆ‡åˆ†æ°”æ³¡
                            // è¿™æ ·çœ‹èµ·æ¥å°±åƒå¯¹æ–¹è¿å‘äº†ä¸¤æ¡æ¶ˆæ¯
                            if (chatMode === 'casual' && (content.includes('\n\n') || (fullReply.endsWith('\n') && content === '\n'))) {
                                // ç»“æŸå½“å‰æ°”æ³¡ï¼Œåˆ›å»ºæ–°æ°”æ³¡
                                currentBubble.innerHTML = formatAIResponse(fullReply.trim());
                                saveChatMessage('ai', fullReply.trim()); // ä¿å­˜ä¸Šä¸€æ®µ
                                
                                // é‡ç½®çŠ¶æ€å‡†å¤‡ä¸‹ä¸€æ®µ
                                fullReply = ""; 
                                currentBubble = document.createElement('div');
                                currentBubble.className = 'chat-bubble ai';
                                feed.appendChild(currentBubble);
                            } else {
                                // æ­£å¸¸è¿½åŠ æ–‡æœ¬
                                currentBubble.innerHTML = formatAIResponse(fullReply);
                            }
                            feed.scrollTop = feed.scrollHeight;
                            
                        } catch (e) { console.error("Stream parse error", e); }
                    }
                }
            }
            
            // æµç»“æŸï¼Œä¿å­˜æœ€åä¸€æ®µå†…å®¹
            if (fullReply.trim()) {
                saveChatMessage('ai', fullReply.trim());
            } else {
                // å¦‚æœæœ€åä¸€æ®µæ˜¯ç©ºçš„ï¼ˆå› ä¸ºåˆšæ‰è¢«åˆ‡åˆ†äº†ï¼‰ï¼Œç§»é™¤ç©ºæ°”æ³¡
                if(currentBubble.innerHTML === "") currentBubble.remove();
            }

        } catch (e) { 
            currentBubble.innerHTML = `è¿æ¥æ–­å¼€ï¼š${e.message}`;
            saveChatMessage('ai', `[ç³»ç»Ÿé”™è¯¯] ${e.message}`);
        } finally { 
            btn.disabled = false; btn.innerHTML = '<i class="fas fa-arrow-up"></i>'; 
        } 
    }
    
    function saveChatMessage(type, text) { const sessions = getAllChatSessions(); const currentId = getCurrentChatId(); if(!sessions[currentId]) sessions[currentId] = []; sessions[currentId].push({type, text}); localStorage.setItem('os_chat_sessions', JSON.stringify(sessions)); }
    
    // åˆ‡æ¢æ¨¡å¼ï¼šç°åœ¨æ˜¯åˆ‡æ¢â€œæœ‹å‹é—²èŠ(æµå¼)â€å’Œâ€œä¸“ä¸šåŠ©ç†(æ™®é€š)â€
    function toggleChatMode() { 
        const btn = document.getElementById('chat-mode-toggle'); 
        let currentMode = localStorage.getItem('os_chat_mode') || 'casual'; 
        const newMode = currentMode === 'casual' ? 'pro' : 'casual'; 
        localStorage.setItem('os_chat_mode', newMode); 
        setInitialChatModeIcon(); 
        alert(`èŠå¤©æ¨¡å¼å·²åˆ‡æ¢ä¸ºï¼š${newMode === 'casual' ? 'æœ‹å‹é—²èŠ (çŸ­å¥/æµå¼)' : 'ä¸“ä¸šåŠ©ç† (Markdown/é•¿æ–‡)'}`); 
    }
    
    function setInitialChatModeIcon() { 
        const btn = document.getElementById('chat-mode-toggle'); if (!btn) return; 
        const currentMode = localStorage.getItem('os_chat_mode') || 'casual'; 
        // ä½¿ç”¨é—ªç”µå›¾æ ‡ä»£è¡¨â€œå¿«/é—²èŠâ€ï¼Œä½¿ç”¨ä¹¦æœ¬ä»£è¡¨â€œä¸“ä¸š/æ…¢â€
        if (currentMode === 'casual') { 
            btn.className = 'fas fa-bolt'; // é—²èŠæ¨¡å¼å›¾æ ‡
            btn.style.color = 'var(--accent-color)';
        } else { 
            btn.className = 'fas fa-book'; // ä¸“ä¸šæ¨¡å¼å›¾æ ‡
            btn.style.color = 'var(--text-sub)';
        } 
    }
</script>
</body>
</html>